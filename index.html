<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f7f4; }
        .hero-section { background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80'); background-size: cover; background-position: center; }
        .tag { transition: all 0.2s ease-in-out; cursor: pointer; }
        .tag.active, .tag:hover { background-color: #16a34a; color: white; }
        .shop-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        .favorite-btn.favorited svg { fill: #ef4444; stroke: #ef4444; }
        .spinner { border-top-color: #10B981; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #shop-detail-modal { display: none; }
        #shop-detail-modal.flex { display: flex; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="spinner h-12 w-12 border-4 border-gray-200 rounded-full"></div>
        <p class="mt-4 text-gray-600" data-i18n="loading">載入中...</p>
    </div>
    <div id="toast" class="fixed top-0 left-1/2 -translate-x-1/2 -translate-y-full transition-transform duration-300 z-[9998] w-full max-w-sm">
        <div id="toast-content" class="flex items-center gap-4 p-4 mt-4 mx-2 rounded-lg shadow-lg">
            <div id="toast-icon"></div>
            <p id="toast-message" class="font-medium"></p>
        </div>
    </div>
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <a href="#" class="text-2xl font-bold text-gray-800" data-i18n="appName">永續商店地圖</a>
            </div>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#map" class="text-gray-700 hover:text-green-600 transition" data-i18n="map">地圖</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600 transition" data-i18n="shopList">商店列表</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600 transition" data-i18n="newsletter">訂閱電子報</a>
                <a href="#report-issue" class="text-gray-700 hover:text-green-600 transition" data-i18n="reportIssueNavLink">問題回報</a>
                <a href="#policies" class="text-gray-700 hover:text-green-600 transition" data-i18n="policiesNavLink">政策聲明</a>
                 <select id="language-select" class="bg-gray-100 text-sm px-3 py-1 rounded-full hover:bg-gray-200 transition cursor-pointer border">
                    <option value="zh-TW">繁體中文</option><option value="en">English</option><option value="fr">Français</option><option value="de">Deutsch</option><option value="es">Español</option><option value="ja">日本語</option><option value="la">Latin</option>
                </select>
            </div>
            <div class="md:hidden flex items-center"><button id="menu-toggle" class="text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button></div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white"></div>
    </nav>
    <div id="announcement-bar" class="hidden bg-yellow-100 border-b-2 border-yellow-200 text-yellow-800 p-3 text-center text-sm"><p id="announcement-text" class="font-medium"></p></div>
    <main>
        <section class="hero-section py-20 md:py-32 text-white">
            <div class="container mx-auto px-4 text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">探索台灣永續商店</h1>
                <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力</p>
            </div>
        </section>
        <section class="py-12 bg-white relative -mt-16 z-20 mx-4 md:mx-auto max-w-5xl rounded-xl shadow-lg">
            <div class="container mx-auto px-6">
                <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">搜尋永續商店</h2>
                <div class="flex mb-4"><input type="text" id="search-input" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500" data-i18n="searchPlaceholder"><button id="search-button" class="bg-green-600 text-white px-6 py-3 rounded-r-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></button></div>
                <div>
                    <h3 class="font-medium mb-3" data-i18n="filterCategoryTitle">依類別篩選</h3>
                    <div class="flex flex-wrap gap-2" id="filter-buttons-container">
                        <button class="tag bg-green-600 text-white px-3 py-1 rounded-full text-sm" data-category="" data-i18n="filterAll"></button>
                        <button class="tag bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm" data-category="favorites" data-i18n="filterFavorites"></button>
                    </div>
                </div>
            </div>
        </section>
        <section id="map" class="py-12 bg-green-50">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">永續商店地圖</h2>
                <div id="sustainability-map" class="h-96 md:h-[500px] w-full rounded-xl shadow-lg bg-gray-200"></div>
            </div>
        </section>
        <section id="shops" class="py-12 bg-white">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">永續商店列表</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="shop-cards-container"></div>
                <div class="text-center mt-8"><button id="load-more-button" class="bg-green-600 text-white px-8 py-3 rounded-lg font-medium hidden" data-i18n="loadMoreBtn"></button></div>
            </div>
        </section>
        <section id="newsletter" class="py-12 bg-green-700 text-white">
            <form id="newsletter-form" class="container mx-auto px-4 max-w-2xl text-center">
                <h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">訂閱永續生活電子報</h2>
                <p class="mb-6" data-i18n="newsletterSubtitle">獲取最新的永續商店資訊、環保生活技巧和特別優惠</p>
                <div class="flex flex-col md:flex-row gap-2"><input type="email" name="email" class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none" data-i18n="newsletterPlaceholder" required><button type="submit" class="bg-white text-green-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="subscribeBtn"></button></div>
            </form>
        </section>
        <section id="report-issue" class="py-12 bg-yellow-50">
            <div class="container mx-auto px-4 max-w-2xl bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-3xl font-bold text-center mb-6" data-i18n="reportIssueTitle">問題回報</h2>
                <form id="issue-form" class="space-y-4">
                    <div><label class="block text-sm font-medium" data-i18n="reportIssueEmailLabel">您的電子郵件</label><input type="email" name="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" data-i18n="reportIssueEmailPlaceholder" required></div>
                    <div><label class="block text-sm font-medium" data-i18n="reportIssueTypeLabel">問題類型</label><select name="type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required><option value="info_error" data-i18n="reportTypeInfoError">店家資訊錯誤</option><option value="bug" data-i18n="reportTypeBug">網站功能問題</option><option value="suggestion" data-i18n="reportTypeSuggestion">功能建議</option><option value="other" data-i18n="reportTypeOther">其他</option></select></div>
                    <div><label class="block text-sm font-medium" data-i18n="reportIssueLabel">請描述您遇到的問題</label><textarea name="message" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" data-i18n="reportIssuePlaceholder" required></textarea></div>
                    <div class="text-center pt-2"><button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium" data-i18n="reportIssueSubmitBtn"></button></div>
                </form>
            </div>
        </section>
        <section id="policies" class="py-12 bg-gray-100">
            <div id="policy-content" class="container mx-auto px-4 max-w-4xl text-sm text-gray-600 space-y-6"></div>
        </section>
    </main>
    <footer class="bg-gray-800 text-white py-10"></footer>
    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[1000] items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-6xl w-full mx-auto modal-content">
            <div id="shop-detail-content" class="relative"></div>
        </div>
    </div>
    
<script>
// [FINAL & COMPLETE SCRIPT - v19.0 Stability Fix]
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://script.google.com/macros/s/AKfycbwgQoUrk2fspuJTc0aPJHzJe_xHhIB9s50qcJQj5xLC4wujhhqW2TBG2Q07hIjcHEMqEg/exec';
    const LANGUAGES = ['zh-TW', 'en', 'fr', 'de', 'es', 'ja', 'la'];
    
    // Global state
    let allShops = [], allTags = [], policies = {}, announcements = {};
    let currentLang = localStorage.getItem('lang') || 'zh-TW';
    let favoriteShops = JSON.parse(localStorage.getItem('favoriteShops')) || [];
    let mapInstance;
    let markersGroup = L.featureGroup();
    let currentFilter = { tagId: '', query: '' };
    const shopsPerPage = 6;
    let renderedShopCount = 0;

    const ui = {
        loadingOverlay: document.getElementById('loading-overlay'),
        toast: document.getElementById('toast'),
        toastContent: document.getElementById('toast-content'),
        toastIcon: document.getElementById('toast-icon'),
        toastMessage: document.getElementById('toast-message'),
        languageSelect: document.getElementById('language-select'),
        mobileMenu: document.getElementById('mobile-menu'),
        announcementBar: document.getElementById('announcement-bar'),
        announcementText: document.getElementById('announcement-text'),
        searchInput: document.getElementById('search-input'),
        searchButton: document.getElementById('search-button'),
        filterButtonsContainer: document.getElementById('filter-buttons-container'),
        sustainabilityMap: document.getElementById('sustainability-map'),
        shopCardsContainer: document.getElementById('shop-cards-container'),
        loadMoreButton: document.getElementById('load-more-button'),
        newsletterForm: document.getElementById('newsletter-form'),
        issueForm: document.getElementById('issue-form'),
        policyContent: document.getElementById('policy-content'),
        footer: document.querySelector('footer'),
        shopDetailModal: document.getElementById('shop-detail-modal'),
        shopDetailContent: document.getElementById('shop-detail-content'),
        menuToggle: document.getElementById('menu-toggle')
    };
    
    const staticTranslations = {"zh-TW":{"pageTitle":"永續商店地圖","appName":"永續商店地圖","map":"地圖","shopList":"商店列表","newsletter":"訂閱電子報","reportIssueNavLink":"問題回報","policiesNavLink":"政策聲明","heroTitle":"探索台灣永續商店","heroSubtitle":"找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力","searchTitle":"搜尋永續商店","searchPlaceholder":"輸入商店名稱、地址或標籤...","filterCategoryTitle":"依類別篩選","filterAll":"全部","filterFavorites":"❤️ 我的收藏","mapSectionTitle":"永續商店地圖","shopListSectionTitle":"永續商店列表","loadMoreBtn":"載入更多","newsletterTitle":"訂閱永續生活電子報","newsletterSubtitle":"獲取最新的永續商店資訊、環保生活技巧和特別優惠","newsletterPlaceholder":"您的電子郵件","subscribeBtn":"訂閱","reportIssueTitle":"問題回報","reportIssueEmailLabel":"您的電子郵件","reportIssueEmailPlaceholder":"請輸入您的 Email","reportIssueTypeLabel":"問題類型","reportTypeInfoError":"店家資訊錯誤","reportTypeBug":"網站功能問題","reportTypeSuggestion":"功能建議","reportTypeOther":"其他","reportIssueLabel":"請描述您遇到的問題","reportIssuePlaceholder":"請詳細說明...","reportIssueSubmitBtn":"送出回報","privacyPolicyTitle":"隱私權政策","disclaimerTitle":"免責聲明","loading":"載入中..."},"en":{"pageTitle":"Sustainable Store Map","appName":"Sustainable Store Map","map":"Map","shopList":"Shop List","newsletter":"Newsletter","reportIssueNavLink":"Report Issue","policiesNavLink":"Policies","heroTitle":"Explore Taiwan's Sustainable Stores","heroSubtitle":"Find stores that support environmental protection, fair trade, and sustainable development.","searchTitle":"Search Sustainable Stores","searchPlaceholder":"Enter store name, address, or tag...","filterCategoryTitle":"Filter by Category","filterAll":"All","filterFavorites":"❤️ My Favorites","mapSectionTitle":"Sustainable Store Map","shopListSectionTitle":"Sustainable Shop List","loadMoreBtn":"Load More","newsletterTitle":"Subscribe to Sustainable Living Newsletter","newsletterSubtitle":"Get the latest info on sustainable stores, eco-friendly tips, and special offers.","newsletterPlaceholder":"Your email address","subscribeBtn":"Subscribe","reportIssueTitle":"Report an Issue","reportIssueEmailLabel":"Your Email","reportIssueEmailPlaceholder":"Enter your email","reportIssueTypeLabel":"Type of Issue","reportTypeInfoError":"Incorrect Store Info","reportTypeBug":"Website Bug","reportTypeSuggestion":"Suggestion","reportTypeOther":"Other","reportIssueLabel":"Please describe the issue","reportIssuePlaceholder":"Please provide details...","reportIssueSubmitBtn":"Submit Report","privacyPolicyTitle":"Privacy Policy","disclaimerTitle":"Disclaimer","loading":"Loading..."}};

    const getI18nValue = (dataObject, baseKey, lang, fallbackLang = 'zh-TW') => {
        if (!dataObject) return ''; // [STABILITY FIX] Prevent crash if dataObject is null/undefined
        return dataObject[`${baseKey}_${lang}`] || dataObject[`${baseKey}_${fallbackLang}`] || '';
    };

    const showToast = (message, isSuccess = true) => {
        ui.toastMessage.textContent = message;
        if (isSuccess) {
            ui.toastContent.className = 'flex items-center gap-4 p-4 mt-4 mx-2 rounded-lg shadow-lg bg-green-500 text-white';
            ui.toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        } else {
            ui.toastContent.className = 'flex items-center gap-4 p-4 mt-4 mx-2 rounded-lg shadow-lg bg-red-500 text-white';
            ui.toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        }
        ui.toast.style.transform = 'translate(-50%, 0)';
        setTimeout(() => { ui.toast.style.transform = 'translate(-50%, -100%)'; }, 3000);
    };

    async function apiRequest(action, payload = {}) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...payload }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            });
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            const text = await response.text();
            const result = JSON.parse(text);
            if (result.status === 'error') throw new Error(result.message);
            return result.data;
        } catch (error) {
            console.error(`API Error (${action}):`, error);
            showToast(`操作失敗: ${error.message}`, false);
            throw error;
        }
    }
    
    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('lang', lang);
        if (ui.languageSelect.value !== lang) ui.languageSelect.value = lang;
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            const translation = staticTranslations[lang]?.[key] || staticTranslations['zh-TW']?.[key] || `[${key}]`;
            if (el.placeholder !== undefined) el.placeholder = translation; else el.textContent = translation;
        });
        
        renderDynamicContent();
        filterAndDisplayShops(true);
    };

    const renderDynamicContent = () => {
        const announcement = announcements[currentLang] || announcements['zh-TW'];
        if (announcement) {
            ui.announcementText.textContent = announcement;
            ui.announcementBar.classList.remove('hidden');
        } else {
            ui.announcementBar.classList.add('hidden');
        }

        const privacy = policies.privacy ? (policies.privacy[currentLang] || policies.privacy['zh-TW']) : '';
        const disclaimer = policies.disclaimer ? (policies.disclaimer[currentLang] || policies.disclaimer['zh-TW']) : '';
        const privacyTitle = staticTranslations[currentLang]?.privacyPolicyTitle || staticTranslations['zh-TW'].privacyPolicyTitle;
        const disclaimerTitle = staticTranslations[currentLang]?.disclaimerTitle || staticTranslations['zh-TW'].disclaimerTitle;
        ui.policyContent.innerHTML = `
            <h3 class="text-2xl font-bold text-center">${privacyTitle}</h3><div>${(privacy || '').replace(/\n/g, '<br>')}</div>
            <h3 class="text-2xl font-bold text-center mt-8">${disclaimerTitle}</h3><div>${(disclaimer || '').replace(/\n/g, '<br>')}</div>`;
        
        ui.footer.innerHTML = `<div class="container mx-auto px-4 text-center text-gray-400 text-sm"><p>© ${new Date().getFullYear()} ${staticTranslations[currentLang].appName} - All Rights Reserved</p></div>`;

        renderFilterButtons();
    };
    
    const renderFilterButtons = () => {
        const staticButtons = Array.from(ui.filterButtonsContainer.querySelectorAll('button[data-category]'));
        ui.filterButtonsContainer.innerHTML = '';
        staticButtons.forEach(btn => ui.filterButtonsContainer.appendChild(btn));
        
        const uniqueTags = [...new Map(allShops.flatMap(s => s.tags || []).filter(Boolean).map(item => [item.id, item])).values()];
        uniqueTags.forEach(tag => {
            const button = document.createElement('button');
            button.className = 'tag bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm';
            button.dataset.tagId = tag.id;
            button.textContent = getI18nValue(tag, 'name', currentLang);
            ui.filterButtonsContainer.appendChild(button);
        });
    };

    const filterAndDisplayShops = (reset = false) => {
        if (reset) renderedShopCount = 0;
        
        const filtered = allShops.filter(shop => {
            const matchesCategory = currentFilter.category === '' || (currentFilter.category === 'favorites' ? favoriteShops.includes(String(shop.id)) : false);
            const matchesTag = currentFilter.tagId === '' || (shop.tags || []).some(t => String(t.id) === String(currentFilter.tagId));
            const query = currentFilter.query.toLowerCase();
            const matchesQuery = query === '' || 
                getI18nValue(shop, 'name', currentLang).toLowerCase().includes(query) ||
                getI18nValue(shop, 'address', currentLang).toLowerCase().includes(query) ||
                (shop.tags || []).some(t => getI18nValue(t, 'name', currentLang).toLowerCase().includes(query));
            return (matchesCategory || matchesTag) && matchesQuery;
        });

        renderShopCards(filtered);
        updateMapMarkers(filtered);
    };

    const renderShopCards = (filteredShops) => {
        if (renderedShopCount === 0) ui.shopCardsContainer.innerHTML = '';
        
        const shopsToRender = filteredShops.slice(renderedShopCount, renderedShopCount + shopsPerPage);
        
        shopsToRender.forEach(shop => {
            const card = document.createElement('div');
            card.className = 'shop-card bg-white rounded-xl overflow-hidden shadow-md relative flex flex-col';
            const isFavorited = favoriteShops.includes(String(shop.id));
            card.innerHTML = `
                <div class="h-48 bg-green-100 flex items-center justify-center text-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg></div>
                <button class="favorite-btn absolute top-4 right-4 bg-white/80 rounded-full p-2 ${isFavorited ? 'favorited' : ''}" data-shop-id="${shop.id}">
                    <svg class="w-6 h-6 stroke-gray-700 stroke-2 fill-none" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
                <div class="p-6 flex flex-col flex-grow">
                    <h3 class="text-xl font-bold mb-2">${getI18nValue(shop, 'name', currentLang)}</h3>
                    <p class="text-gray-600 mb-4 text-sm flex-grow">${getI18nValue(shop, 'description', currentLang)}</p>
                    <button class="show-detail-btn block w-full text-center py-2 bg-green-600 text-white rounded-lg font-medium mt-4" data-shop-id="${shop.id}">查看詳情</button>
                </div>`;
            card.querySelector('.show-detail-btn').addEventListener('click', () => showShopDetail(shop.id));
            card.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(shop.id, e.currentTarget);
            });
            ui.shopCardsContainer.appendChild(card);
        });
        
        renderedShopCount += shopsToRender.length;
        ui.loadMoreButton.classList.toggle('hidden', renderedShopCount >= filteredShops.length);
        
        if (filteredShops.length === 0 && renderedShopCount === 0) {
            ui.shopCardsContainer.innerHTML = `<p class="text-gray-500 md:col-span-2 lg:col-span-3 text-center">找不到符合條件的店家。</p>`;
        }
    };
    
    const updateMapMarkers = (filteredShops) => {
        if (!mapInstance) return;
        markersGroup.clearLayers();
        filteredShops.forEach(shop => {
            if (shop.lat && shop.lng) {
                const marker = L.marker([shop.lat, shop.lng]);
                marker.bindPopup(`<b>${getI18nValue(shop, 'name', currentLang)}</b><br><button class="text-green-600" onclick="document.dispatchEvent(new CustomEvent('show-shop', {detail: '${shop.id}'}))">查看詳情</button>`);
                markersGroup.addLayer(marker);
            }
        });
        if (filteredShops.length > 0 && markersGroup.getLayers().length > 0) {
            mapInstance.fitBounds(markersGroup.getBounds().pad(0.1));
        }
    };

    const toggleFavorite = (shopId, btnElement) => {
        const id = String(shopId);
        const index = favoriteShops.indexOf(id);
        if (index > -1) favoriteShops.splice(index, 1);
        else favoriteShops.push(id);
        localStorage.setItem('favoriteShops', JSON.stringify(favoriteShops));
        btnElement?.classList.toggle('favorited');
        if (currentFilter.category === 'favorites') filterAndDisplayShops(true);
    };

    const showShopDetail = (shopId) => {
        const shop = allShops.find(s => String(s.id) === String(shopId));
        if (!shop) return;
        const tagsHtml = (shop.tags || []).filter(Boolean).map(tag => `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${getI18nValue(tag, 'name', currentLang)}</span>`).join('');
        ui.shopDetailContent.innerHTML = `<div class="p-8 space-y-6">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 class="text-3xl font-bold">${getI18nValue(shop, 'name', currentLang)}</h2>
            <p class="text-gray-600">${getI18nValue(shop, 'longDescription', currentLang) || getI18nValue(shop, 'description', currentLang)}</p>
            <div>${tagsHtml}</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                <div class="space-y-4">
                    <h3 class="font-semibold">商店資訊</h3>
                    <p><b>地址:</b> ${getI18nValue(shop, 'address', currentLang)}</p>
                    <p><b>電話:</b> ${shop.phone || '未提供'}</p>
                    <p><b>網站:</b> ${shop.website ? `<a href="${shop.website.startsWith('http') ? '' : '//'}${shop.website}" target="_blank" class="text-green-600">${shop.website}</a>` : '未提供'}</p>
                </div>
                <div id="detail-map" class="h-64 rounded-lg bg-gray-200 z-0"></div>
            </div>
        </div>`;
        ui.shopDetailContent.querySelector('#closeModalBtn').onclick = closeModal;
        ui.shopDetailModal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
            const detailMap = L.map('detail-map').setView([shop.lat, shop.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);
            L.marker([shop.lat, shop.lng]).addTo(detailMap);
        }, 100);
    };
    const closeModal = () => {
        ui.shopDetailModal.classList.remove('flex');
        document.body.style.overflow = '';
    };

    const initializeMap = () => {
        mapInstance = L.map(ui.sustainabilityMap).setView([25.0330, 121.5654], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
        markersGroup.addTo(mapInstance);
    };

    // Event Listeners
    ui.languageSelect.addEventListener('change', (e) => setLanguage(e.target.value));
    ui.searchButton.addEventListener('click', () => {
        currentFilter.query = ui.searchInput.value;
        filterAndDisplayShops(true);
    });
    ui.searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') ui.searchButton.click(); });
    ui.loadMoreButton.addEventListener('click', () => filterAndDisplayShops());
    ui.filterButtonsContainer.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        ui.filterButtonsContainer.querySelectorAll('button').forEach(btn => btn.className = 'tag bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm');
        target.className = 'tag bg-green-600 text-white px-3 py-1 rounded-full text-sm';
        currentFilter.category = target.dataset.category || '';
        currentFilter.tagId = target.dataset.tagId || '';
        filterAndDisplayShops(true);
    });
    ui.newsletterForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = new FormData(e.target).get('email');
        await apiRequest('subscribe', { email });
        showToast(staticTranslations[currentLang].newsletterSuccess);
        e.target.reset();
    });
    ui.issueForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = Object.fromEntries(new FormData(e.target));
        await apiRequest('submitFeedback', {payload});
        showToast(staticTranslations[currentLang].reportIssueSuccessMsg);
        e.target.reset();
    });
    document.addEventListener('show-shop', (e) => showShopDetail(e.detail));

    async function initialize() {
        try {
            const data = await apiRequest('getPublicData');
            allShops = data.shops || [];
            allTags = data.tags || [];
            policies = data.policies || {};
            announcements = data.announcements || {};
            initializeMap();
            setLanguage(currentLang);
        } catch (error) {
            ui.loadingOverlay.innerHTML = `<p class="text-red-500 p-8 text-center">資料載入失敗，請檢查後端日誌或稍後重試。<br><br>${error.message}</p>`;
        } finally {
            ui.loadingOverlay.classList.add('opacity-0');
            setTimeout(() => ui.loadingOverlay.classList.add('hidden'), 300);
        }
    }
    initialize();
});
</script>
</body>
</html>

