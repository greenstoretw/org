<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8F9FA; }
        .hero-section { background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1542838132-92c53300491e?q=80&w=2874&auto=format&fit=crop') no-repeat center center; background-size: cover; }
        #map { height: 100%; min-height: 400px; border-radius: 0.5rem; z-index: 10; }
        .leaflet-popup-content-wrapper { border-radius: 0.5rem; }
        .shop-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .shop-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .favorite-btn.favorited { color: #ef4444; }
        .modal-backdrop { backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-green-700" data-i18n="headerTitle">永續商店地圖</h1>
            <div class="flex items-center space-x-4">
                <a href="#map-section" class="text-gray-600 hover:text-green-600" data-i18n="navMap">地圖</a>
                <a href="#footer" class="text-gray-600 hover:text-green-600" data-i18n="navContact">聯絡我們</a>
                <select id="lang-switcher" class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                    <option value="fr">Français</option>
                    <option value="de">Deutsch</option>
                    <option value="es">Español</option>
                    <option value="ja">日本語</option>
                    <option value="la">Latina</option>
                </select>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero-section text-white py-20 md:py-32">
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-4xl md:text-5xl font-bold mb-4" data-i18n="heroTitle">探索您附近的永續生活</h2>
            <p class="text-lg md:text-xl mb-8" data-i18n="heroSubtitle">一個致力於連結消費者與環保、在地、公平貿易商店的平台。</p>
            <a href="#map-section" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full transition duration-300" data-i18n="heroCta">開始探索</a>
        </div>
    </section>

    <!-- Map & Shops Section -->
    <main id="map-section" class="container mx-auto px-4 md:px-6 py-12">
        <div class="bg-white p-4 rounded-lg shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="search-input" data-i18n-placeholder="searchPlaceholder" class="col-span-1 md:col-span-2 p-2 border border-gray-300 rounded-md">
                <select id="tag-filter" class="p-2 border border-gray-300 rounded-md">
                    <option value="all" data-i18n="allTags">所有標籤</option>
                </select>
            </div>
        </div>
        <div class="flex flex-col lg:flex-row gap-8">
            <div id="shops-list-container" class="w-full lg:w-1/3">
                 <h3 class="text-2xl font-bold mb-4" data-i18n="storeListTitle">商店列表</h3>
                 <div id="shops-list" class="space-y-4 max-h-[1000px] overflow-y-auto pr-2"></div>
            </div>
            <div class="w-full lg:w-2/3">
                <div id="map" class="shadow-lg"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="footer" class="bg-gray-800 text-white pt-12 pb-8">
        <div class="container mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h4 class="text-lg font-semibold mb-3" data-i18n="subscribeTitle">訂閱電子報</h4>
                <p class="text-sm text-gray-400 mb-4" data-i18n="subscribeDesc">獲取最新的永續商店資訊與環保生活技巧。</p>
                <form id="subscribe-form" class="flex">
                    <input type="email" name="email" data-i18n-placeholder="emailPlaceholder" class="w-full rounded-l-md p-2 text-gray-800 focus:outline-none" required>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-r-md" data-i18n="subscribeBtn">訂閱</button>
                </form>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-3" data-i18n="linksTitle">相關連結</h4>
                <ul class="text-sm space-y-2">
                    <li><a href="#" id="privacy-link" class="text-gray-400 hover:text-white" data-i18n="privacyPolicy">隱私權政策</a></li>
                    <li><a href="#" id="disclaimer-link" class="text-gray-400 hover:text-white" data-i18n="disclaimer">免責聲明</a></li>
                    <li><a href="admin.html" class="text-gray-400 hover:text-white" data-i18n="adminLogin">管理員登入</a></li>
                </ul>
            </div>
        </div>
        <div class="text-center text-gray-500 text-sm mt-8 border-t border-gray-700 pt-6">
            <p>&copy; 2025 Sustainable Store Map. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div id="message-modal" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center hidden">
            <p id="message-modal-text" class="mb-4"></p>
            <button onclick="closeAllModals()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md" data-i18n="closeBtn">關閉</button>
        </div>
        <div id="policy-modal" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl hidden">
            <h2 id="policy-modal-title" class="text-2xl font-bold mb-4"></h2>
            <div id="policy-modal-content" class="prose max-h-[70vh] overflow-y-auto"></div>
            <div class="text-right mt-6">
                <button onclick="closeAllModals()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md" data-i18n="closeBtn">關閉</button>
            </div>
        </div>
        <div id="shop-detail-modal" class="bg-white rounded-lg shadow-xl w-full max-w-3xl hidden">
            <div class="relative"><button onclick="closeAllModals()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10">&times;</button>
                <div id="shop-detail-content" class="p-6 md:p-8 max-h-[80vh] overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <script>
        // =================================================================
        // CONFIGURATION
        // =================================================================
        const SCRIPT_URL = '請在這裡貼上您新的 Web App URL'; // <--- !!! 請務必修改這裡 !!!
        const EMAILJS_CONFIG = {
            serviceID: 'YOUR_SERVICE_ID',
            templateID: 'YOUR_TEMPLATE_ID',
            publicKey: 'YOUR_PUBLIC_KEY'
        };

        // =================================================================
        // STATE & INITIALIZATION
        // =================================================================
        let map;
        let allShops = [];
        let allTags = [];
        let policies = {};
        let currentLang = 'zh-TW';
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let markers = {};

        const translations = {
            'zh-TW': { pageTitle: "永續商店地圖", headerTitle: "永續商店地圖", navMap: "地圖", navContact: "聯絡我們", heroTitle: "探索您附近的永續生活", heroSubtitle: "一個致力於連結消費者與環保、在地、公平貿易商店的平台。", heroCta: "開始探索", searchPlaceholder: "搜尋店家名稱、地址...", allTags: "所有標籤", storeListTitle: "商店列表", subscribeTitle: "訂閱電子報", subscribeDesc: "獲取最新的永續商店資訊與環保生活技巧。", emailPlaceholder: "您的電子郵件", subscribeBtn: "訂閱", linksTitle: "相關連結", privacyPolicy: "隱私權政策", disclaimer: "免責聲明", adminLogin: "管理員登入", closeBtn: "關閉", subscribeSuccess: "訂閱成功！感謝您的支持。", subscribeError: "訂閱失敗，請稍後再試。", noShopsFound: "找不到符合條件的商店。", recommendationMailSent: "推薦信已寄出！", recommendationMailError: "推薦信寄送失敗。", recommendationEmailLabel: "收件人 Email (多個請用逗號分隔)", recommendationSubjectLabel: "郵件主旨", recommendationSendBtn: "寄送推薦信", phoneLabel: "電話", websiteLabel: "網站" },
            'en': { pageTitle: "Sustainable Store Map", headerTitle: "Sustainable Store Map", navMap: "Map", navContact: "Contact", heroTitle: "Discover Sustainable Living Near You", heroSubtitle: "A platform connecting consumers with eco-friendly, local, and fair-trade stores.", heroCta: "Start Exploring", searchPlaceholder: "Search store name, address...", allTags: "All Tags", storeListTitle: "Store List", subscribeTitle: "Subscribe to Newsletter", subscribeDesc: "Get the latest sustainable store info and eco-living tips.", emailPlaceholder: "Your Email", subscribeBtn: "Subscribe", linksTitle: "Links", privacyPolicy: "Privacy Policy", disclaimer: "Disclaimer", adminLogin: "Admin Login", closeBtn: "Close", subscribeSuccess: "Subscription successful!", subscribeError: "Subscription failed, please try again.", noShopsFound: "No matching stores found.", recommendationMailSent: "Recommendation email sent!", recommendationMailError: "Failed to send recommendation email.", recommendationEmailLabel: "Recipient Email(s) (comma-separated)", recommendationSubjectLabel: "Email Subject", recommendationSendBtn: "Send Recommendation", phoneLabel: "Phone", websiteLabel: "Website" },
            'fr': { pageTitle: "Carte des Magasins Durables", headerTitle: "Carte des Magasins Durables", navMap: "Carte", navContact: "Contact", heroTitle: "Découvrez la Vie Durable Près de Chez Vous", heroSubtitle: "Une plateforme reliant les consommateurs aux magasins écologiques, locaux et équitables.", heroCta: "Commencer à Explorer", searchPlaceholder: "Rechercher nom de magasin, adresse...", allTags: "Toutes les Étiquettes", storeListTitle: "Liste des Magasins", subscribeTitle: "S'abonner à la Newsletter", subscribeDesc: "Recevez les dernières infos sur les magasins durables et des conseils écologiques.", emailPlaceholder: "Votre Email", subscribeBtn: "S'abonner", linksTitle: "Liens", privacyPolicy: "Politique de Confidentialité", disclaimer: "Avis de Non-responsabilité", adminLogin: "Connexion Admin", closeBtn: "Fermer", subscribeSuccess: "Abonnement réussi!", subscribeError: "L'abonnement a échoué.", noShopsFound: "Aucun magasin correspondant trouvé.", recommendationMailSent: "E-mail de recommandation envoyé!", recommendationMailError: "Échec de l'envoi de l'e-mail.", recommendationEmailLabel: "E-mail(s) du destinataire", recommendationSubjectLabel: "Sujet de l'e-mail", recommendationSendBtn: "Envoyer", phoneLabel: "Téléphone", websiteLabel: "Site Web" },
            'de': { pageTitle: "Nachhaltigkeits-Ladenkarte", headerTitle: "Nachhaltigkeits-Ladenkarte", navMap: "Karte", navContact: "Kontakt", heroTitle: "Entdecken Sie nachhaltiges Leben in Ihrer Nähe", heroSubtitle: "Eine Plattform, die Verbraucher mit umweltfreundlichen, lokalen und fair gehandelten Geschäften verbindet.", heroCta: "Jetzt Entdecken", searchPlaceholder: "Suche nach Ladenname, Adresse...", allTags: "Alle Tags", storeListTitle: "Ladenliste", subscribeTitle: "Newsletter abonnieren", subscribeDesc: "Erhalten Sie die neuesten Informationen zu nachhaltigen Geschäften und umweltfreundlichen Tipps.", emailPlaceholder: "Ihre E-Mail", subscribeBtn: "Abonnieren", linksTitle: "Links", privacyPolicy: "Datenschutzrichtlinie", disclaimer: "Haftungsausschluss", adminLogin: "Admin-Login", closeBtn: "Schließen", subscribeSuccess: "Anmeldung erfolgreich!", subscribeError: "Anmeldung fehlgeschlagen.", noShopsFound: "Keine passenden Geschäfte gefunden.", recommendationMailSent: "Empfehlungs-E-Mail gesendet!", recommendationMailError: "E-Mail-Versand fehlgeschlagen.", recommendationEmailLabel: "Empfänger-E-Mail(s)", recommendationSubjectLabel: "E-Mail-Betreff", recommendationSendBtn: "Senden", phoneLabel: "Telefon", websiteLabel: "Webseite" },
            'es': { pageTitle: "Mapa de Tiendas Sostenibles", headerTitle: "Mapa de Tiendas Sostenibles", navMap: "Mapa", navContact: "Contacto", heroTitle: "Descubre una Vida Sostenible Cerca de Ti", heroSubtitle: "Una plataforma que conecta a consumidores con tiendas ecológicas, locales y de comercio justo.", heroCta: "Empezar a Explorar", searchPlaceholder: "Buscar nombre de tienda, dirección...", allTags: "Todas las Etiquetas", storeListTitle: "Lista de Tiendas", subscribeTitle: "Suscríbete al Boletín", subscribeDesc: "Recibe la información más reciente sobre tiendas sostenibles y consejos de vida ecológica.", emailPlaceholder: "Tu Email", subscribeBtn: "Suscribir", linksTitle: "Enlaces", privacyPolicy: "Política de Privacidad", disclaimer: "Descargo de Responsabilidad", adminLogin: "Acceso Admin", closeBtn: "Cerrar", subscribeSuccess: "¡Suscripción exitosa!", subscribeError: "La suscripción falló.", noShopsFound: "No se encontraron tiendas que coincidan.", recommendationMailSent: "¡Correo de recomendación enviado!", recommendationMailError: "Error al enviar el correo.", recommendationEmailLabel: "Email(s) del destinatario", recommendationSubjectLabel: "Asunto del Correo", recommendationSendBtn: "Enviar", phoneLabel: "Teléfono", websiteLabel: "Sitio Web" },
            'ja': { pageTitle: "サステナブルストアマップ", headerTitle: "サステナブルストアマップ", navMap: "地図", navContact: "お問い合わせ", heroTitle: "お近くのサステナブルな暮らしを発見", heroSubtitle: "環境に優しく、地元産でフェアトレードの店と消費者をつなぐプラットフォーム。", heroCta: "探索を始める", searchPlaceholder: "店名、住所で検索...", allTags: "すべてのタグ", storeListTitle: "店舗リスト", subscribeTitle: "ニュースレターを購読", subscribeDesc: "最新のサステナブルストア情報やエコな生活のヒントをお届けします。", emailPlaceholder: "あなたのメールアドレス", subscribeBtn: "購読", linksTitle: "リンク", privacyPolicy: "プライバシーポリシー", disclaimer: "免責事項", adminLogin: "管理者ログイン", closeBtn: "閉じる", subscribeSuccess: "購読成功！", subscribeError: "購読に失敗しました。", noShopsFound: "該当する店舗が見つかりません。", recommendationMailSent: "推薦メールが送信されました！", recommendationMailError: "メールの送信に失敗しました。", recommendationEmailLabel: "受信者のメールアドレス", recommendationSubjectLabel: "メールの件名", recommendationSendBtn: "送信", phoneLabel: "電話番号", websiteLabel: "ウェブサイト" },
            'la': { pageTitle: "Tabula Mercatorum Durabilium", headerTitle: "Tabula Mercatorum Durabilium", navMap: "Tabula", navContact: "Contactus", heroTitle: "Vitam Durabilem Prope Te Reperi", heroSubtitle: "Platea quae emptores cum tabernis oecologicis, localibus et aequis commerciis coniungit.", heroCta: "Explorare Incipe", searchPlaceholder: "Quaere nomen tabernae, inscriptionem...", allTags: "Omnes Pittacia", storeListTitle: "Index Tabernarum", subscribeTitle: "Ephemeridi Subscribe", subscribeDesc: "Accipe novissimas informationes de tabernis durabilibus et apicibus vitae oecologicae.", emailPlaceholder: "Epistula Tua", subscribeBtn: "Subscribe", linksTitle: "Nexus", privacyPolicy: "Consilium de secreto", disclaimer: "Renuntiatio", adminLogin: "Admin Login", closeBtn: "Claude", subscribeSuccess: "Subscriptio felix!", subscribeError: "Subscriptio fefellit.", noShopsFound: "Nullae tabernae inventae.", recommendationMailSent: "Epistula commendaticia missa!", recommendationMailError: "Error in mittendo epistulam.", recommendationEmailLabel: "Epistula(e) accipientis", recommendationSubjectLabel: "Argumentum Epistulae", recommendationSendBtn: "Mitte", phoneLabel: "Telephonum", websiteLabel: "Situs Interretialis" }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            setupEventListeners();
        });

        async function initApp() {
            initMap();
            await fetchData();
            updateLanguage(localStorage.getItem('lang') || 'zh-TW');
            emailjs.init(EMAILJS_CONFIG.publicKey);
        }

        function initMap() {
            map = L.map('map').setView([25.034, 121.565], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }
        
        async function apiCall(action, payload = {}) {
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action, ...payload }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error(`API call failed for action "${action}":`, error);
                showMessageModal(`Error: ${error.message}`);
                throw error;
            }
        }

        async function fetchData() {
            try {
                const data = await apiCall('getPublicData');
                allShops = data.shops;
                allTags = data.tags;
                policies = data.policies;
                renderTagFilter();
                filterShops();
            } catch (error) {
                console.error("Failed to fetch initial data:", error);
            }
        }

        function renderShops(shopsToDisplay) {
            const listElement = document.getElementById('shops-list');
            listElement.innerHTML = '';
            if (shopsToDisplay.length === 0) {
                listElement.innerHTML = `<p class="text-gray-500">${translations[currentLang].noShopsFound}</p>`;
                updateMarkers([]);
                return;
            }
            shopsToDisplay.forEach(shop => {
                const isFavorite = favorites.includes(shop.id);
                const tagNames = shop.tags.map(tagId => allTags.find(t => t.id === tagId)?.[`name_${currentLang}`] || '').filter(Boolean);
                const card = `
                    <div class="shop-card bg-white rounded-lg shadow p-4 cursor-pointer" onclick="showShopDetail('${shop.id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg">${shop[`name_${currentLang}`] || shop['name_zh-TW']}</h4>
                                <p class="text-sm text-gray-600">${shop[`address_${currentLang}`] || shop['address_zh-TW']}</p>
                            </div>
                            <button onclick="event.stopPropagation(); toggleFavorite('${shop.id}')" class="favorite-btn text-2xl ${isFavorite ? 'favorited' : 'text-gray-300 hover:text-red-400'}">&hearts;</button>
                        </div>
                        <div class="mt-2">
                            ${tagNames.map(name => `<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${name}</span>`).join('')}
                        </div>
                    </div>
                `;
                listElement.insertAdjacentHTML('beforeend', card);
            });
            updateMarkers(shopsToDisplay);
        }

        function updateMarkers(shopsToDisplay) {
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};
            shopsToDisplay.forEach(shop => {
                if (shop.lat && shop.lng) {
                    const marker = L.marker([shop.lat, shop.lng]).addTo(map);
                    marker.bindPopup(`<b>${shop[`name_${currentLang}`] || shop['name_zh-TW']}</b>`);
                    marker.on('click', () => showShopDetail(shop.id));
                    markers[shop.id] = marker;
                }
            });
        }
        
        function showShopDetail(shopId) {
            const shop = allShops.find(s => s.id === shopId);
            if (!shop) return;
            
            const isFavorite = favorites.includes(shop.id);
            const tagNames = shop.tags.map(tagId => allTags.find(t => t.id === tagId)?.[`name_${currentLang}`] || '').filter(Boolean);
            const contentEl = document.getElementById('shop-detail-content');
            
            contentEl.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-3xl font-bold">${shop[`name_${currentLang}`] || shop['name_zh-TW']}</h2>
                    <button onclick="toggleFavorite('${shop.id}')" class="favorite-btn text-3xl ${isFavorite ? 'favorited' : 'text-gray-300 hover:text-red-400'}">&hearts;</button>
                </div>
                <p class="text-gray-600 mb-2">${shop[`address_${currentLang}`] || shop['address_zh-TW']}</p>
                <div class="mb-4">${tagNames.map(name => `<span class="inline-block bg-green-100 text-green-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded-full">${name}</span>`).join('')}</div>
                <p class="mb-4">${shop[`longDescription_${currentLang}`] || shop[`description_${currentLang}`] || shop['longDescription_zh-TW'] || shop['description_zh-TW']}</p>
                <div class="border-t pt-4">
                    ${shop.phone ? `<p><b>${translations[currentLang].phoneLabel}:</b> <a href="tel:${shop.phone}" class="text-green-600">${shop.phone}</a></p>` : ''}
                    ${shop.website ? `<p><b>${translations[currentLang].websiteLabel}:</b> <a href="${shop.website}" target="_blank" class="text-green-600">${shop.website}</a></p>` : ''}
                </div>
                <div class="mt-6">
                    <h4 class="font-bold mb-2">${translations[currentLang].recommendationSubjectLabel}</h4>
                    <input type="text" id="recommend-subject" class="w-full p-2 border rounded-md mb-2" value="${shop[`name_${currentLang}`] || shop['name_zh-TW']}">
                    <h4 class="font-bold mb-2">${translations[currentLang].recommendationEmailLabel}</h4>
                    <input type="email" id="recommend-email" class="w-full p-2 border rounded-md mb-4">
                    <button onclick="sendRecommendationEmail('${shop.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">${translations[currentLang].recommendationSendBtn}</button>
                </div>
            `;
            openModal('shop-detail-modal');
            if (markers[shop.id]) map.setView([shop.lat, shop.lng], 15).openPopup(markers[shop.id]);
        }

        function updateLanguage(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.documentElement.lang = lang;
            document.getElementById('lang-switcher').value = lang;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });
            renderTagFilter();
            filterShops();
        }

        function renderTagFilter() {
            const filterElement = document.getElementById('tag-filter');
            const currentVal = filterElement.value;
            filterElement.innerHTML = `<option value="all">${translations[currentLang].allTags}</option>`;
            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.id;
                option.textContent = tag[`name_${currentLang}`] || tag['name_zh-TW'];
                filterElement.appendChild(option);
            });
            filterElement.value = currentVal;
        }

        function setupEventListeners() {
            document.getElementById('lang-switcher').addEventListener('change', (e) => updateLanguage(e.target.value));
            document.getElementById('search-input').addEventListener('input', filterShops);
            document.getElementById('tag-filter').addEventListener('change', filterShops);
            document.getElementById('privacy-link').addEventListener('click', (e) => { e.preventDefault(); showPolicy('privacy'); });
            document.getElementById('disclaimer-link').addEventListener('click', (e) => { e.preventDefault(); showPolicy('disclaimer'); });
            document.getElementById('subscribe-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await apiCall('subscribe', { email: e.target.email.value });
                    showMessageModal(translations[currentLang].subscribeSuccess);
                    e.target.reset();
                } catch (error) {
                    showMessageModal(`${translations[currentLang].subscribeError}: ${error.message}`);
                }
            });
        }
        
        function filterShops() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const selectedTag = document.getElementById('tag-filter').value;
            let filtered = allShops;

            if (searchTerm) {
                filtered = filtered.filter(shop => 
                    Object.values(shop).some(val => typeof val === 'string' && val.toLowerCase().includes(searchTerm))
                );
            }
            if (selectedTag !== 'all') {
                filtered = filtered.filter(shop => shop.tags.includes(selectedTag));
            }
            renderShops(filtered);
        }

        function toggleFavorite(shopId) {
            const index = favorites.indexOf(shopId);
            if (index > -1) favorites.splice(index, 1);
            else favorites.push(shopId);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            filterShops();
            if (document.getElementById('shop-detail-modal').classList.contains('hidden') === false) {
                showShopDetail(shopId);
            }
        }

        async function sendRecommendationEmail(shopId) {
            const shop = allShops.find(s => s.id === shopId);
            const to_email = document.getElementById('recommend-email').value;
            if (!to_email) return alert('請輸入收件人 Email');
            
            const templateParams = {
                to_email,
                subject: document.getElementById('recommend-subject').value,
                shop_name: shop[`name_${currentLang}`] || shop['name_zh-TW'],
                shop_address: shop[`address_${currentLang}`] || shop['address_zh-TW'],
                shop_description: shop[`description_${currentLang}`] || shop['description_zh-TW'],
                shop_website: shop.website || 'N/A',
            };
            try {
                await emailjs.send(EMAILJS_CONFIG.serviceID, EMAILJS_CONFIG.templateID, templateParams);
                showMessageModal(translations[currentLang].recommendationMailSent);
            } catch (error) {
                console.error('EmailJS send failed:', error);
                showMessageModal(translations[currentLang].recommendationMailError);
            }
        }

        function openModal(modalId) { document.getElementById('modal-container').classList.remove('hidden'); document.getElementById(modalId).classList.remove('hidden'); }
        function closeAllModals() { document.getElementById('modal-container').classList.add('hidden'); document.querySelectorAll('#modal-container > div').forEach(m => m.classList.add('hidden')); }
        function showMessageModal(message) { document.getElementById('message-modal-text').textContent = message; openModal('message-modal'); }
        function showPolicy(key) {
            const policy = policies[key];
            if (policy) {
                const content = policy[`value_${currentLang}`] || policy['value_zh-TW'];
                document.getElementById('policy-modal-title').textContent = content.split('\n')[0];
                document.getElementById('policy-modal-content').innerHTML = content.replace(/\n/g, '<br>');
                openModal('policy-modal');
            }
        }

        window.showShopDetail = showShopDetail;
        window.sendRecommendationEmail = sendRecommendationEmail;
        window.toggleFavorite = toggleFavorite;
        window.closeAllModals = closeAllModals;
    </script>
</body>
</html>

