<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f7f4; }
        .hero-section { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?auto=format&fit=crop&w=1200&q=80') center/cover; }
        .tag { background-color: #dcfce7; color: #16a34a; transition: all 0.2s ease; }
        .tag.active, .tag:hover { background-color: #16a34a; color: white; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content b { color: #15803d; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800">

    <!-- Announcement Bar -->
    <div id="announcement-bar" class="bg-green-600 text-white text-center p-2 text-sm font-medium animate-fade-in hidden"></div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4">
        <!-- Header -->
        <header class="py-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-green-800" data-i18n="headerTitle">永續商店地圖</h1>
            <select id="lang-switcher" class="rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                <option value="zh-TW">繁體中文</option>
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="es">Español</option>
                <option value="ja">日本語</option>
                <option value="la">Latin</option>
            </select>
        </header>

        <!-- Hero Section -->
        <section class="hero-section text-white rounded-xl p-8 md:p-16 my-6 text-center animate-fade-in">
            <h2 class="text-4xl md:text-5xl font-bold mb-4" data-i18n="heroTitle">探索您身邊的綠色選擇</h2>
            <p class="max-w-2xl mx-auto" data-i18n="heroSubtitle">從有機食品到環保商品，支持本地的永續發展店家，共同為地球盡一份心力。</p>
        </section>

        <!-- Map and Filters -->
        <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Filters -->
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-green-700" data-i18n="filterTitle">篩選店家</h3>
                    <div id="tags-container" class="flex flex-wrap gap-2">
                        <!-- Tags will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="md:col-span-2 h-[400px] md:h-auto bg-white rounded-xl shadow-md" id="map"></div>
        </main>

        <!-- Newsletter and Issue Report -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 my-12">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-xl font-bold mb-4 text-green-700" data-i18n="newsletterTitle">訂閱電子報</h3>
                <p class="text-gray-600 mb-4" data-i18n="newsletterText">獲取最新的永續商店資訊與推薦。</p>
                <form id="newsletter-form" class="flex">
                    <input type="email" name="email" placeholder="your.email@example.com" required class="w-full rounded-l-md border-gray-300 focus:ring-green-500 focus:border-green-500">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-r-md" data-i18n="subscribeButton">訂閱</button>
                </form>
                <p id="newsletterSuccess" class="text-green-600 mt-2 hidden"></p>
                <p id="newsletterError" class="text-red-600 mt-2 hidden"></p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-xl font-bold mb-4 text-green-700" data-i18n="issueTitle">回報問題</h3>
                <p class="text-gray-600 mb-4" data-i18n="issueText">店家資訊有誤或有其他建議？請告訴我們！</p>
                <form id="issue-form">
                    <input type="email" name="email" placeholder="您的電子郵件" required class="w-full rounded-md border-gray-300 mb-2">
                    <select name="type" class="w-full rounded-md border-gray-300 mb-2">
                      <option value="錯誤回報">錯誤回報</option>
                      <option value="店家推薦">店家推薦</option>
                      <option value="功能建議">功能建議</option>
                      <option value="其他">其他</option>
                    </select>
                    <textarea name="message" placeholder="請在此描述您的問題或建議..." rows="3" required class="w-full rounded-md border-gray-300 mb-2"></textarea>
                    <button type="submit" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md w-full" data-i18n="submitButton">提交</button>
                </form>
                 <p id="reportIssueSuccess" class="text-green-600 mt-2 hidden"></p>
                 <p id="reportIssueError" class="text-red-600 mt-2 hidden"></p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center py-6 text-gray-500">
            <p>&copy; 2024 永續商店地圖. All rights reserved. | <a href="#" id="showPolicyFooter" class="hover:text-green-700">隱私權與免責聲明</a></p>
        </footer>
    </div>
    
    <!-- Policy Modal -->
    <div id="policy-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden animate-fade-in">
        <div id="policy-content" class="bg-white rounded-xl p-8 max-w-3xl w-full relative overflow-y-auto max-h-[80vh]">
            <!-- Policy content will be inserted here -->
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://script.google.com/macros/s/AKfycbzqOIV2SfC_pTQ_8LVoXEib5g4qSUGwC-YtzrVUTMlvrdtMg8SXhEV3wsSS92q3KFSbww/exec';
    let map;
    let markers = [];
    let allShops = [];
    let tags = {};
    let policies = {};
    let currentLang = localStorage.getItem('mapLang') || 'zh-TW';

    const translations = {
        'zh-TW': {
            pageTitle: '永續商店地圖', headerTitle: '永續商店地圖', heroTitle: '探索您身邊的綠色選擇',
            heroSubtitle: '從有機食品到環保商品，支持本地的永續發展店家，共同為地球盡一份心力。',
            filterTitle: '篩選店家', newsletterTitle: '訂閱電子報', newsletterText: '獲取最新的永續商店資訊與推薦。',
            subscribeButton: '訂閱', issueTitle: '回報問題', issueText: '店家資訊有誤或有其他建議？請告訴我們！',
            submitButton: '提交', privacyPolicy: '隱私權與免責聲明'
        },
        'en': {
            pageTitle: 'Sustainable Store Map', headerTitle: 'Sustainable Store Map', heroTitle: 'Discover Green Choices Around You',
            heroSubtitle: 'From organic food to eco-friendly products, support local sustainable businesses and contribute to our planet.',
            filterTitle: 'Filter Stores', newsletterTitle: 'Subscribe to Newsletter', newsletterText: 'Get the latest info and recommendations on sustainable stores.',
            subscribeButton: 'Subscribe', issueTitle: 'Report an Issue', issueText: 'Incorrect store info or other suggestions? Let us know!',
            submitButton: 'Submit', privacyPolicy: 'Privacy & Disclaimer'
        },
        'fr': {
            pageTitle: 'Carte des Magasins Durables', headerTitle: 'Carte des Magasins Durables', heroTitle: 'Découvrez les Choix Verts Autour de Vous',
            heroSubtitle: "De l'alimentation biologique aux produits écologiques, soutenez les entreprises locales durables et contribuez à notre planète.",
            filterTitle: 'Filtrer les Magasins', newsletterTitle: "S'abonner à la Newsletter", newsletterText: 'Recevez les dernières informations et recommandations sur les magasins durables.',
            subscribeButton: "S'abonner", issueTitle: 'Signaler un Problème', issueText: 'Informations incorrectes sur un magasin ou autres suggestions ? Faites-le nous savoir !',
            submitButton: 'Soumettre', privacyPolicy: 'Confidentialité et Avis de Non-responsabilité'
        },
        'de': {
            pageTitle: 'Nachhaltigkeits-Ladenkarte', headerTitle: 'Nachhaltigkeits-Ladenkarte', heroTitle: 'Entdecken Sie grüne Alternativen in Ihrer Nähe',
            heroSubtitle: 'Von Bio-Lebensmitteln bis zu umweltfreundlichen Produkten, unterstützen Sie lokale nachhaltige Unternehmen und tragen Sie zum Schutz unseres Planeten bei.',
            filterTitle: 'Geschäfte filtern', newsletterTitle: 'Newsletter abonnieren', newsletterText: 'Erhalten Sie die neuesten Informationen und Empfehlungen zu nachhaltigen Geschäften.',
            subscribeButton: 'Abonnieren', issueTitle: 'Problem melden', issueText: 'Falsche Geschäftsinformationen oder andere Vorschläge? Lassen Sie es uns wissen!',
            submitButton: 'Senden', privacyPolicy: 'Datenschutz & Haftungsausschluss'
        },
        'es': {
            pageTitle: 'Mapa de Tiendas Sostenibles', headerTitle: 'Mapa de Tiendas Sostenibles', heroTitle: 'Descubre Opciones Ecológicas a tu Alrededor',
            heroSubtitle: 'Desde alimentos orgánicos hasta productos ecológicos, apoya a los negocios locales sostenibles y contribuye a nuestro planeta.',
            filterTitle: 'Filtrar Tiendas', newsletterTitle: 'Suscríbete al Boletín', newsletterText: 'Recibe la información y recomendaciones más recientes sobre tiendas sostenibles.',
            subscribeButton: 'Suscribir', issueTitle: 'Reportar un Problema', issueText: '¿Información incorrecta de la tienda u otras sugerencias? ¡Háznoslo saber!',
            submitButton: 'Enviar', privacyPolicy: 'Privacidad y Descargo de Responsabilidad'
        },
        'ja': {
            pageTitle: 'サステナブルストアマップ', headerTitle: 'サステナブルストアマップ', heroTitle: 'あなたの周りのグリーンな選択肢を発見',
            heroSubtitle: 'オーガニック食品から環境に優しい製品まで、地元の持続可能なビジネスを支援し、私たちの地球に貢献しましょう。',
            filterTitle: '店舗を絞り込む', newsletterTitle: 'ニュースレターを購読', newsletterText: 'サステナブルストアに関する最新情報やおすすめを入手してください。',
            subscribeButton: '購読する', issueTitle: '問題を報告', issueText: '店舗情報が正しくない場合や、その他の提案がありますか？お知らせください！',
            submitButton: '送信', privacyPolicy: 'プライバシーと免責事項'
        },
        'la': {
            pageTitle: 'Tabula Copiarum Sustentabilium', headerTitle: 'Tabula Copiarum Sustentabilium', heroTitle: 'Invenī Electiones Virides Circa Tē',
            heroSubtitle: 'Ab cibo organico ad producta oecologica, sustine negotia localia sustentabilia et ad planetam nostram contribue.',
            filterTitle: 'Cola Copias', newsletterTitle: 'Scribe ad Ephemeridem', newsletterText: 'Accipe novissimas informationes et commendationes de copiis sustentabilibus.',
            subscribeButton: 'Scribe', issueTitle: 'Nuntia Problema', issueText: 'Informationes copiae falsae an aliae suggestiones? Fac nōs scīre!',
            submitButton: 'Mitte', privacyPolicy: 'Secretum & Repudiatio'
        }
    };
    
    // --- 【修正】更新 getLangValue 函式以提高穩健性 ---
    const getLangValue = (obj, key, lang) => {
        if (!obj) return '';
        return obj[`${key}_${lang}`] || obj[`${key}_zh-TW`] || obj[`${key}_en`] || '';
    };

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('mapLang', lang);
        const t = translations[lang] || translations['zh-TW'];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) {
                el.textContent = t[key];
            }
        });
        document.documentElement.lang = lang;
        // Re-render map markers and tags with new language
        if(allShops.length > 0) {
            renderMarkers(allShops);
            renderTags(Object.keys(tags));
        }
    };

    const langSwitcher = document.getElementById('lang-switcher');
    langSwitcher.value = currentLang;
    langSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));
    
    const initMap = () => {
        map = L.map('map').setView([25.034, 121.565], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    };
    
    const renderTags = (tagIds) => {
        const container = document.getElementById('tags-container');
        container.innerHTML = tagIds.map(tagId => {
            const tagName = getLangValue(tags[tagId], 'name', currentLang);
            return `<button class="tag text-sm font-medium py-1 px-3 rounded-full" data-tag-id="${tagId}">${tagName}</button>`;
        }).join('');
        
        container.querySelectorAll('.tag').forEach(tagEl => {
            tagEl.addEventListener('click', () => {
                tagEl.classList.toggle('active');
                filterMarkers();
            });
        });
    };

    const renderMarkers = (shopsToRender) => {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        shopsToRender.forEach(shop => {
            if (shop.lat && shop.lng) {
                const popupContent = `<b>${getLangValue(shop, 'name', currentLang)}</b><br>${getLangValue(shop, 'description', currentLang)}`;
                const marker = L.marker([shop.lat, shop.lng]).addTo(map).bindPopup(popupContent);
                markers.push(marker);
            }
        });
    };

    const filterMarkers = () => {
        const activeTags = [...document.querySelectorAll('.tag.active')].map(el => el.dataset.tagId);
        if (activeTags.length === 0) {
            renderMarkers(allShops);
            return;
        }
        const filteredShops = allShops.filter(shop => {
            const shopTags = (shop.tags || '').split(',').map(t => t.trim());
            return activeTags.every(activeTag => shopTags.includes(activeTag));
        });
        renderMarkers(filteredShops);
    };

    const fetchPublicData = async () => {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'getPublicData' })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            
            const data = result.data;
            allShops = data.shops || [];
            tags = data.tags || {};
            policies = data.policies || {};
            const announcement = data.announcement || {};
            
            // --- 【修正】更新公告列的取值方式以支援多語言 ---
            const announcementText = getLangValue(announcement, 'content', currentLang);
            if(announcementText) {
                const announcementBar = document.getElementById('announcement-bar');
                announcementBar.textContent = announcementText;
                announcementBar.classList.remove('hidden');
            }
            
            const allTagIds = allShops.reduce((acc, shop) => {
                const shopTags = (shop.tags || '').split(',').map(t => t.trim()).filter(Boolean);
                return new Set([...acc, ...shopTags]);
            }, new Set());
            
            renderTags([...allTagIds]);
            renderMarkers(allShops);
            setLanguage(currentLang);
        } catch (error) {
            console.error('Failed to fetch public data:', error);
            alert('無法載入地圖資料，請稍後再試。');
        }
    };
    
    const submitApiForm = async (form, action, successId, errorId) => {
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        const successEl = document.getElementById(successId);
        const errorEl = document.getElementById(errorId);
        
        successEl.classList.add('hidden');
        errorEl.classList.add('hidden');

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, payload })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            
            successEl.textContent = result.data.message;
            successEl.classList.remove('hidden');
            form.reset();

        } catch (err) {
            errorEl.textContent = `錯誤: ${err.message}`;
            errorEl.classList.remove('hidden');
        }
    };

    document.getElementById('newsletter-form').addEventListener('submit', e => { e.preventDefault(); submitApiForm(e.target, 'subscribe', 'newsletterSuccess', 'newsletterError'); });
    document.getElementById('issue-form').addEventListener('submit', e => { e.preventDefault(); submitApiForm(e.target, 'submitFeedback', 'reportIssueSuccess', 'reportIssueError'); });
    
    document.getElementById('showPolicyFooter').addEventListener('click', () => {
        const policyModal = document.getElementById('policy-modal');
        const t = translations[currentLang] || translations['zh-TW'];
        
        // --- 【修正】更新政策內容的取值方式以支援多語言 ---
        const privacyHTML = getLangValue(policies.privacy, 'value', currentLang).replace(/\n/g, '<br>');
        const disclaimerHTML = getLangValue(policies.disclaimer, 'value', currentLang).replace(/\n/g, '<br>');

        document.getElementById('policy-content').innerHTML = `<h2 class="text-2xl font-bold mb-4">${t.privacyPolicy}</h2><div class="space-y-4 text-left">${privacyHTML}<br><br>${disclaimerHTML}</div><button id="close-policy" class="absolute top-2 right-2 p-2 text-2xl">&times;</button>`;
        policyModal.classList.remove('hidden');
    });
    
    document.getElementById('policy-modal').addEventListener('click', e => { if (e.target.matches('#policy-modal, #close-policy')) e.currentTarget.classList.add('hidden'); });

    initMap();
    fetchPublicData();
});
</script>
</body>
</html>
