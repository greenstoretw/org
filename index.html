<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="pageTitle">永續商店地圖 - 首頁</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Security headers for static hosting (advisory via meta) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://unpkg.com https://cdn.tailwindcss.com https://fonts.googleapis.com https://fonts.gstatic.com https://*.tile.openstreetmap.org https://images.unsplash.com https://cdn.jsdelivr.net https://script.google.com; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net 'unsafe-eval'; connect-src https://script.google.com https://script.googleusercontent.com;">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; }
    #map { height: 100%; width: 100%; z-index: 10; }
    .leaflet-popup-content-wrapper { border-radius: 8px; }
    .leaflet-popup-content { margin: 15px; font-size: 14px; }
    /* Custom modal backdrop */
    .modal-backdrop { backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    /* Hide scrollbar for sidebar */
    #sidebar-content::-webkit-scrollbar { display: none; }
    #sidebar-content { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="overflow-hidden">

  <div class="relative h-screen w-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="absolute md:relative top-0 left-0 h-full w-full md:w-96 bg-white shadow-lg z-20 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h1 class="text-2xl font-bold text-green-800" data-i18n="sidebarTitle">永續商店地圖</h1>
            <button id="close-sidebar-btn" class="md:hidden text-gray-600 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="p-4">
            <input type="text" id="search-box" data-i18n-placeholder="searchPlaceholder" placeholder="搜尋店名、地址或標籤..." class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div id="sidebar-content" class="flex-grow overflow-y-auto">
            <div id="shop-list" class="divide-y divide-gray-200"></div>
        </div>
        <div class="p-4 border-t text-center text-sm">
            <a href="#" id="feedback-link" data-i18n="reportIssue" class="text-gray-600 hover:text-green-700">回報問題 / 推薦店家</a>
        </div>
    </aside>

    <!-- Map Area -->
    <main class="flex-grow h-full relative">
      <div id="map"></div>
      <button id="open-sidebar-btn" class="md:hidden absolute top-4 left-4 z-10 bg-white p-2 rounded-full shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
      </button>
    </main>
  </div>
  
  <!-- Shop Details Modal -->
  <div id="shop-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop items-center justify-center hidden z-30">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full m-4 max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center border-b pb-3">
        <h2 id="modal-shop-name" class="text-2xl font-bold"></h2>
        <button onclick="closeModal('shop-modal')" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>
      <div id="modal-content" class="overflow-y-auto mt-4">
        <!-- Content injected by JS -->
      </div>
      <div class="border-t pt-4 mt-4 text-right">
        <button onclick="closeModal('shop-modal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" data-i18n="closeBtn">關閉</button>
      </div>
    </div>
  </div>

  <!-- Generic Message Modal -->
  <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop items-center justify-center hidden z-40">
      <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full m-4 text-center">
          <p id="message-modal-text" class="mb-6"></p>
          <button onclick="closeModal('message-modal')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full" data-i18n="okBtn">確定</button>
      </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop items-center justify-center hidden z-40">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full m-4">
      <h2 class="text-xl font-bold mb-4" data-i18n="reportIssueModalTitle">回報問題 / 推薦店家</h2>
      <form id="feedback-form">
        <div class="mb-4">
          <label for="feedback-email" class="block text-sm font-medium text-gray-700" data-i18n="contactEmail">您的 Email (選填)</label>
          <input type="email" id="feedback-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
        </div>
        <div class="mb-4">
          <label for="feedback-type" class="block text-sm font-medium text-gray-700" data-i18n="feedbackType">類型</label>
          <select id="feedback-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-md">
            <option value="issue" data-i18n="typeIssue">店家資訊有誤</option>
            <option value="recommendation" data-i18n="typeRecommendation">推薦新店家</option>
            <option value="feedback" data-i18n="typeFeedback">網站功能建議</option>
            <option value="other" data-i18n="typeOther">其他</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="feedback-message" class="block text-sm font-medium text-gray-700" data-i18n="feedbackMessage">詳細說明</label>
          <textarea id="feedback-message" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required></textarea>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeModal('feedback-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" data-i18n="cancelBtn">取消</button>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" data-i18n="submitBtn">提交</button>
        </div>
      </form>
    </div>
  </div>


<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwU7dDTM-J0JIx-m-GqP15n1Pvo6_iil23Qk2Q-G0E9Q2i-aQjP_iV-LpXbY3Wd-B4w/exec';
  let map, allShops = [], allTags = [], fuse;
  let currentLang = 'zh-TW'; // Default language

  // ===== Security & Formatting Utility =====
  /**
   * Escapes HTML special characters in a string to prevent XSS.
   * Also converts newline characters to <br> tags for display.
   * @param {any} str The string to escape and format.
   * @returns {string} The formatted and safe HTML string.
   */
  function sanitizeAndFormat(str) {
    if (str === null || typeof str === 'undefined') return '';
    const escaped = str.toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
    return escaped.replace(/\r\n|\r|\n/g, '<br>');
  }
  
  // A simpler version for attributes or places where no line breaks are needed.
  function escapeHTML(str) {
    if (str === null || typeof str === 'undefined') return '';
    return str.toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // ===== Initialization =====
  document.addEventListener('DOMContentLoaded', () => {
    initMap();
    fetchData();
    setupEventListeners();
  });

  function initMap() {
    map = L.map('map').setView([25.034, 121.565], 13); // Centered on Taipei
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
  }

  async function fetchData() {
    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'getData', payload: { types: ['shops', 'tags'] } })
      });
      const result = await response.json();
      if (result.status === 'error') throw new Error(result.message);
      
      allShops = result.data.shops;
      allTags = result.data.tags;

      setupFuse();
      renderShopList(allShops);
      addMarkersToMap(allShops);
    } catch (error) {
      console.error('Failed to fetch data:', error);
      showMessageModal('無法載入資料，請稍後再試。');
    }
  }

  function setupFuse() {
    const options = {
      keys: [
        'name_zh-TW', 'name_en',
        'address_zh-TW', 'address_en',
        'description_zh-TW', 'description_en',
        'tags' // We'll search by tag IDs
      ],
      includeScore: true,
      threshold: 0.4
    };
    fuse = new Fuse(allShops, options);
  }

  function setupEventListeners() {
    document.getElementById('search-box').addEventListener('input', handleSearch);
    document.getElementById('open-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.remove('-translate-x-full'));
    document.getElementById('close-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.add('-translate-x-full'));
    document.getElementById('feedback-link').addEventListener('click', (e) => { e.preventDefault(); openModal('feedback-modal'); });
    document.getElementById('feedback-form').addEventListener('submit', handleFeedbackSubmit);
  }

  // ===== UI Rendering =====
  function renderShopList(shops) {
    const listElement = document.getElementById('shop-list');
    if (shops.length === 0) {
        listElement.innerHTML = `<div class="p-4 text-center text-gray-500">找不到符合條件的商店。</div>`;
        return;
    }
    const tagsMap = allTags.reduce((acc, tag) => {
      acc[tag.id] = tag['name_' + currentLang] || tag['name_zh-TW'];
      return acc;
    }, {});
    listElement.innerHTML = shops.map(shop => `
      <div class="p-4 cursor-pointer hover:bg-gray-100" onclick="openShopModal('${shop.id}')">
        <h3 class="font-bold text-lg text-green-700">${escapeHTML(shop['name_' + currentLang] || shop['name_zh-TW'])}</h3>
        <p class="text-sm text-gray-600">${escapeHTML(shop['address_' + currentLang] || shop['address_zh-TW'])}</p>
        <div class="mt-2">
          ${(shop.tags || '').split(',').map(tagId => {
            const tagName = tagsMap[tagId.trim()];
            return tagName ? `<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${escapeHTML(tagName)}</span>` : '';
          }).join('')}
        </div>
      </div>
    `).join('');
  }

  function addMarkersToMap(shops) {
    shops.forEach(shop => {
      if (shop.lat && shop.lng) {
        const marker = L.marker([shop.lat, shop.lng]).addTo(map);
        marker.on('click', () => openShopModal(shop.id));
      }
    });
  }

  // ===== Modal Logic (with XSS protection) =====
  function openModal(modalId) { document.getElementById(modalId).classList.replace('hidden', 'flex'); }
  function closeModal(modalId) { document.getElementById(modalId).classList.replace('flex', 'hidden'); }

  function showMessageModal(message) {
      document.getElementById('message-modal-text').textContent = message; // .textContent is safe from XSS
      openModal('message-modal');
  }

  function openShopModal(shopId) {
    const shop = allShops.find(s => s.id === shopId);
    if (!shop) return;
    
    document.getElementById('modal-shop-name').textContent = shop['name_' + currentLang] || shop['name_zh-TW']; // Safe
    const contentElement = document.getElementById('modal-content');
    
    const tagsMap = allTags.reduce((acc, tag) => {
        acc[tag.id] = tag['name_' + currentLang] || tag['name_zh-TW'];
        return acc;
    }, {});

    contentElement.innerHTML = `
      <p class="text-gray-700 mb-4">${sanitizeAndFormat(shop['longDescription_' + currentLang] || shop['description_' + currentLang] || shop['longDescription_zh-TW'] || shop['description_zh-TW'])}</p>
      <div class="space-y-2 text-sm">
        <p><strong>地址:</strong> ${escapeHTML(shop['address_' + currentLang] || shop['address_zh-TW'])}</p>
        ${shop.phone ? `<p><strong>電話:</strong> ${escapeHTML(shop.phone)}</p>` : ''}
        ${shop.website ? `<p><strong>網站:</strong> <a href="${escapeHTML(shop.website)}" target="_blank" class="text-blue-600 hover:underline">${escapeHTML(shop.website)}</a></p>` : ''}
      </div>
      <div class="mt-4">
        <h4 class="font-semibold mb-2">標籤:</h4>
        <div class="flex flex-wrap gap-2">
          ${(shop.tags || '').split(',').map(tagId => {
            const tagName = tagsMap[tagId.trim()];
            return tagName ? `<span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">${escapeHTML(tagName)}</span>` : '';
          }).join('')}
        </div>
      </div>
    `;
    openModal('shop-modal');
  }

  // ===== Search Logic =====
  function handleSearch(e) {
    const query = e.target.value.trim();
    if (!query) {
      renderShopList(allShops);
      return;
    }
    const results = fuse.search(query);
    const filteredShops = results.map(result => result.item);
    renderShopList(filteredShops);
  }

    // ===== API Call Wrapper =====
    async function apiCall(action, payload = {}) {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST', mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, payload })
      });
      const result = await response.json();
      if (result.status === 'error') throw new Error(result.message);
      return result.data;
    }

    // ===== Feedback Submission =====
    async function handleFeedbackSubmit(e) {
      e.preventDefault();
      const email = document.getElementById('feedback-email').value.trim();
      const type = document.getElementById('feedback-type').value;
      const message = document.getElementById('feedback-message').value.trim();

      if (!message) { showMessageModal('請填寫詳細說明欄位'); return; }
      
      try {
        await apiCall('submitFeedback', { email, type, message });
        showMessageModal('感謝您的回饋，我們已收到您的訊息！');
        closeModal('feedback-modal');
        e.target.reset();
      } catch(err) {
        showMessageModal('提交失敗：' + err.message);
      }
    }
</script>
</body>
</html>
