<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">æ°¸çºŒå•†åº—åœ°åœ– - é¦–é </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f7f4; }
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover; background-position: center;
        }
        .tag { background-color: #dcfce7; color: #16a34a; }
        .tag.active { background-color: #16a34a; color: white; }
        .btn-primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); transition: all 0.3s ease; color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
        .shop-card { transition: all 0.3s ease; display: flex; flex-direction: column; }
        .shop-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .shop-card > div.p-6 { display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; }
        .shop-card button { margin-top: auto; }
        .shop-detail-header {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1551488831-00ddcb6c6bd3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover; background-position: center;
        }
        .modal { transition: opacity 0.3s ease; z-index: 100; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        #sustainability-map { width: 100%; height: 500px; min-height: 400px; z-index: 10; }
        .shop-map { position: relative; z-index: 5; }
        .favorite-btn { position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.8); border-radius: 50%; padding: 0.5rem; cursor: pointer; transition: transform 0.2s ease; }
        .favorite-btn:hover { transform: scale(1.1); }
        .favorite-btn svg { width: 1.5rem; height: 1.5rem; stroke: #4b5563; stroke-width: 1.5; fill: none; }
        .favorite-btn.favorited svg { fill: #ef4444; stroke: #ef4444; }
    </style>
</head>
<body>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-2xl font-bold text-gray-800" data-i18n="appName">æ°¸çºŒå•†åº—åœ°åœ–</span>
            </a>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#" class="text-gray-700 hover:text-green-600 transition" data-i18n="home">é¦–é </a>
                <a href="#map" class="text-gray-700 hover:text-green-600 transition" data-i18n="map">åœ°åœ–</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600 transition" data-i18n="shopList">å•†åº—åˆ—è¡¨</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600 transition" data-i18n="newsletter">è¨‚é–±é›»å­å ±</a>
                <a href="#report-issue" class="text-gray-700 hover:text-green-600 transition" data-i18n="reportIssueNavLink">å•é¡Œå›å ±</a>
                <select id="language-select" class="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full border border-green-200 hover:bg-green-200 transition cursor-pointer focus:outline-none">
                    <option value="zh-TW" data-i18n="langChinese">ç¹é«”ä¸­æ–‡</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                </select>
            </div>
            <div class="md:hidden flex items-center">
                 <select id="language-select-mobile" class="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full border border-green-200 mr-2 focus:outline-none">
                    <option value="zh-TW" data-i18n="langChinese">ç¹é«”ä¸­æ–‡</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                </select>
                <button id="menu-toggle" class="text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white">
            <a href="#" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="home">é¦–é </a>
            <a href="#map" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="map">åœ°åœ–</a>
            <a href="#shops" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="shopList">å•†åº—åˆ—è¡¨</a>
            <a href="#newsletter" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="newsletter">è¨‚é–±é›»å­å ±</a>
            <a href="#report-issue" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="reportIssueNavLink">å•é¡Œå›å ±</a>
        </div>
    </nav>

    <div id="announcement-bar" class="hidden bg-yellow-200 border-b-2 border-yellow-300 text-yellow-800 p-3 text-center">
        <p id="announcement-text" class="font-medium whitespace-pre-wrap"></p>
    </div>

    <section class="hero-section py-20 md:py-32 text-white">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">æ¢ç´¢å°ç£æ°¸çºŒå•†åº—</h1>
            <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">æ‰¾åˆ°æ”¯æŒç’°ä¿ã€å…¬å¹³è²¿æ˜“å’Œæ°¸çºŒç™¼å±•çš„å•†åº—ï¼Œä¸€èµ·ç‚ºåœ°çƒç›¡ä¸€ä»½å¿ƒåŠ›</p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <a href="#map" class="btn-primary px-8 py-3 rounded-lg font-medium" data-i18n="viewMapBtn">æŸ¥çœ‹åœ°åœ–</a>
                <a href="#shops" class="bg-white text-green-600 px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="browseShopsBtn">ç€è¦½å•†åº—åˆ—è¡¨</a>
            </div>
        </div>
    </section>
    
    <section class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto"><div class="bg-white rounded-xl shadow-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">æœå°‹æ°¸çºŒå•†åº—</h2>
                    <div class="flex">
                        <input type="text" id="search-input" placeholder="" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500" data-i18n-placeholder="searchPlaceholder">
                        <button id="search-button" class="btn-primary px-6 py-3 rounded-r-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></button>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium mb-3" data-i18n="filterCategoryTitle">ä¾é¡åˆ¥ç¯©é¸</h3>
                    <div class="flex flex-wrap gap-2" id="filter-buttons-container">
                        <button class="tag px-3 py-1 rounded-full text-sm active" data-category="" data-i18n="filterAll">å…¨éƒ¨</button>
                        <button class="tag px-3 py-1 rounded-full text-sm" data-category="favorites" data-i18n="filterFavorites">â¤ï¸ æˆ‘çš„æ”¶è—</button>
                    </div>
                </div>
            </div></div>
        </div>
    </section>

    <section id="map" class="py-12 bg-green-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">æ°¸çºŒå•†åº—åœ°åœ–</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden"><div id="sustainability-map"></div></div>
        </div>
    </section>

    <section id="shops" class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">æ°¸çºŒå•†åº—åˆ—è¡¨</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="shop-cards-container"></div>
            <div class="text-center mt-8">
                <button id="load-more-button" class="btn-primary px-8 py-3 rounded-lg font-medium hidden" data-i18n="loadMoreBtn">è¼‰å…¥æ›´å¤š</button>
            </div>
        </div>
    </section>

    <section id="newsletter" class="py-12 bg-green-600 text-white">
        <div class="container mx-auto px-4"><div class="max-w-2xl mx-auto text-center">
            <h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">è¨‚é–±æ°¸çºŒç”Ÿæ´»é›»å­å ±</h2>
            <p class="mb-6" data-i18n="newsletterSubtitle">ç²å–æœ€æ–°çš„æ°¸çºŒå•†åº—è³‡è¨Šã€ç’°ä¿ç”Ÿæ´»æŠ€å·§å’Œç‰¹åˆ¥å„ªæƒ </p>
            <form id="newsletter-form" class="flex flex-col md:flex-row gap-2">
                <input type="email" id="newsletter-email" placeholder="" class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none" data-i18n-placeholder="newsletterPlaceholder" required>
                <button id="subscribe-button" type="submit" class="bg-white text-green-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="subscribeBtn">è¨‚é–±</button>
            </form>
        </div></div>
    </section>

    <section id="report-issue" class="py-12 bg-yellow-50">
        <div class="container mx-auto px-4"><div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold text-center mb-6" data-i18n="reportIssueTitle">å•é¡Œå›å ±</h2>
            <form id="issue-form">
                <div class="mb-4">
                    <label for="feedbackEmail" class="block text-gray-700 text-sm font-bold mb-2" data-i18n="modalEmail">æ‚¨çš„ Email</label>
                    <input type="email" id="feedbackEmail" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="feedbackType" class="block text-gray-700 text-sm font-bold mb-2" data-i18n="reportIssueType">å•é¡Œé¡å‹</label>
                    <select id="feedbackType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        <option value="" data-i18n="reportIssueSelectType">è«‹é¸æ“‡...</option>
                        <option value="data_error" data-i18n="reportIssueDataError">åº—å®¶è³‡è¨ŠéŒ¯èª¤</option>
                        <option value="feature_request" data-i18n="reportIssueFeatureRequest">åŠŸèƒ½å»ºè­°</option>
                        <option value="bug_report" data-i18n="reportIssueBugReport">ç³»çµ±å•é¡Œ</option>
                        <option value="other" data-i18n="reportIssueOther">å…¶ä»–</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="issue" class="block text-gray-700 text-sm font-bold mb-2" data-i18n="reportIssueLabel">è«‹æè¿°æ‚¨é‡åˆ°çš„å•é¡Œï¼š</label>
                    <textarea id="issue" name="issue" rows="4" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" data-i18n-placeholder="reportIssuePlaceholder"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn-primary px-6 py-2 rounded-lg font-medium" data-i18n="reportIssueSubmitBtn">é€å‡ºå›å ±</button>
                </div>
            </form>
        </div></div>
    </section>
    
    <footer class="bg-gray-800 text-white py-10">
        <div class="container mx-auto px-4">
            <div class="text-center mb-6">
                <button id="showPolicyFooter" class="hover:text-green-400 transition" data-i18n="privacyPolicy">éš±ç§æ¬Šæ”¿ç­–</button>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p data-i18n="copyright">Â© 2025 æ°¸çºŒå•†åº—åœ°åœ– - ç‰ˆæ¬Šæ‰€æœ‰</p>
            </div>
        </div>
    </footer>
    
    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden items-center justify-center modal p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full mx-4 modal-content"><div id="shop-detail-content" class="relative"></div></div>
    </div>
    
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg hidden opacity-0 transition-opacity duration-300 z-[2000]"></div>
    
    <div id="policy-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden items-center justify-center modal p-4">
        <div class="bg-white rounded-xl max-w-3xl w-full mx-4 modal-content">
             <div class="p-6 relative">
                 <button id="close-policy-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                 <h2 class="text-2xl font-bold mb-4" data-i18n="privacyPolicy"></h2>
                 <div id="policy-content" class="prose max-w-none text-gray-700"></div>
             </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ===== CONFIGURATION =====
    const API_URL = 'https://script.google.com/macros/s/AKfycbyJ76tpxJ2eeRRqcv3qUqx3Z8nWLqrNsAIxgMR5vnkfmJOXulhhu1Av2T9w4AzDLg83gA/exec';
    
    // ===== GLOBAL STATE & VARIABLES =====
    let allShops = [];
    let policies = {};
    let currentFilterCategory = '';
    let currentSearchQuery = '';
    const shopsPerPage = 6;
    let currentLoadedShops = 0;
    let mapInstance;
    let markersGroup = L.featureGroup();
    let favoriteShops = JSON.parse(localStorage.getItem('favoriteShops')) || [];
    let currentLang = localStorage.getItem('lang') || 'zh-TW';

    const translations = {
        'zh-TW': {
            pageTitle: 'æ°¸çºŒå•†åº—åœ°åœ– - é¦–é ', appName: 'æ°¸çºŒå•†åº—åœ°åœ–', home: 'é¦–é ', map: 'åœ°åœ–', shopList: 'å•†åº—åˆ—è¡¨',
            newsletter: 'è¨‚é–±é›»å­å ±', reportIssueNavLink: 'å•é¡Œå›å ±', langChinese: 'ç¹é«”ä¸­æ–‡', langEnglish: 'English',
            heroTitle: 'æ¢ç´¢å°ç£æ°¸çºŒå•†åº—', heroSubtitle: 'æ‰¾åˆ°æ”¯æŒç’°ä¿ã€å…¬å¹³è²¿æ˜“å’Œæ°¸çºŒç™¼å±•çš„å•†åº—ï¼Œä¸€èµ·ç‚ºåœ°çƒç›¡ä¸€ä»½å¿ƒåŠ›',
            viewMapBtn: 'æŸ¥çœ‹åœ°åœ–', browseShopsBtn: 'ç€è¦½å•†åº—åˆ—è¡¨', searchTitle: 'æœå°‹æ°¸çºŒå•†åº—', searchPlaceholder: 'è¼¸å…¥å•†åº—åç¨±æˆ–åœ°å€...',
            filterCategoryTitle: 'ä¾é¡åˆ¥ç¯©é¸', filterAll: 'å…¨éƒ¨', filterFavorites: 'â¤ï¸ æˆ‘çš„æ”¶è—',
            mapSectionTitle: 'æ°¸çºŒå•†åº—åœ°åœ–', shopListSectionTitle: 'æ°¸çºŒå•†åº—åˆ—è¡¨', viewDetailsBtn: 'æŸ¥çœ‹è©³æƒ…', loadMoreBtn: 'è¼‰å…¥æ›´å¤š',
            newsletterTitle: 'è¨‚é–±æ°¸çºŒç”Ÿæ´»é›»å­å ±', newsletterSubtitle: 'ç²å–æœ€æ–°çš„æ°¸çºŒå•†åº—è³‡è¨Šã€ç’°ä¿ç”Ÿæ´»æŠ€å·§å’Œç‰¹åˆ¥å„ªæƒ ',
            newsletterPlaceholder: 'æ‚¨çš„é›»å­éƒµä»¶', subscribeBtn: 'è¨‚é–±', reportIssueTitle: 'å•é¡Œå›å ±', reportIssueLabel: 'è«‹æè¿°æ‚¨é‡åˆ°çš„å•é¡Œï¼š',
            reportIssuePlaceholder: 'ä¾‹å¦‚ï¼šæŸé–“å•†åº—è³‡è¨ŠéŒ¯èª¤ã€åœ°åœ–ä½ç½®æœ‰èª¤...', reportIssueSubmitBtn: 'é€å‡ºå›å ±',
            copyright: 'Â© 2025 æ°¸çºŒå•†åº—åœ°åœ– - ç‰ˆæ¬Šæ‰€æœ‰', modalAddress: 'åœ°å€', modalPhone: 'é›»è©±', modalEmail: 'æ‚¨çš„ Email',
            modalWebsite: 'ç¶²ç«™', notProvided: 'æœªæä¾›', newsletterSuccess: 'æ„Ÿè¬æ‚¨çš„è¨‚é–±ï¼', newsletterError: 'è¨‚é–±å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
            reportIssueSuccess: 'æ„Ÿè¬æ‚¨çš„å›å ±ï¼', reportIssueError: 'å›å ±å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', privacyPolicy: 'éš±ç§æ¬Šæ”¿ç­–èˆ‡è²æ˜',
            reportIssueType: 'å•é¡Œé¡å‹', reportIssueSelectType: 'è«‹é¸æ“‡...', reportIssueDataError: 'åº—å®¶è³‡è¨ŠéŒ¯èª¤',
            reportIssueFeatureRequest: 'åŠŸèƒ½å»ºè­°', reportIssueBugReport: 'ç³»çµ±å•é¡Œ', reportIssueOther: 'å…¶ä»–'
        },
        'en': {
            pageTitle: 'Sustainable Store Map - Home', appName: 'Sustainable Store Map', home: 'Home', map: 'Map', shopList: 'Shop List',
            newsletter: 'Newsletter', reportIssueNavLink: 'Report Issue', langChinese: 'ç¹é«”ä¸­æ–‡', langEnglish: 'English',
            heroTitle: 'Explore Taiwan\'s Sustainable Stores', heroSubtitle: 'Find stores that support environmental protection, fair trade, and sustainable development.',
            viewMapBtn: 'View Map', browseShopsBtn: 'Browse Shops', searchTitle: 'Search Sustainable Stores', searchPlaceholder: 'Enter store name or address...',
            filterCategoryTitle: 'Filter by Category', filterAll: 'All', filterFavorites: 'â¤ï¸ My Favorites',
            mapSectionTitle: 'Sustainable Store Map', shopListSectionTitle: 'Sustainable Shop List', viewDetailsBtn: 'View Details', loadMoreBtn: 'Load More',
            newsletterTitle: 'Subscribe to Our Newsletter', newsletterSubtitle: 'Get the latest on sustainable stores, eco-tips, and special offers.',
            newsletterPlaceholder: 'Your email address', subscribeBtn: 'Subscribe', reportIssueTitle: 'Report an Issue', reportIssueLabel: 'Please describe the issue:',
            reportIssuePlaceholder: 'e.g., Incorrect store info, wrong map location...', reportIssueSubmitBtn: 'Submit Report',
            copyright: 'Â© 2025 Sustainable Store Map - All Rights Reserved', modalAddress: 'Address', modalPhone: 'Phone', modalEmail: 'Your Email',
            modalWebsite: 'Website', notProvided: 'Not provided', newsletterSuccess: 'Thanks for subscribing!', newsletterError: 'Subscription failed. Please try again.',
            reportIssueSuccess: 'Thanks for your feedback!', reportIssueError: 'Failed to submit. Please try again.', privacyPolicy: 'Privacy Policy & Disclaimer',
            reportIssueType: 'Issue Type', reportIssueSelectType: 'Please select...', reportIssueDataError: 'Incorrect Store Info',
            reportIssueFeatureRequest: 'Feature Suggestion', reportIssueBugReport: 'System Bug', reportIssueOther: 'Other'
        }
    };
    
    // ===== UTILITY FUNCTIONS =====
    const showToast = (message) => {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('opacity-100');
        setTimeout(() => {
            toast.classList.remove('opacity-100');
            setTimeout(() => toast.classList.add('hidden'), 300);
        }, 3000);
    };

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('lang', lang);
        document.documentElement.lang = lang.split('-')[0];
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            el.textContent = translations[lang][key] || translations['zh-TW'][key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            el.placeholder = translations[lang][key] || translations['zh-TW'][key];
        });

        document.getElementById('language-select').value = lang;
        document.getElementById('language-select-mobile').value = lang;

        currentLoadedShops = 0; // Reset for re-render
        filterAndDisplayShops();
        
        // Re-render modal if open
        const modal = document.getElementById('shop-detail-modal');
        if (!modal.classList.contains('hidden')) {
            const shopId = modal.dataset.shopId;
            if (shopId) showShopDetail(shopId);
        }
    };
    
    // ===== DATA FETCHING =====
    async function fetchPublicData() {
        try {
            const response = await fetch(`${API_URL}?action=getPublicData`);
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            
            allShops = result.data.shops;
            policies = result.data.policies;
            
            const announcementText = result.data.announcements;
            if (announcementText && announcementText.trim() !== '') {
                document.getElementById('announcement-text').textContent = announcementText;
                document.getElementById('announcement-bar').classList.remove('hidden');
            }
            
            populateFilters();
            filterAndDisplayShops();
        } catch (error) {
            console.error("Failed to fetch data:", error);
            showToast('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
    }

    // ===== UI RENDERING & FILTERING =====
    const populateFilters = () => {
        const types = [...new Set(allShops.map(s => s[`type_${currentLang}`] || s['type_zh-TW']).filter(Boolean))];
        const container = document.getElementById('filter-buttons-container');
        // Clear existing type filters, keep "All" and "Favorites"
        container.querySelectorAll('.tag:not([data-category=""]):not([data-category="favorites"])').forEach(btn => btn.remove());
        
        types.forEach(type => {
            const btn = document.createElement('button');
            btn.className = 'tag px-3 py-1 rounded-full text-sm';
            btn.dataset.category = type;
            btn.textContent = type;
            container.appendChild(btn);
        });
    };

    const getFilteredShops = () => {
        return allShops.filter(shop => {
            if (currentFilterCategory === 'favorites') {
                if (!favoriteShops.includes(shop.id)) return false;
            } else if (currentFilterCategory) {
                const shopType = shop[`type_${currentLang}`] || shop['type_zh-TW'];
                if (shopType !== currentFilterCategory) return false;
            }

            if (currentSearchQuery) {
                const name = shop[`name_${currentLang}`] || shop['name_zh-TW'] || '';
                const address = shop[`address_${currentLang}`] || shop['address_zh-TW'] || '';
                if (!name.toLowerCase().includes(currentSearchQuery) && !address.toLowerCase().includes(currentSearchQuery)) {
                    return false;
                }
            }
            return true;
        });
    };
    
    const renderShopCards = (filteredShops) => {
        const container = document.getElementById('shop-cards-container');
        if (currentLoadedShops === 0) container.innerHTML = '';

        const shopsToDisplay = filteredShops.slice(currentLoadedShops, currentLoadedShops + shopsPerPage);
        shopsToDisplay.forEach(shop => {
            const isFavorited = favoriteShops.includes(shop.id);
            const name = shop[`name_${currentLang}`] || shop['name_zh-TW'];
            const type = shop[`type_${currentLang}`] || shop['type_zh-TW'];
            const description = shop[`description_${currentLang}`] || shop['description_zh-TW'];
            const address = shop[`address_${currentLang}`] || shop['address_zh-TW'];

            const cardHTML = `
                <div class="shop-card bg-white rounded-xl overflow-hidden shadow-md">
                    <div class="h-48 bg-green-100 flex items-center justify-center relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-shop-id="${shop.id}">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                    </div>
                    <div class="p-6">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold">${name}</h3>
                                <span class="tag px-2 py-1 rounded-full text-xs">${type}</span>
                            </div>
                            <p class="text-gray-600 mb-4 h-20 overflow-hidden">${description}</p>
                            <div class="text-gray-600 text-sm mb-4">
                                <p class="truncate">ğŸ“ ${address}</p>
                            </div>
                        </div>
                        <button class="block w-full text-center py-2 btn-primary rounded-lg font-medium" data-shop-id="${shop.id}" data-action="view-details" data-i18n="viewDetailsBtn"></button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', cardHTML);
        });
        currentLoadedShops += shopsToDisplay.length;
        updateLoadMoreButton(filteredShops.length);
        setLanguage(currentLang); // Re-apply translations for new elements
    };

    const updateMapMarkers = (filteredShops) => {
        if (!mapInstance) return;
        markersGroup.clearLayers();
        filteredShops.forEach(shop => {
            if (shop.lat && shop.lng) {
                const name = shop[`name_${currentLang}`] || shop['name_zh-TW'];
                const marker = L.marker([shop.lat, shop.lng]);
                marker.bindPopup(`<b>${name}</b><br><button class="text-green-600 hover:underline" data-action="view-details" data-shop-id="${shop.id}">${translations[currentLang].viewDetailsBtn}</button>`);
                markersGroup.addLayer(marker);
            }
        });
        mapInstance.addLayer(markersGroup);
    };
    
    const updateLoadMoreButton = (total) => {
        const btn = document.getElementById('load-more-button');
        btn.classList.toggle('hidden', currentLoadedShops >= total);
    };
    
    const filterAndDisplayShops = () => {
        const filtered = getFilteredShops();
        renderShopCards(filtered);
        updateMapMarkers(filtered);
    };

    const showShopDetail = (shopId) => {
        const shop = allShops.find(s => s.id === shopId);
        if (!shop) return;
        
        const lang = currentLang;
        const name = shop[`name_${lang}`] || shop['name_zh-TW'];
        const type = shop[`type_${lang}`] || shop['type_zh-TW'];
        const longDesc = shop[`longDescription_${lang}`] || shop['longDescription_zh-TW'] || (shop[`description_${lang}`] || shop['description_zh-TW']);
        const address = shop[`address_${lang}`] || shop['address_zh-TW'];
        const website = shop.website ? `<p>${translations[lang].modalWebsite}: <a href="${shop.website.startsWith('http') ? '' : '//'}${shop.website}" target="_blank" class="text-green-600 hover:underline">${shop.website}</a></p>` : '';

        const detailHTML = `
            <div class="shop-detail-header py-12 text-white rounded-t-xl text-center">
                <h1 class="text-3xl font-bold mb-2">${name}</h1>
                <p class="text-lg">${type}</p>
            </div>
            <button id="close-modal-btn" class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <div class="p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <p class="text-gray-700 mb-6">${longDesc}</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl">
                        <div class="space-y-4 text-gray-700">
                            <p><strong>${translations[lang].modalAddress}:</strong> ${address || translations[lang].notProvided}</p>
                            <p><strong>${translations[lang].modalPhone}:</strong> ${shop.phone || translations[lang].notProvided}</p>
                            ${website}
                        </div>
                        <div class="mt-6 h-64 rounded-lg overflow-hidden shop-map"><div id="shop-map-modal" class="h-full w-full"></div></div>
                    </div>
                </div>
            </div>`;
        document.getElementById('shop-detail-content').innerHTML = detailHTML;
        const modal = document.getElementById('shop-detail-modal');
        modal.dataset.shopId = shopId;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';

        setTimeout(() => {
            const shopMap = L.map('shop-map-modal').setView([shop.lat, shop.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(shopMap);
            L.marker([shop.lat, shop.lng]).addTo(shopMap);
        }, 100);
    };
    
    // ===== INITIALIZATION & EVENT LISTENERS =====
    const initMap = () => {
        mapInstance = L.map('sustainability-map').setView([25.0330, 121.5654], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
        mapInstance.addLayer(markersGroup);
    };

    const setupEventListeners = () => {
        document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));
        document.getElementById('language-select').addEventListener('change', (e) => setLanguage(e.target.value));
        document.getElementById('language-select-mobile').addEventListener('change', (e) => setLanguage(e.target.value));
        
        const performSearch = () => {
            currentSearchQuery = document.getElementById('search-input').value.trim().toLowerCase();
            currentLoadedShops = 0;
            filterAndDisplayShops();
        };
        document.getElementById('search-button').addEventListener('click', performSearch);
        document.getElementById('search-input').addEventListener('keypress', (e) => e.key === 'Enter' && performSearch());
        
        document.getElementById('filter-buttons-container').addEventListener('click', (e) => {
            const btn = e.target.closest('.tag');
            if (!btn) return;
            document.querySelectorAll('#filter-buttons-container .tag').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilterCategory = btn.dataset.category;
            currentLoadedShops = 0;
            filterAndDisplayShops();
        });

        document.getElementById('load-more-button').addEventListener('click', () => filterAndDisplayShops());

        document.body.addEventListener('click', e => {
            const target = e.target.closest('[data-action="view-details"]');
            if (target) showShopDetail(target.dataset.shopId);
            
            if (e.target.closest('#close-modal-btn') || e.target.id === 'shop-detail-modal') {
                const modal = document.getElementById('shop-detail-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = 'auto';
            }
            if (e.target.closest('.favorite-btn')) {
                const btn = e.target.closest('.favorite-btn');
                toggleFavorite(btn.dataset.shopId, btn);
            }
            if (e.target.closest('#close-policy-modal') || e.target.id === 'policy-modal') {
                document.getElementById('policy-modal').classList.add('hidden');
            }
        });

        const toggleFavorite = (shopId, btnElement) => {
            const index = favoriteShops.indexOf(shopId);
            if (index > -1) favoriteShops.splice(index, 1);
            else favoriteShops.push(shopId);
            
            localStorage.setItem('favoriteShops', JSON.stringify(favoriteShops));
            btnElement.classList.toggle('favorited');
            
            if (currentFilterCategory === 'favorites') {
                currentLoadedShops = 0;
                filterAndDisplayShops();
            }
        };

        const submitApiForm = async (form, action, successKey, errorKey) => {
            const formData = new FormData(form);
            const payload = { action: action, payload: Object.fromEntries(formData.entries()) };
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'text/plain;charset=utf-8'} });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                showToast(translations[currentLang][successKey]);
                form.reset();
            } catch (error) {
                showToast(translations[currentLang][errorKey] + ` (${error.message})`);
            } finally {
                submitButton.disabled = false;
            }
        };

        document.getElementById('newsletter-form').addEventListener('submit', e => {
            e.preventDefault();
            submitApiForm(e.target, 'subscribe', 'newsletterSuccess', 'newsletterError');
        });
        document.getElementById('issue-form').addEventListener('submit', e => {
            e.preventDefault();
            submitApiForm(e.target, 'submitFeedback', 'reportIssueSuccess', 'reportIssueError');
        });
        
        const showPolicy = () => {
             document.getElementById('policy-content').innerHTML = `
                <h3 class="font-bold text-lg mb-2">éš±ç§æ¬Šæ”¿ç­–</h3>
                <div class="p-2 bg-gray-100 rounded">${(policies.privacy || '').replace(/\n/g, '<br>')}</div>
                <h3 class="font-bold text-lg mt-4 mb-2">å…è²¬è²æ˜</h3>
                <div class="p-2 bg-gray-100 rounded">${(policies.disclaimer || '').replace(/\n/g, '<br>')}</div>
            `;
            document.getElementById('policy-modal').classList.remove('hidden');
        };
        document.getElementById('showPolicyFooter').addEventListener('click', showPolicy);

    };
    
    // --- APP START ---
    initMap();
    setupEventListeners();
    fetchPublicData();
    setLanguage(currentLang);
});
</script>
</body>
</html>

