<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">æ°¸çºŒå•†åº—åœ°åœ– - é¦–é </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f7f4;
        }
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
        }
        .tag {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .tag.active {
            background-color: #16a34a;
            color: white;
        }
        .btn-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            transition: all 0.3s ease;
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        .shop-card {
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .shop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .shop-card > div.p-6 {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-grow: 1;
        }
        .shop-card button {
            margin-top: auto;
        }
        .shop-detail-header {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1551488831-00ddcb6c6bd3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            max-width: 100%;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .map-container {
            position: relative;
            z-index: 10;
            overflow: hidden;
        }
        .leaflet-control-container {
            z-index: 10;
        }
        .modal {
            z-index: 100;
        }
        .shop-map {
            position: relative;
            z-index: 5;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #34d399;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .admin-mode {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            z-index: 1000;
            font-size: 14px;
        }
        .admin-button {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .admin-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        /* Ensure map container has proper dimensions */
        #sustainability-map {
            width: 100%;
            height: 500px;
            min-height: 400px;
        }
        .leaflet-container {
            font-family: 'Noto Sans TC', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Admin Mode Indicator (Hidden by default) -->
    <div id="admin-indicator" class="admin-mode hidden">ç®¡ç†å“¡æ¨¡å¼</div>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <a href="#" id="app-title" class="text-2xl font-bold text-gray-800" data-i18n="appName">æ°¸çºŒå•†åº—åœ°åœ–</a>
            </div>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#" class="text-gray-700 hover:text-green-600 transition" data-i18n="home">é¦–é </a>
                <a href="#map" class="text-gray-700 hover:text-green-600 transition" data-i18n="map">åœ°åœ–</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600 transition" data-i18n="shopList">å•†åº—åˆ—è¡¨</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600 transition" data-i18n="newsletter">è¨‚é–±é›»å­å ±</a>
                <a href="#report-issue" class="text-gray-700 hover:text-green-600 transition" data-i18n="reportIssueNavLink">å•é¡Œå›å ±</a>
                <select id="language-select" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition cursor-pointer">
                    <option value="zh-TW" data-i18n="langChinese">ç¹é«”ä¸­æ–‡</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                    <option value="fr" data-i18n="langFrench">FranÃ§ais</option>
                    <option value="de" data-i18n="langGerman">Deutsch</option>
                    <option value="es" data-i18n="langSpanish">EspaÃ±ol</option>
                    <option value="la" data-i18n="langLatin">Latin</option>
                    <option value="ja" data-i18n="langJapanese">æ—¥æœ¬èª</option>
                </select>
            </div>
            <div class="md:hidden flex items-center">
                <select id="language-select-mobile" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition cursor-pointer mr-2">
                    <option value="zh-TW" data-i18n="langChinese">ç¹é«”ä¸­æ–‡</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                    <option value="fr" data-i18n="langFrench">FranÃ§ais</option>
                    <option value="de" data-i18n="langGerman">Deutsch</option>
                    <option value="es" data-i18n="langSpanish">EspaÃ±ol</option>
                    <option value="la" data-i18n="langLatin">Latin</option>
                    <option value="ja" data-i18n="langJapanese">æ—¥æœ¬èª</option>
                </select>
                <button id="menu-toggle" class="text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white">
            <a href="#" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="home">é¦–é </a>
            <a href="#map" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="map">åœ°åœ–</a>
            <a href="#shops" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="shopList">å•†åº—åˆ—è¡¨</a>
            <a href="#newsletter" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="newsletter">è¨‚é–±é›»å­å ±</a>
            <a href="#report-issue" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="reportIssueNavLink">å•é¡Œå›å ±</a>
        </div>
    </nav>

    <section class="hero-section py-20 md:py-32 text-white">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">æ¢ç´¢å°ç£æ°¸çºŒå•†åº—</h1>
            <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">æ‰¾åˆ°æ”¯æŒç’°ä¿ã€å…¬å¹³è²¿æ˜“å’Œæ°¸çºŒç™¼å±•çš„å•†åº—ï¼Œä¸€èµ·ç‚ºåœ°çƒç›¡ä¸€ä»½å¿ƒåŠ›</p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <a href="#map" class="btn-primary px-8 py-3 rounded-lg font-medium" data-i18n="viewMapBtn">æŸ¥çœ‹åœ°åœ–</a>
                <a href="#shops" class="bg-white text-green-600 px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="browseShopsBtn">ç€è¦½å•†åº—åˆ—è¡¨</a>
            </div>
        </div>
    </section>

    <section class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">æœå°‹æ°¸çºŒå•†åº—</h2>
                        <div class="flex">
                            <input type="text" id="search-input" placeholder="" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" data-i18n="searchPlaceholder">
                            <button id="search-button" class="btn-primary px-6 py-3 rounded-r-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium mb-3" data-i18n="filterCategoryTitle">ä¾é¡åˆ¥ç¯©é¸</h3>
                        <div class="flex flex-wrap gap-2" id="filter-buttons-container">
                            <button class="tag px-3 py-1 rounded-full text-sm active" data-i18n="filterAll" data-category="all">å…¨éƒ¨</button>
                            <!-- Filter buttons will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="map" class="py-12 bg-green-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">æ°¸çºŒå•†åº—åœ°åœ–</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="map-container">
                    <div id="sustainability-map" class="h-96 md:h-[500px] w-full"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="shops" class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">æ°¸çºŒå•†åº—åˆ—è¡¨</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="shop-cards-container">
                <!-- Shop cards will be injected here -->
            </div>
            <div class="text-center mt-8">
                <button id="load-more-button" class="btn-primary px-8 py-3 rounded-lg font-medium hidden" data-i18n="loadMoreBtn">è¼‰å…¥æ›´å¤š</button>
            </div>
        </div>
    </section>

    <section id="newsletter" class="py-12 bg-green-600 text-white">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto text-center">
                <h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">è¨‚é–±æ°¸çºŒç”Ÿæ´»é›»å­å ±</h2>
                <p class="mb-6" data-i18n="newsletterSubtitle">ç²å–æœ€æ–°çš„æ°¸çºŒå•†åº—è³‡è¨Šã€ç’°ä¿ç”Ÿæ´»æŠ€å·§å’Œç‰¹åˆ¥å„ªæƒ </p>
                <div class="flex flex-col md:flex-row gap-2">
                    <input type="email" id="newsletter-email" placeholder="" class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none" data-i18n="newsletterPlaceholder">
                    <button id="subscribe-button" class="bg-white text-green-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="subscribeBtn">è¨‚é–±</button>
                </div>
            </div>
        </div>
    </section>

    <section id="report-issue" class="py-12 bg-yellow-50">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-3xl font-bold text-center mb-6" data-i18n="reportIssueTitle">å•é¡Œå›å ±</h2>
                <form id="issue-form">
                    <div class="mb-4">
                        <label for="issue" class="block text-gray-700 text-sm font-bold mb-2" data-i18n="reportIssueLabel">è«‹æè¿°æ‚¨é‡åˆ°çš„å•é¡Œï¼š</label>
                        <textarea id="issue" name="issue" rows="6" required
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                  data-i18n="reportIssuePlaceholder"
                                  placeholder="ä¾‹å¦‚ï¼šæŸé–“å•†åº—è³‡è¨ŠéŒ¯èª¤ã€åœ°åœ–ä½ç½®æœ‰èª¤..."></textarea>
                    </div>
                    <div class="text-center">
                        <button type="submit"
                                class="btn-primary px-6 py-2 rounded-lg font-medium"
                                data-i18n="reportIssueSubmitBtn">
                            é€å‡ºå›å ±
                        </button>
                    </div>
                </form>
                <p id="issue-message" class="text-center text-green-600 mt-4 hidden" data-i18n="reportIssueSuccessMsg">æ„Ÿè¬æ‚¨çš„å›å ±ï¼Œæˆ‘å€‘æœƒå„˜å¿«è™•ç†ï¼</p>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-10">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="footerAppName">æ°¸çºŒå•†åº—åœ°åœ–</h3>
                    <p class="text-gray-300" data-i18n="footerAppDescription">å¹«åŠ©æ¶ˆè²»è€…æ‰¾åˆ°ä¸¦æ”¯æŒæ°¸çºŒç™¼å±•çš„å•†åº—ï¼Œä¸€èµ·ç‚ºåœ°çƒç›¡ä¸€ä»½å¿ƒåŠ›ã€‚</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="contactUsTitle">è¯çµ¡æˆ‘å€‘</h3>
                    <p class="text-gray-300" data-i18n="contactUsText">æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿èˆ‡æˆ‘å€‘è¯ç¹«</p>
                    <p class="text-gray-300" data-i18n="contactUsEmail">é›»å­éƒµä»¶ï¼šartistworld0815@gmail.com</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="followUsTitle">é—œæ³¨æˆ‘å€‘</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p data-i18n="copyright">Â© 2025 æ°¸çºŒå•†åº—åœ°åœ– - ç‰ˆæ¬Šæ‰€æœ‰</p>
            </div>
        </div>
    </footer>

    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center modal">
        <div class="bg-white rounded-xl max-w-4xl w-full mx-4 modal-content">
            <div id="shop-detail-content" class="relative">
                <!-- Shop detail content will be injected here -->
            </div>
        </div>
    </div>

    <div id="custom-message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto text-center">
            <p id="message-modal-text" class="text-gray-800 text-lg mb-4"></p>
            <button id="close-message-modal" class="btn-primary px-6 py-2 rounded-lg font-medium" data-i18n="okButton">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJO4SpEbNly7WweAHf0pGu8DGdwCqUrmvLBb29xujm3u2FgPo8Bb-A3y324e_fmnWRcA/exec';
        const ADMIN_PASSWORD = 'index@1215312836';
        
        // EmailJS Configuration
        const EMAILJS_PUBLIC_KEY = '4dCp-T-DcTtjFzpuA';
        const EMAILJS_SERVICE_ID = 'service_1o6wdpm';
        const EMAILJS_TEMPLATE_ID = 'template_ibn7ezs';

        // Initialize EmailJS
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        }

        // ===== GLOBAL STATE =====
        let isAdminMode = false;
        let currentLang = localStorage.getItem('lang') || 'zh-TW';
        let shopDetails = {}; // Will be fetched from backend
        let shops = []; // Will be derived from shopDetails
        let currentFilterCategory = 'all';
        let currentSearchQuery = '';
        const shopsPerPage = 6;
        let currentLoadedShops = 0;
        let mapInstance;
        let markersGroup = L.featureGroup();
        
        const translations = {
            'zh-TW': {
                pageTitle: 'æ°¸çºŒå•†åº—åœ°åœ– - é¦–é ',
                appName: 'æ°¸çºŒå•†åº—åœ°åœ–',
                home: 'é¦–é ',
                map: 'åœ°åœ–',
                shopList: 'å•†åº—åˆ—è¡¨',
                newsletter: 'è¨‚é–±é›»å­å ±',
                reportIssueNavLink: 'å•é¡Œå›å ±',
                langChinese: 'ç¹é«”ä¸­æ–‡',
                langEnglish: 'English',
                langFrench: 'FranÃ§ais',
                langGerman: 'Deutsch',
                langSpanish: 'EspaÃ±ol',
                langLatin: 'Latin',
                langJapanese: 'æ—¥æœ¬èª',
                heroTitle: 'æ¢ç´¢å°ç£æ°¸çºŒå•†åº—',
                heroSubtitle: 'æ‰¾åˆ°æ”¯æŒç’°ä¿ã€å…¬å¹³è²¿æ˜“å’Œæ°¸çºŒç™¼å±•çš„å•†åº—ï¼Œä¸€èµ·ç‚ºåœ°çƒç›¡ä¸€ä»½å¿ƒåŠ›',
                viewMapBtn: 'æŸ¥çœ‹åœ°åœ–',
                browseShopsBtn: 'ç€è¦½å•†åº—åˆ—è¡¨',
                searchTitle: 'æœå°‹æ°¸çºŒå•†åº—',
                searchPlaceholder: 'è¼¸å…¥å•†åº—åç¨±æˆ–åœ°å€...',
                filterCategoryTitle: 'ä¾é¡åˆ¥ç¯©é¸',
                filterAll: 'å…¨éƒ¨',
                mapSectionTitle: 'æ°¸çºŒå•†åº—åœ°åœ–',
                shopListSectionTitle: 'æ°¸çºŒå•†åº—åˆ—è¡¨',
                viewDetailsBtn: 'æŸ¥çœ‹è©³æƒ…',
                loadMoreBtn: 'è¼‰å…¥æ›´å¤š',
                newsletterTitle: 'è¨‚é–±æ°¸çºŒç”Ÿæ´»é›»å­å ±',
                newsletterSubtitle: 'ç²å–æœ€æ–°çš„æ°¸çºŒå•†åº—è³‡è¨Šã€ç’°ä¿ç”Ÿæ´»æŠ€å·§å’Œç‰¹åˆ¥å„ªæƒ ',
                newsletterPlaceholder: 'æ‚¨çš„é›»å­éƒµä»¶',
                subscribeBtn: 'è¨‚é–±',
                reportIssueTitle: 'å•é¡Œå›å ±',
                reportIssueLabel: 'è«‹æè¿°æ‚¨é‡åˆ°çš„å•é¡Œï¼š',
                reportIssuePlaceholder: 'ä¾‹å¦‚ï¼šæŸé–“å•†åº—è³‡è¨ŠéŒ¯èª¤ã€åœ°åœ–ä½ç½®æœ‰èª¤...',
                reportIssueSubmitBtn: 'é€å‡ºå›å ±',
                reportIssueSuccessMsg: 'æ„Ÿè¬æ‚¨çš„å›å ±ï¼Œæˆ‘å€‘æœƒå„˜å¿«è™•ç†ï¼',
                reportIssueErrorMsg: 'å›å ±å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
                footerAppName: 'æ°¸çºŒå•†åº—åœ°åœ–',
                footerAppDescription: 'å¹«åŠ©æ¶ˆè²»è€…æ‰¾åˆ°ä¸¦æ”¯æŒæ°¸çºŒç™¼å±•çš„å•†åº—ï¼Œä¸€èµ·ç‚ºåœ°çƒç›¡ä¸€ä»½å¿ƒåŠ›ã€‚',
                contactUsTitle: 'è¯çµ¡æˆ‘å€‘',
                contactUsText: 'æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿èˆ‡æˆ‘å€‘è¯ç¹«',
                contactUsEmail: 'é›»å­éƒµä»¶ï¼šartistworld0815@gmail.com',
                followUsTitle: 'é—œæ³¨æˆ‘å€‘',
                copyright: 'Â© 2025 æ°¸çºŒå•†åº—åœ°åœ– - ç‰ˆæ¬Šæ‰€æœ‰',
                modalAboutUs: 'é—œæ–¼æˆ‘å€‘',
                modalSustainability: 'æ°¸çºŒç†å¿µ',
                modalShopInfo: 'å•†åº—è³‡è¨Š',
                modalAddress: 'åœ°å€',
                modalOpeningHours: 'ç‡Ÿæ¥­æ™‚é–“',
                modalContactInfo: 'è¯çµ¡æ–¹å¼',
                modalPhone: 'é›»è©±',
                modalEmail: 'Email',
                modalWebsite: 'ç¶²ç«™',
                modalLocation: 'ä½ç½®',
                shopDetailsNotAvailable: 'æ­¤åº—å®¶è©³æƒ…å°šæœªå»ºç«‹ï¼Œæ•¬è«‹æœŸå¾…ï¼',
                okButton: 'ç¢ºå®š',
                notProvided: 'æœªæä¾›',
                newsletterSuccess: 'æ„Ÿè¬æ‚¨çš„è¨‚é–±ï¼æ‚¨å°‡æ”¶åˆ°æˆ‘å€‘çš„æœ€æ–°æ¶ˆæ¯ã€‚',
                newsletterInvalidEmail: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€ã€‚',
                newsletterError: 'è¨‚é–±å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
                adminRecommendBtn: 'ğŸ“§ æ¨è–¦æ­¤åº—å®¶çµ¦æ‰€æœ‰è¨‚é–±è€…',
                adminLoginPrompt: 'è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š',
                adminLoginFailed: 'å¯†ç¢¼éŒ¯èª¤ï¼',
                adminLoginSuccess: 'å·²é€²å…¥ç®¡ç†å“¡æ¨¡å¼',
                recommendationSending: 'æ­£åœ¨ç™¼é€æ¨è–¦ä¿¡...',
                recommendationSent: 'æ¨è–¦ä¿¡å·²æˆåŠŸç™¼é€çµ¦æ‰€æœ‰è¨‚é–±è€…ï¼',
                recommendationFailed: 'ç™¼é€æ¨è–¦ä¿¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚',
            },
            // ... other languages
        };

        // ===== ADMIN FUNCTIONS =====
        function promptAdminLogin() {
            const password = prompt(translations[currentLang].adminLoginPrompt);
            if (password === ADMIN_PASSWORD) {
                isAdminMode = true;
                document.getElementById('admin-indicator').classList.remove('hidden');
                showMessageModal(translations[currentLang].adminLoginSuccess);
            } else if (password !== null) {
                showMessageModal(translations[currentLang].adminLoginFailed);
            }
        }

        window.promptAdminLogin = promptAdminLogin;

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                promptAdminLogin();
            }
        });

        // ===== EMAIL FUNCTIONS =====
        async function getSubscriberEmails() {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL + '?action=getEmails');
                const data = await response.json();
                if (data.success && data.emails) {
                    return data.emails;
                } else {
                    console.error('Error from Apps Script:', data.error);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching subscriber emails:', error);
                return [];
            }
        }

        async function sendRecommendationEmail(shopId) {
            if (typeof emailjs === 'undefined') {
                showMessageModal('EmailJS service not available');
                return;
            }
            const shop = shopDetails[shopId];
            if (!shop) return;

            try {
                showMessageModal(translations[currentLang].recommendationSending);
                const emails = await getSubscriberEmails();
                if (emails.length === 0) {
                    showMessageModal('æ²’æœ‰æ‰¾åˆ°è¨‚é–±è€…');
                    return;
                }

                const emailPromises = emails.map(email => {
                    const templateParams = {
                        to_name: email,
                        shop_name: getShopDisplayName(shop),
                        shop_description: shop[`description_${currentLang.replace('-', '_')}`] || shop.description_zh_TW,
                        shop_address: shop[`address_${currentLang.replace('-', '_')}`] || shop.address_zh_TW,
                        subscriber_email: email 
                    };
                    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                });

                const results = await Promise.allSettled(emailPromises);
                const successfulSends = results.filter(r => r.status === 'fulfilled').length;
                const failedSends = results.length - successfulSends;

                if (successfulSends > 0 && failedSends === 0) {
                    showMessageModal(translations[currentLang].recommendationSent);
                } else {
                    showMessageModal(`æˆåŠŸç™¼é€ ${successfulSends} å°ï¼Œå¤±æ•— ${failedSends} å°ã€‚`);
                }
            } catch (error) {
                console.error('Error sending recommendation email:', error);
                showMessageModal(translations[currentLang].recommendationFailed);
            }
        }

        // ===== LANGUAGE & DATA FUNCTIONS =====
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    const el = element;
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });
            document.getElementById('language-select').value = lang;
            document.getElementById('language-select-mobile').value = lang;
            document.documentElement.lang = lang;
            
            currentLoadedShops = 0;
            filterAndDisplayShops();
        }

        // âœ… ä¿®æ­£ï¼šæ–°å¢ä¸€å€‹å‡½å¼ä¾†è™•ç†å¤šèªè¨€åº—åé¡¯ç¤º
        function getShopDisplayName(shop) {
            const langKey = currentLang.replace('-', '_');
            const nativeName = shop.name_zh_TW;
            const foreignName = shop[`name_${langKey}`];

            if (currentLang === 'zh-TW' || !foreignName || nativeName === foreignName) {
                return nativeName;
            }
            return `${nativeName} (${foreignName})`;
        }

        // ===== UI & DISPLAY FUNCTIONS =====
        function getFilteredShops() {
            return shops.filter(shop => {
                const langKey = currentLang.replace('-', '_');
                const matchesCategory = currentFilterCategory === 'all' || 
                    (shop[`type_${langKey}`] || shop.type_zh_TW) === currentFilterCategory;

                const query = currentSearchQuery.toLowerCase();
                const matchesSearch = query === '' ||
                    (shop.name_zh_TW && shop.name_zh_TW.toLowerCase().includes(query)) ||
                    (shop.name_en && shop.name_en.toLowerCase().includes(query)) ||
                    (shop[`address_${langKey}`] || shop.address_zh_TW).toLowerCase().includes(query);
                
                return matchesCategory && matchesSearch;
            });
        }

        function renderShopCards(filteredShops) {
            const container = document.getElementById('shop-cards-container');
            if (currentLoadedShops === 0) container.innerHTML = '';

            const shopsToDisplay = filteredShops.slice(currentLoadedShops, currentLoadedShops + shopsPerPage);
            
            shopsToDisplay.forEach(shop => {
                const langKey = currentLang.replace('-', '_');
                const cardHTML = `
                    <div class="shop-card bg-white rounded-xl overflow-hidden shadow-md">
                        <div class="h-48 bg-green-100 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold">${getShopDisplayName(shop)}</h3>
                                <span class="tag px-2 py-1 rounded-full text-xs">${shop[`type_${langKey}`] || shop.type_zh_TW}</span>
                            </div>
                            <p class="text-gray-600 mb-4">${shop[`description_${langKey}`] || shop.description_zh_TW}</p>
                            <div class="mb-4">
                                <div class="flex items-center text-gray-600 text-sm mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    ${shop[`address_${langKey}`] || shop.address_zh_TW}
                                </div>
                                <div class="flex items-center text-gray-600 text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    ${shop[`hours_${langKey}`] || shop.hours_zh_TW}
                                </div>
                            </div>
                            <button class="block w-full text-center py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" onclick="showShopDetail('${shop.id}')">${translations[currentLang].viewDetailsBtn}</button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', cardHTML);
            });

            currentLoadedShops += shopsToDisplay.length;
            updateLoadMoreButton(filteredShops.length);
        }

        function updateMapMarkers(filteredShops) {
            if (!mapInstance) return;
            markersGroup.clearLayers();
            filteredShops.forEach(shop => {
                const langKey = currentLang.replace('-', '_');
                const marker = L.marker([shop.lat, shop.lng]);
                marker.bindPopup(`
                    <div class="p-2">
                        <h3 class="font-bold text-lg mb-1">${getShopDisplayName(shop)}</h3>
                        <p class="text-sm text-gray-600 mb-2">${shop[`address_${langKey}`] || shop.address_zh_TW}</p>
                        <button onclick="showShopDetail('${shop.id}')" class="text-green-600 text-sm hover:underline">${translations[currentLang].viewDetailsBtn}</button>
                    </div>`);
                markersGroup.addLayer(marker);
            });
            mapInstance.addLayer(markersGroup);
        }

        function filterAndDisplayShops() {
            const filteredShops = getFilteredShops();
            renderShopCards(filteredShops);
            updateMapMarkers(filteredShops);
        }

        function updateLoadMoreButton(totalFilteredShops) {
            const button = document.getElementById('load-more-button');
            if (currentLoadedShops < totalFilteredShops) {
                button.classList.remove('hidden');
            } else {
                button.classList.add('hidden');
            }
        }

        function showShopDetail(shopId) {
            const shop = shopDetails[shopId];
            if (!shop) {
                showMessageModal(translations[currentLang].shopDetailsNotAvailable);
                return;
            }
            const langKey = currentLang.replace('-', '_');
            let detailHTML = `
                <div class="shop-detail-header py-12 text-white rounded-t-xl">
                    <div class="container mx-auto px-4 text-center">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2">${getShopDisplayName(shop)}</h1>
                        <p class="text-lg">${shop[`type_${langKey}`] || shop.type_zh_TW}</p>
                    </div>
                </div>
                <button id="close-modal" class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-md z-[1010]"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                <div class="p-6"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2">
                    <h2 class="text-2xl font-bold mb-4" data-i18n="modalAboutUs">${translations[currentLang].modalAboutUs}</h2>
                    <p class="text-gray-700 mb-4">${shop[`description_${langKey}`] || shop.description_zh_TW}</p>
                    <p class="text-gray-700 mb-6">${shop[`longDescription_${langKey}`] || shop.longDescription_zh_TW}</p>
                    <h2 class="text-2xl font-bold mb-4" data-i18n="modalSustainability">${translations[currentLang].modalSustainability}</h2>
                    <div class="mb-6">
                        <p class="text-gray-700 mb-4">${shop[`sustainability_${langKey}`] || shop.sustainability_zh_TW}</p>
                        <div class="flex flex-wrap gap-2 mb-4">${(shop[`tags_${langKey}`] || shop.tags_zh_TW).map(tag => `<span class="tag px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}</div>
                    </div>
                    ${isAdminMode ? `<button onclick="sendRecommendationEmail('${shopId}')" class="admin-button">${translations[currentLang].adminRecommendBtn}</button>` : ''}
                </div>
                <div class="bg-green-50 p-6 rounded-xl">
                    <h3 class="text-xl font-bold mb-4">${translations[currentLang].modalShopInfo}</h3>
                    <div class="space-y-4">
                        <div><h4 class="font-medium text-gray-700">${translations[currentLang].modalAddress}</h4><p class="text-gray-600">${shop[`address_${langKey}`] || shop.address_zh_TW}</p></div>
                        <div><h4 class="font-medium text-gray-700">${translations[currentLang].modalOpeningHours}</h4><p class="text-gray-600">${shop[`hours_${langKey}`] || shop.hours_zh_TW}</p></div>
                        <div><h4 class="font-medium text-gray-700">${translations[currentLang].modalContactInfo}</h4>
                            <p class="text-gray-600">${translations[currentLang].modalPhone}: ${shop.phone || translations[currentLang].notProvided}</p>
                            <p class="text-gray-600">${translations[currentLang].modalEmail}: ${shop.email || translations[currentLang].notProvided}</p>
                            ${shop.website ? `<p class="text-gray-600">${translations[currentLang].modalWebsite}: <a href="https://${shop.website}" target="_blank" class="text-green-600 hover:underline">${shop.website}</a></p>` : ''}
                        </div>
                    </div>
                    <div class="mt-6"><h3 class="text-xl font-bold mb-4">${translations[currentLang].modalLocation}</h3><div class="h-64 bg-gray-200 rounded-lg overflow-hidden shop-map"><div id="shop-map-${shopId}" class="h-full w-full"></div></div></div>
                </div></div></div>`;
            
            document.getElementById('shop-detail-content').innerHTML = detailHTML;
            document.getElementById('shop-detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            setTimeout(() => {
                const shopMap = L.map(`shop-map-${shopId}`).setView([shop.lat, shop.lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(shopMap);
                L.marker([shop.lat, shop.lng]).addTo(shopMap);
            }, 100);

            document.getElementById('close-modal').addEventListener('click', closeModal);
        }
        
        function closeModal() {
            document.getElementById('shop-detail-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function showMessageModal(message) {
            document.getElementById('message-modal-text').textContent = message;
            document.getElementById('custom-message-modal').classList.add('hidden');
            document.getElementById('custom-message-modal').classList.remove('hidden');
        }

        function initializeMap() {
            try {
                mapInstance = L.map('sustainability-map').setView([25.0330, 121.5654], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                markersGroup.addTo(mapInstance);
            } catch (error) { console.error('Error initializing map:', error); }
        }
        
        async function fetchShopData() {
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getShops`);
                const data = await response.json();
                if (data.success) {
                    shopDetails = data.shops;
                    shops = Object.values(shopDetails);
                    // Dynamically create filter buttons from shop types
                    const langKey = currentLang.replace('-', '_');
                    const categories = [...new Set(shops.map(s => s[`type_${langKey}`] || s.type_zh_TW))];
                    const filterContainer = document.getElementById('filter-buttons-container');
                    // Clear old buttons except "All"
                    while (filterContainer.children.length > 1) {
                        filterContainer.removeChild(filterContainer.lastChild);
                    }
                    categories.forEach(cat => {
                       const btn = document.createElement('button');
                       btn.className = 'tag px-3 py-1 rounded-full text-sm';
                       btn.dataset.category = cat;
                       btn.textContent = cat;
                       filterContainer.appendChild(btn);
                    });
                    
                    filterAndDisplayShops();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error("Could not fetch shop data:", error);
                alert("ç„¡æ³•è¼‰å…¥å•†åº—è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            fetchShopData().then(() => {
                setLanguage(currentLang);
            });
            
            // Event Listeners
            document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));
            document.getElementById('language-select').addEventListener('change', (e) => setLanguage(e.target.value));
            document.getElementById('language-select-mobile').addEventListener('change', (e) => setLanguage(e.target.value));
            document.getElementById('search-button').addEventListener('click', () => {
                currentSearchQuery = document.getElementById('search-input').value;
                currentLoadedShops = 0;
                filterAndDisplayShops();
            });
            document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('search-button').click(); });
            document.getElementById('filter-buttons-container').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#filter-buttons-container button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilterCategory = e.target.dataset.category;
                    currentLoadedShops = 0;
                    filterAndDisplayShops();
                }
            });
            document.getElementById('load-more-button').addEventListener('click', () => filterAndDisplayShops());
            document.getElementById('subscribe-button').addEventListener('click', () => {
                const email = document.getElementById('newsletter-email').value.trim();
                if (!email || !/\S+@\S+\.\S+/.test(email)) {
                    showMessageModal(translations[currentLang].newsletterInvalidEmail);
                    return;
                }
                const formData = new FormData();
                formData.append('action', 'subscribe');
                formData.append('email', email);
                fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', body: formData, mode: 'no-cors' });
                showMessageModal(translations[currentLang].newsletterSuccess);
                document.getElementById('newsletter-email').value = '';
            });
            document.getElementById('issue-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                // Formsubmit.co logic here...
            });
            document.getElementById('close-message-modal').addEventListener('click', () => document.getElementById('custom-message-modal').classList.add('hidden'));

            const appTitle = document.getElementById('app-title');
            let tapCount = 0;
            let tapTimer;
            appTitle.addEventListener('click', (e) => {
                e.preventDefault();
                tapCount++;
                clearTimeout(tapTimer);
                tapTimer = setTimeout(() => {
                    if (tapCount === 1) {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                    tapCount = 0;
                }, 300);
                if (tapCount >= 20) {
                    clearTimeout(tapTimer);
                    tapCount = 0;
                    promptAdminLogin();
                }
            });
        });

        window.showShopDetail = showShopDetail;
        window.sendRecommendationEmail = sendRecommendationEmail;
    </script>
</body>
</html>
