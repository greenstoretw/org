<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>永續商店地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .favorite-btn.active i { color: #ef4444; /* red-500 */ }
        .modal-content { max-height: 80vh; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-500"></div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-green-700"><i class="fas fa-leaf mr-2"></i>永續商店地圖</h1>
            <div class="flex items-center space-x-4">
                <button id="favorites-list-btn" class="text-gray-600 hover:text-green-600 relative">
                    <i class="fas fa-heart text-xl"></i>
                    <span id="favorites-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4">
        <!-- Search and Filter -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex flex-col md:flex-row gap-4 items-center">
            <div class="relative flex-grow w-full">
                <input type="text" id="search-input" placeholder="搜尋店家名稱、地址、類型..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <!-- Announcement Bar -->
        <div id="announcement-bar" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded-md" role="alert">
            <p class="font-bold">網站公告</p>
            <p id="announcement-text"></p>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Map -->
            <div class="lg:col-span-2 h-[60vh] lg:h-auto rounded-lg shadow-md overflow-hidden" id="map"></div>

            <!-- Shop List -->
            <div class="h-[60vh] lg:h-auto overflow-y-auto bg-white p-2 rounded-lg shadow-md">
                <div id="shop-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                    <!-- Shop cards will be injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Shop Detail Modal -->
    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal-content overflow-y-auto">
            <div class="p-6 relative">
                <button onclick="closeModal('shop-detail-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                <img id="modal-shop-image" src="" alt="店家圖片" class="w-full h-48 object-cover rounded-lg mb-4 bg-gray-200">
                <h2 id="modal-shop-name" class="text-3xl font-bold mb-2 text-gray-800"></h2>
                <p id="modal-shop-address" class="text-gray-600 mb-4"><i class="fas fa-map-marker-alt mr-2 text-green-600"></i></p>
                <div class="flex flex-wrap gap-2 mb-4">
                    <span id="modal-shop-type" class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full"></span>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <div class="space-y-3 text-gray-700">
                        <p id="modal-shop-hours"><i class="fas fa-clock fa-fw mr-2 text-green-600"></i></p>
                        <p id="modal-shop-phone"><i class="fas fa-phone fa-fw mr-2 text-green-600"></i></p>
                        <p><i class="fas fa-globe fa-fw mr-2 text-green-600"></i><a id="modal-shop-website" href="#" target="_blank" class="text-blue-500 hover:underline"></a></p>
                    </div>
                </div>
                <div class="mt-4 border-t border-gray-200 pt-4">
                    <h3 class="font-semibold text-lg mb-2">永續特色</h3>
                    <p id="modal-shop-sustainability" class="text-gray-600 whitespace-pre-wrap"></p>
                </div>
                <div class="mt-4 border-t border-gray-200 pt-4">
                    <h3 class="font-semibold text-lg mb-2">標籤</h3>
                    <div id="modal-shop-tags" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="recommend-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-share-square mr-2"></i>推薦給朋友</button>
                    <button id="feedback-btn" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-exclamation-triangle mr-2"></i>回報問題</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Other Modals: Recommendation, Feedback, Favorites -->
    <div id="recommend-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"> <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"> <h2 class="text-2xl font-bold mb-4">推薦店家</h2> <form id="recommend-form"> <input type="hidden" id="recommend-shop-id"> <label for="recipient-email" class="block mb-2">朋友的 Email</label> <input type="email" id="recipient-email" required class="w-full p-2 border rounded mb-4"> <div class="flex justify-end space-x-2"> <button type="button" onclick="closeModal('recommend-modal')" class="bg-gray-300 px-4 py-2 rounded">取消</button> <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">送出</button> </div> </form> </div> </div>
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"> <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"> <h2 class="text-2xl font-bold mb-4">回報問題</h2> <form id="feedback-form"> <input type="hidden" id="feedback-shop-id"> <p class="mb-2">店家: <span id="feedback-shop-name" class="font-semibold"></span></p> <label for="feedback-type" class="block mb-2">問題類型</label> <select id="feedback-type" class="w-full p-2 border rounded mb-4"> <option>資訊錯誤</option> <option>地點標示不準</option> <option>已歇業</option> <option>其他建議</option> </select> <label for="feedback-comment" class="block mb-2">詳細說明</label> <textarea id="feedback-comment" rows="4" required class="w-full p-2 border rounded mb-4"></textarea> <div class="flex justify-end space-x-2"> <button type="button" onclick="closeModal('feedback-modal')" class="bg-gray-300 px-4 py-2 rounded">取消</button> <button type="submit" class="bg-yellow-500 text-white px-4 py-2 rounded">送出</button> </div> </form> </div> </div>
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"> <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6"> <h2 class="text-2xl font-bold mb-4">我的最愛</h2> <div id="favorites-list-content" class="space-y-2 max-h-96 overflow-y-auto"></div> <div class="flex justify-end mt-4"> <button type="button" onclick="closeModal('favorites-modal')" class="bg-gray-500 text-white px-4 py-2 rounded">關閉</button> </div> </div> </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzIcS0WXSQV0yNt5lyjvHy7hwDIUItkGeG78T_Yz2mKa83HJMgI9UxsfVIelU6PyKFwkw/exec";
        let map, allShops = [], markers = [], favorites = [];

        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            initMap();
            loadFavorites();
            try {
                const data = await apiCall('getPublicData');
                allShops = data.shops;
                document.getElementById('announcement-text').innerText = data.announcements || '目前沒有新公告。';
                renderShops(allShops);
                addMarkers(allShops);
            } catch (error) {
                console.error("Failed to load initial data:", error);
                alert("無法載入地圖資料，請稍後再試。");
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
            setupEventListeners();
        });

        const apiCall = async (action, payload = {}) => {
            const response = await fetch(SCRIPT_URL, { method: 'POST', redirect: "follow", body: JSON.stringify({ action, ...payload }), headers: { "Content-Type": "text/plain;charset=utf-8" } });
            if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            return result.data;
        };

        function initMap() {
            map = L.map('map').setView([25.0330, 121.5654], 13); // Taipei
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // =================================================================
        // RENDERING & MAP FUNCTIONS
        // =================================================================
        function renderShops(shops) {
            const list = document.getElementById('shop-list');
            list.innerHTML = shops.length ? shops.map(shop => {
                const isFavorite = favorites.includes(shop.id);
                const imageUrl = shop.imageUrl || `https://placehold.co/400x300/e2e8f0/4a5568?text=${encodeURIComponent(shop['name_zh-TW'])}`;
                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
                        <img src="${imageUrl}" alt="${shop['name_zh-TW']}" class="w-full h-40 object-cover cursor-pointer" onclick="showShopDetail('${shop.id}')" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/4a5568?text=圖片錯誤';">
                        <div class="p-4">
                            <h3 class="font-bold text-lg truncate cursor-pointer hover:text-green-700" onclick="showShopDetail('${shop.id}')">${shop['name_zh-TW']}</h3>
                            <p class="text-gray-600 text-sm truncate"><i class="fas fa-map-marker-alt fa-fw mr-1"></i>${shop['address_zh-TW']}</p>
                            <div class="mt-2 flex justify-between items-center">
                                <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">${shop['type_zh-TW']}</span>
                                <button onclick="toggleFavorite('${shop.id}', event)" class="favorite-btn ${isFavorite ? 'active' : ''} text-gray-400 hover:text-red-500 text-xl p-1">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
            }).join('') : '<p class="text-center text-gray-500 col-span-full">找不到店家資訊。</p>';
        }

        function addMarkers(shops) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            shops.forEach(shop => {
                if (shop.lat && shop.lng) {
                    const marker = L.marker([shop.lat, shop.lng]).addTo(map);
                    marker.bindPopup(`<b>${shop['name_zh-TW']}</b><br>${shop['address_zh-TW']}`);
                    marker.on('click', () => showShopDetail(shop.id));
                    markers.push(marker);
                }
            });
        }
        
        function showShopDetail(shopId) {
            const shop = allShops.find(s => s.id === shopId);
            if (!shop) return;
            const textOrDefault = (text) => text || '未提供';
            document.getElementById('modal-shop-name').textContent = textOrDefault(shop['name_zh-TW']);
            document.getElementById('modal-shop-address').innerHTML = `<i class="fas fa-map-marker-alt mr-2 text-green-600"></i>${textOrDefault(shop['address_zh-TW'])}`;
            document.getElementById('modal-shop-type').textContent = textOrDefault(shop['type_zh-TW']);
            document.getElementById('modal-shop-hours').innerHTML = `<i class="fas fa-clock fa-fw mr-2 text-green-600"></i>${textOrDefault(shop['hours_zh-TW'])}`;
            document.getElementById('modal-shop-phone').innerHTML = `<i class="fas fa-phone fa-fw mr-2 text-green-600"></i>${textOrDefault(shop.phone)}`;
            const websiteLink = document.getElementById('modal-shop-website');
            websiteLink.href = shop.website ? `http://${shop.website.replace(/^https?:\/\//,'')}` : '#';
            websiteLink.textContent = textOrDefault(shop.website);
            document.getElementById('modal-shop-sustainability').textContent = textOrDefault(shop['sustainability_zh-TW']);
            document.getElementById('modal-shop-tags').innerHTML = (shop['tags_zh-TW'] || '').split(',')
                .map(tag => tag.trim() ? `<span class="bg-gray-200 text-gray-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${tag.trim()}</span>` : '').join('');
            document.getElementById('recommend-btn').onclick = () => openRecommendModal(shop.id);
            document.getElementById('feedback-btn').onclick = () => openFeedbackModal(shop.id);

            const modalImage = document.getElementById('modal-shop-image');
            const imageUrl = shop.imageUrl || `https://placehold.co/600x400/e2e8f0/4a5568?text=${encodeURIComponent(shop['name_zh-TW'])}`;
            modalImage.src = imageUrl;
            modalImage.alt = shop['name_zh-TW'];
            modalImage.onerror = () => { modalImage.src = `https://placehold.co/600x400/e2e8f0/4a5568?text=圖片載入失敗`; };
            
            openModal('shop-detail-modal');
        }

        // =================================================================
        // EVENT HANDLERS & MODAL LOGIC
        // =================================================================
        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = allShops.filter(shop => 
                    (shop['name_zh-TW'] && shop['name_zh-TW'].toLowerCase().includes(searchTerm)) ||
                    (shop['address_zh-TW'] && shop['address_zh-TW'].toLowerCase().includes(searchTerm)) ||
                    (shop['type_zh-TW'] && shop['type_zh-TW'].toLowerCase().includes(searchTerm))
                );
                renderShops(filtered);
                addMarkers(filtered);
            });
            document.getElementById('favorites-list-btn').addEventListener('click', showFavoritesModal);
            document.getElementById('recommend-form').addEventListener('submit', handleRecommendSubmit);
            document.getElementById('feedback-form').addEventListener('submit', handleFeedbackSubmit);
        }

        function openModal(id) { document.getElementById(id).classList.replace('hidden', 'flex'); }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }

        function openRecommendModal(shopId) { document.getElementById('recommend-shop-id').value = shopId; openModal('recommend-modal'); }
        async function handleRecommendSubmit(e) {
            e.preventDefault();
            const shopId = document.getElementById('recommend-shop-id').value;
            const shop = allShops.find(s => s.id === shopId);
            const recipientEmail = document.getElementById('recipient-email').value;
            try {
                await apiCall('sendRecommendation', { recipientEmail, shopName: shop['name_zh-TW'], shopAddress: shop['address_zh-TW'], shopWebsite: shop.website });
                alert('推薦信已成功寄出！');
                closeModal('recommend-modal');
                e.target.reset();
            } catch (error) { alert(`推薦失敗: ${error.message}`); }
        }

        function openFeedbackModal(shopId) { const shop = allShops.find(s => s.id === shopId); document.getElementById('feedback-shop-id').value = shopId; document.getElementById('feedback-shop-name').textContent = shop['name_zh-TW']; openModal('feedback-modal'); }
        async function handleFeedbackSubmit(e) {
            e.preventDefault();
            const payload = { shopId: document.getElementById('feedback-shop-id').value, feedbackType: document.getElementById('feedback-type').value, comment: document.getElementById('feedback-comment').value, shopName: document.getElementById('feedback-shop-name').textContent };
            try {
                await apiCall('submitFeedback', payload);
                alert('感謝您的回報！');
                closeModal('feedback-modal');
                e.target.reset();
            } catch (error) { alert(`回報失敗: ${error.message}`); }
        }
        
        // =================================================================
        // FAVORITES LOGIC
        // =================================================================
        function loadFavorites() { favorites = JSON.parse(localStorage.getItem('favorites')) || []; updateFavoritesCount(); }
        function saveFavorites() { localStorage.setItem('favorites', JSON.stringify(favorites)); updateFavoritesCount(); }
        function updateFavoritesCount() { document.getElementById('favorites-count').textContent = favorites.length; }
        function toggleFavorite(shopId, event) {
            event.stopPropagation();
            const index = favorites.indexOf(shopId);
            if (index > -1) favorites.splice(index, 1);
            else favorites.push(shopId);
            saveFavorites();
            const btn = event.currentTarget;
            btn.classList.toggle('active', index === -1);
        }
        function showFavoritesModal() {
            const content = document.getElementById('favorites-list-content');
            const favoriteShops = allShops.filter(s => favorites.includes(s.id));
            if (favoriteShops.length) {
                content.innerHTML = favoriteShops.map(shop => `<div class="flex items-center justify-between p-2 border-b"><span class="cursor-pointer hover:underline" onclick="showShopDetail('${shop.id}');closeModal('favorites-modal');">${shop['name_zh-TW']}</span><button onclick="removeFavoriteFromList('${shop.id}')" class="text-red-500 text-sm">移除</button></div>`).join('');
            } else {
                content.innerHTML = '<p class="text-gray-500">您尚未加入任何最愛店家。</p>';
            }
            openModal('favorites-modal');
        }
        function removeFavoriteFromList(shopId) {
            const index = favorites.indexOf(shopId);
            if (index > -1) favorites.splice(index, 1);
            saveFavorites();
            showFavoritesModal(); // Refresh list
            renderShops(allShops); // Refresh main view button states
        }
    </script>
</body>
</html>

