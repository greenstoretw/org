<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f7f4; }
        .hero-section { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?auto=format&fit=crop&w=1200&q=80') center/cover; }
        .tag { background-color: #dcfce7; color: #16a34a; }
        .tag.active { background-color: #16a34a; color: white; }
        .btn-primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
        .shop-card { transition: all 0.3s ease; display: flex; flex-direction: column; }
        .shop-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .shop-card .p-6 { display: flex; flex-direction: column; flex-grow: 1; justify-content: space-between; }
        .shop-card .btn-primary { margin-top: auto; }
        .modal { z-index: 1000; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        #sustainability-map { width: 100%; height: 500px; z-index: 10; }
        .favorite-btn { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.8); border-radius: 50%; padding: 0.5rem; cursor: pointer; }
        .favorite-btn svg { width: 1.5rem; height: 1.5rem; stroke: #4b5563; stroke-width: 1.5; fill: none; }
        .favorite-btn.favorited svg { fill: #ef4444; stroke: #ef4444; }
    </style>
</head>
<body class="antialiased">
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <a href="#" class="flex items-center space-x-2">
                <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-2xl font-bold text-gray-800" data-i18n="appName">永續商店地圖</span>
            </a>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#" class="text-gray-700 hover:text-green-600" data-i18n="home">首頁</a>
                <a href="#map" class="text-gray-700 hover:text-green-600" data-i18n="map">地圖</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600" data-i18n="shopList">商店列表</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600" data-i18n="newsletter">訂閱電子報</a>
                <a href="#report-issue" class="text-gray-700 hover:text-green-600" data-i18n="reportIssueNavLink">問題回報</a>
                <select id="language-select" class="bg-gray-100 border rounded-md p-1 text-sm"><option value="zh-TW">繁體中文</option><option value="en">English</option></select>
            </div>
            <div class="md:hidden"><button id="menu-toggle" class="text-gray-700"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button></div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white"></div>
    </nav>

    <div id="announcement-bar" class="hidden bg-yellow-200 text-yellow-800 p-3 text-center"><p id="announcement-text" class="font-medium whitespace-pre-wrap"></p></div>

    <section class="hero-section py-20 text-white text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">探索台灣永續商店</h1>
        <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">找到支持環保、公平貿易和永續發展的商店</p>
        <a href="#map" class="btn-primary px-8 py-3 rounded-lg font-medium" data-i18n="viewMapBtn">查看地圖</a>
    </section>
    
    <section class="py-12 bg-white">
        <div class="max-w-4xl mx-auto p-4"><div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">搜尋永續商店</h2>
            <div class="flex"><input type="text" id="search-input" class="flex-1 px-4 py-3 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500" data-i18n-placeholder="searchPlaceholder"><button id="search-button" class="btn-primary px-6 py-3 rounded-r-lg"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></button></div>
            <h3 class="font-medium mt-6 mb-3" data-i18n="filterCategoryTitle">依類別篩選</h3>
            <div class="flex flex-wrap gap-2" id="filter-buttons-container"><button class="tag px-3 py-1 rounded-full text-sm active" data-category="" data-i18n="filterAll">全部</button><button class="tag px-3 py-1 rounded-full text-sm" data-category="favorites" data-i18n="filterFavorites">❤️ 我的收藏</button></div>
        </div></div>
    </section>

    <section id="map" class="py-12 bg-green-50"><div class="container mx-auto px-4"><h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">永續商店地圖</h2><div class="bg-white rounded-xl shadow-lg overflow-hidden"><div id="sustainability-map"></div></div></div></section>

    <section id="shops" class="py-12 bg-white"><div class="container mx-auto px-4"><h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">永續商店列表</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="shop-cards-container"></div><div class="text-center mt-8"><button id="load-more-button" class="btn-primary px-8 py-3 rounded-lg hidden" data-i18n="loadMoreBtn">載入更多</button></div></div></section>

    <section id="newsletter" class="py-12 bg-green-600 text-white text-center"><h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">訂閱電子報</h2><p class="mb-6" data-i18n="newsletterSubtitle">獲取最新永續資訊</p><form id="newsletter-form" class="max-w-md mx-auto flex gap-2"><input type="email" name="email" class="flex-1 px-4 py-3 rounded-lg text-gray-800" data-i18n-placeholder="newsletterPlaceholder" required><button type="submit" class="bg-white text-green-600 px-6 py-3 rounded-lg" data-i18n="subscribeBtn">訂閱</button></form></section>

    <section id="report-issue" class="py-12 bg-yellow-50"><div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8"><h2 class="text-3xl font-bold text-center mb-6" data-i18n="reportIssueTitle">問題回報</h2><form id="issue-form" class="space-y-4"><input type="email" name="email" class="w-full p-2 border rounded" data-i18n-placeholder="modalEmail" required><select name="type" class="w-full p-2 border rounded" required><option value="" data-i18n="reportIssueSelectType">請選擇類型</option><option value="data_error" data-i18n="reportIssueDataError">店家資訊錯誤</option><option value="feature_request" data-i18n="reportIssueFeatureRequest">功能建議</option><option value="bug_report" data-i18n="reportIssueBugReport">系統問題</option><option value="other" data-i18n="reportIssueOther">其他</option></select><textarea name="message" rows="4" class="w-full p-2 border rounded" data-i18n-placeholder="reportIssuePlaceholder" required></textarea><div class="text-center"><button type="submit" class="btn-primary px-6 py-2 rounded-lg" data-i18n="reportIssueSubmitBtn">送出</button></div></form></div></section>
    
    <footer class="bg-gray-800 text-white py-10 text-center"><button id="showPolicyFooter" class="hover:text-green-400" data-i18n="privacyPolicy">隱私權政策與聲明</button><div class="border-t border-gray-700 mt-6 pt-6 text-gray-400"><p data-i18n="copyright">© 2025 版權所有</p></div></footer>
    
    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center modal p-4"><div class="bg-white rounded-xl max-w-4xl w-full modal-content"><div id="shop-detail-content" class="relative"></div></div></div>
    <div id="policy-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center modal p-4"><div class="bg-white rounded-xl max-w-3xl w-full modal-content"><div id="policy-content" class="p-6 relative"></div></div></div>
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg hidden"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://script.google.com/macros/s/AKfycbyJ76tpxJ2eeRRqcv3qUqx3Z8nWLqrNsAIxgMR5vnkfmJOXulhhu1Av2T9w4AzDLg83gA/exec';
    
    let allShops = [], policies = {}, mapInstance, markersGroup = L.featureGroup();
    let favoriteShops = JSON.parse(localStorage.getItem('favoriteShops')) || [];
    let currentLang = localStorage.getItem('lang') || 'zh-TW';
    let currentFilterCategory = '', currentSearchQuery = '', shopsDisplayed = 0;
    const shopsPerPage = 6;

    const translations = {
        'zh-TW': { pageTitle: '永續商店地圖', appName: '永續商店地圖', home: '首頁', map: '地圖', shopList: '商店列表', newsletter: '訂閱電子報', reportIssueNavLink: '問題回報', heroTitle: '探索台灣永續商店', heroSubtitle: '找到支持環保、公平貿易和永續發展的商店', viewMapBtn: '查看地圖', searchTitle: '搜尋永續商店', searchPlaceholder: '輸入店名...', filterCategoryTitle: '依類別篩選', filterAll: '全部', filterFavorites: '❤️ 我的收藏', mapSectionTitle: '永續商店地圖', shopListSectionTitle: '永續商店列表', viewDetailsBtn: '查看詳情', loadMoreBtn: '載入更多', newsletterTitle: '訂閱電子報', newsletterSubtitle: '獲取最新永續資訊', newsletterPlaceholder: '您的電子郵件', subscribeBtn: '訂閱', reportIssueTitle: '問題回報', reportIssuePlaceholder: '請描述問題...', reportIssueSubmitBtn: '送出', copyright: '© 2025 版權所有', modalAddress: '地址', modalPhone: '電話', modalEmail: '您的Email', modalWebsite: '網站', notProvided: '未提供', newsletterSuccess: '感謝訂閱！', newsletterError: '訂閱失敗', reportIssueSuccess: '感謝回報！', reportIssueError: '回報失敗', privacyPolicy: '隱私權政策與聲明', reportIssueSelectType: '請選擇類型', reportIssueDataError: '店家資訊錯誤', reportIssueFeatureRequest: '功能建議', reportIssueBugReport: '系統問題', reportIssueOther: '其他' },
        'en': { pageTitle: 'Sustainable Store Map', appName: 'Sustainable Store Map', home: 'Home', map: 'Map', shopList: 'Shops', newsletter: 'Newsletter', reportIssueNavLink: 'Report Issue', heroTitle: 'Explore Sustainable Stores', heroSubtitle: 'Find shops that support eco-friendly and fair trade practices', viewMapBtn: 'View Map', searchTitle: 'Search Stores', searchPlaceholder: 'Enter store name...', filterCategoryTitle: 'Filter by Category', filterAll: 'All', filterFavorites: '❤️ My Favorites', mapSectionTitle: 'Sustainable Store Map', shopListSectionTitle: 'Sustainable Shops', viewDetailsBtn: 'View Details', loadMoreBtn: 'Load More', newsletterTitle: 'Subscribe', newsletterSubtitle: 'Get the latest sustainable news', newsletterPlaceholder: 'Your email', subscribeBtn: 'Subscribe', reportIssueTitle: 'Report an Issue', reportIssuePlaceholder: 'Describe the issue...', reportIssueSubmitBtn: 'Submit', copyright: '© 2025 All Rights Reserved', modalAddress: 'Address', modalPhone: 'Phone', modalEmail: 'Your Email', modalWebsite: 'Website', notProvided: 'Not provided', newsletterSuccess: 'Thanks for subscribing!', newsletterError: 'Subscription failed', reportIssueSuccess: 'Thanks for the feedback!', reportIssueError: 'Submission failed', privacyPolicy: 'Privacy Policy & Disclaimer', reportIssueSelectType: 'Select type', reportIssueDataError: 'Incorrect Store Info', reportIssueFeatureRequest: 'Feature Suggestion', reportIssueBugReport: 'System Bug', reportIssueOther: 'Other' }
    };

    const showToast = (msg) => {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 3000);
    };

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('lang', lang);
        const t = translations[lang];
        document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t[el.dataset.i18n] || ''; });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { el.placeholder = t[el.dataset.i18nPlaceholder] || ''; });
        document.getElementById('language-select').value = lang;
        shopsDisplayed = 0;
        populateFilters();
        filterAndRender();
    };

    async function fetchPublicData() {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getPublicData' }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });

            // **PATCH APPLIED**: Robust response handling
            const result = await response.json();
            const ok = result && (result.status === 'success' || result.success === true);
            if (!ok) throw new Error((result && result.message) || 'Unknown backend error');
            const data = result.data || result; // Fallback if data is not nested

            allShops = data.shops || [];
            policies = data.policies || {};
            
            if (data.announcements) {
                document.getElementById('announcement-text').textContent = data.announcements;
                document.getElementById('announcement-bar').classList.remove('hidden');
            }
            populateFilters();
            filterAndRender();
        } catch (error) {
            console.error("Data fetch failed:", error);
            showToast('資料載入失敗，請檢查網路連線或稍後再試。');
        }
    }

    const populateFilters = () => {
        const types = [...new Set(allShops.map(s => s[`type_${currentLang}`] || s['type_zh-TW']).filter(Boolean))];
        const container = document.getElementById('filter-buttons-container');
        container.querySelectorAll('.tag:not([data-category=""]):not([data-category="favorites"])').forEach(btn => btn.remove());
        types.forEach(type => {
            const btn = document.createElement('button');
            btn.className = 'tag px-3 py-1 rounded-full text-sm';
            btn.dataset.category = type;
            btn.textContent = type;
            container.appendChild(btn);
        });
    };

    const filterAndRender = () => {
        const container = document.getElementById('shop-cards-container');
        if (shopsDisplayed === 0) container.innerHTML = '';

        const filtered = allShops.filter(shop => {
            const name = shop[`name_${currentLang}`] || shop['name_zh-TW'] || '';
            const type = shop[`type_${currentLang}`] || shop['type_zh-TW'] || '';
            // **PATCH APPLIED**: Use String() for ID comparison
            const categoryMatch = !currentFilterCategory || (currentFilterCategory === 'favorites' ? favoriteShops.includes(String(shop.id)) : type === currentFilterCategory);
            const searchMatch = !currentSearchQuery || name.toLowerCase().includes(currentSearchQuery.toLowerCase());
            return categoryMatch && searchMatch;
        });

        const toDisplay = filtered.slice(shopsDisplayed, shopsDisplayed + shopsPerPage);
        toDisplay.forEach(shop => {
            const name = shop[`name_${currentLang}`] || shop['name_zh-TW'];
            const type = shop[`type_${currentLang}`] || shop['type_zh-TW'];
            const desc = shop[`description_${currentLang}`] || shop['description_zh-TW'];
            // **PATCH APPLIED**: Use String() for ID comparison
            const isFavorited = favoriteShops.includes(String(shop.id));
            container.innerHTML += `<div class="shop-card bg-white rounded-xl shadow-md"><div class="h-48 bg-green-100 flex items-center justify-center relative"><svg class="h-16 w-16 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg><button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-id="${shop.id}"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></button></div><div class="p-6"><div><h3 class="text-xl font-bold">${name}</h3><p class="text-sm text-gray-500">${type}</p><p class="text-gray-600 my-2 h-20 overflow-hidden">${desc}</p></div><button class="btn-primary py-2 rounded-lg" data-id="${shop.id}" data-action="details">${translations[currentLang].viewDetailsBtn}</button></div></div>`;
        });
        shopsDisplayed += toDisplay.length;
        document.getElementById('load-more-button').classList.toggle('hidden', shopsDisplayed >= filtered.length);
        updateMapMarkers(filtered);
    };
    
    const updateMapMarkers = (shops) => {
        if (!mapInstance) return;
        markersGroup.clearLayers();
        shops.forEach(shop => {
            if (shop.lat && shop.lng) {
                const name = shop[`name_${currentLang}`] || shop['name_zh-TW'];
                const marker = L.marker([shop.lat, shop.lng]).bindPopup(`<b>${name}</b><br><button class='text-green-600' data-action='details' data-id='${shop.id}'>${translations[currentLang].viewDetailsBtn}</button>`);
                markersGroup.addLayer(marker);
            }
        });
    };

    const showShopDetail = (shopId) => {
        const shop = allShops.find(s => String(s.id) === String(shopId));
        if (!shop) return;
        const t = translations[currentLang];
        const name = shop[`name_${currentLang}`] || shop['name_zh-TW'];
        const longDesc = shop[`longDescription_${currentLang}`] || shop['longDescription_zh-TW'] || shop[`description_${currentLang}`] || shop['description_zh-TW'];
        const address = shop[`address_${currentLang}`] || shop['address_zh-TW'];
        const website = shop.website ? `<p><strong>${t.modalWebsite}:</strong> <a href="//${shop.website}" target="_blank" class="text-green-600">${shop.website}</a></p>` : '';
        document.getElementById('shop-detail-content').innerHTML = `<div class="p-6"><h2>${name}</h2><p>${longDesc}</p><p><strong>${t.modalAddress}:</strong> ${address}</p><p><strong>${t.modalPhone}:</strong> ${shop.phone || t.notProvided}</p>${website}</div><button id="close-modal" class="absolute top-2 right-2 p-2">&times;</button>`;
        document.getElementById('shop-detail-modal').classList.remove('hidden');
    };

    const initMap = () => {
        mapInstance = L.map('sustainability-map').setView([25.03, 121.56], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
        mapInstance.addLayer(markersGroup);
    };
    
    document.body.addEventListener('click', e => {
        const detailsBtn = e.target.closest('[data-action="details"]');
        const favBtn = e.target.closest('.favorite-btn');
        if (detailsBtn) showShopDetail(detailsBtn.dataset.id);
        if (favBtn) {
            // **PATCH APPLIED**: Use String() for ID comparison
            const shopId = String(favBtn.dataset.id);
            const index = favoriteShops.indexOf(shopId);
            if (index > -1) favoriteShops.splice(index, 1);
            else favoriteShops.push(shopId);
            localStorage.setItem('favoriteShops', JSON.stringify(favoriteShops));
            favBtn.classList.toggle('favorited');
            if (currentFilterCategory === 'favorites') { shopsDisplayed = 0; filterAndRender(); }
        }
        if (e.target.closest('#close-modal') || e.target.id === 'shop-detail-modal') document.getElementById('shop-detail-modal').classList.add('hidden');
    });

    document.getElementById('language-select').addEventListener('change', e => setLanguage(e.target.value));
    document.getElementById('search-button').addEventListener('click', () => {
        currentSearchQuery = document.getElementById('search-input').value;
        shopsDisplayed = 0;
        filterAndRender();
    });
    document.getElementById('filter-buttons-container').addEventListener('click', e => {
        if (!e.target.matches('.tag')) return;
        document.querySelectorAll('#filter-buttons-container .tag').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilterCategory = e.target.dataset.category;
        shopsDisplayed = 0;
        filterAndRender();
    });
    document.getElementById('load-more-button').addEventListener('click', filterAndRender);
    
    const submitApiForm = async (form, action, successKey, errorKey) => {
        const payload = Object.fromEntries(new FormData(form).entries());
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, payload }) });
            const result = await res.json();
            if (result.status !== 'success') throw new Error(result.message);
            showToast(translations[currentLang][successKey]);
            form.reset();
        } catch (err) { showToast(translations[currentLang][errorKey] + `: ${err.message}`); }
    };
    document.getElementById('newsletter-form').addEventListener('submit', e => { e.preventDefault(); submitApiForm(e.target, 'subscribe', 'newsletterSuccess', 'newsletterError'); });
    document.getElementById('issue-form').addEventListener('submit', e => { e.preventDefault(); submitApiForm(e.target, 'submitFeedback', 'reportIssueSuccess', 'reportIssueError'); });
    document.getElementById('showPolicyFooter').addEventListener('click', () => {
        const policyModal = document.getElementById('policy-modal');
        // **PATCH APPLIED**: Robust policy value handling
        const privacyHTML = ((policies.privacy && (policies.privacy.value ?? policies.privacy)) || '').toString().replace(/\n/g, '<br>');
        const disclaimerHTML = ((policies.disclaimer && (policies.disclaimer.value ?? policies.disclaimer)) || '').toString().replace(/\n/g, '<br>');
        document.getElementById('policy-content').innerHTML = `<h2>${translations[currentLang].privacyPolicy}</h2><br>${privacyHTML}<br><br>${disclaimerHTML}<button id="close-policy" class="absolute top-2 right-2 p-2">&times;</button>`;
        policyModal.classList.remove('hidden');
    });
    document.getElementById('policy-modal').addEventListener('click', e => { if (e.target.matches('#policy-modal, #close-policy')) e.currentTarget.classList.add('hidden'); });

    initMap();
    fetchPublicData();
    setLanguage(currentLang);
});
</script>
</body>
</html>

