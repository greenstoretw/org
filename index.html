<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖 - 首頁</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f7f4;
        }
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
        }
        .tag {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .tag.active {
            background-color: #16a34a;
            color: white;
        }
        .btn-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            transition: all 0.3s ease;
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        .shop-card {
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .shop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .shop-card > div.p-6 {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-grow: 1;
        }
        .shop-card button {
            margin-top: auto;
        }
        .shop-detail-header {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1551488831-00ddcb6c6bd3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            max-width: 100%;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .map-container {
            position: relative;
            z-index: 10;
            overflow: hidden;
        }
        .leaflet-control-container {
            z-index: 10;
        }
        .modal {
            z-index: 100;
        }
        .shop-map {
            position: relative;
            z-index: 5;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #34d399;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .admin-mode {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            z-index: 1000;
            font-size: 14px;
        }
        .admin-button {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .admin-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        /* Ensure map container has proper dimensions */
        #sustainability-map {
            width: 100%;
            height: 500px;
            min-height: 400px;
        }
        .leaflet-container {
            font-family: 'Noto Sans TC', sans-serif;
        }
    </style>
</head>
<body>
    <!-- Admin Mode Indicator (Hidden by default) -->
    <div id="admin-indicator" class="admin-mode hidden">管理員模式</div>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <a href="#" class="text-2xl font-bold text-gray-800" data-i18n="appName">永續商店地圖</a>
            </div>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#" class="text-gray-700 hover:text-green-600 transition" data-i18n="home">首頁</a>
                <a href="#map" class="text-gray-700 hover:text-green-600 transition" data-i18n="map">地圖</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600 transition" data-i18n="shopList">商店列表</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600 transition" data-i18n="newsletter">訂閱電子報</a>
                <a href="#report-issue" class="text-gray-700 hover:text-green-600 transition" data-i18n="reportIssueNavLink">問題回報</a>
                <select id="language-select" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition cursor-pointer">
                    <option value="zh-TW" data-i18n="langChinese">繁體中文</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                    <option value="fr" data-i18n="langFrench">Français</option>
                    <option value="de" data-i18n="langGerman">Deutsch</option>
                    <option value="es" data-i18n="langSpanish">Español</option>
                    <option value="la" data-i18n="langLatin">Latin</option>
                    <option value="ja" data-i18n="langJapanese">日本語</option>
                </select>
            </div>
            <div class="md:hidden flex items-center">
                <select id="language-select-mobile" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition cursor-pointer mr-2">
                    <option value="zh-TW" data-i18n="langChinese">繁體中文</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                    <option value="fr" data-i18n="langFrench">Français</option>
                    <option value="de" data-i18n="langGerman">Deutsch</option>
                    <option value="es" data-i18n="langSpanish">Español</option>
                    <option value="la" data-i18n="langLatin">Latin</option>
                    <option value="ja" data-i18n="langJapanese">日本語</option>
                </select>
                <button id="menu-toggle" class="text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white">
            <a href="#" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="home">首頁</a>
            <a href="#map" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="map">地圖</a>
            <a href="#shops" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="shopList">商店列表</a>
            <a href="#newsletter" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="newsletter">訂閱電子報</a>
            <a href="#report-issue" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="reportIssueNavLink">問題回報</a>
        </div>
    </nav>

    <section class="hero-section py-20 md:py-32 text-white">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">探索台灣永續商店</h1>
            <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力</p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <a href="#map" class="btn-primary px-8 py-3 rounded-lg font-medium" data-i18n="viewMapBtn">查看地圖</a>
                <a href="#shops" class="bg-white text-green-600 px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="browseShopsBtn">瀏覽商店列表</a>
            </div>
        </div>
    </section>

    <section class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">搜尋永續商店</h2>
                        <div class="flex">
                            <input type="text" id="search-input" placeholder="" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" data-i18n="searchPlaceholder">
                            <button id="search-button" class="btn-primary px-6 py-3 rounded-r-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium mb-3" data-i18n="filterCategoryTitle">依類別篩選</h3>
                        <div class="flex flex-wrap gap-2" id="filter-buttons-container">
                            <button class="tag px-3 py-1 rounded-full text-sm active" data-i18n="filterAll" data-category="all">全部</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterApparel" data-category="apparel">服飾</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterFood" data-category="food">食品</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterCafe" data-category="cafe">咖啡廳</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterHomeGoods" data-category="homeGoods">家居用品</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterZeroWaste" data-category="zeroWaste">無包裝商店</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterSecondHand" data-category="secondHand">二手商店</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterCreative" data-category="creative">文創</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="map" class="py-12 bg-green-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">永續商店地圖</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="map-container">
                    <div id="sustainability-map" class="h-96 md:h-[500px] w-full"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="shops" class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">永續商店列表</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="shop-cards-container">
                <!-- Shop cards will be injected here -->
            </div>
            <div class="text-center mt-8">
                <button id="load-more-button" class="btn-primary px-8 py-3 rounded-lg font-medium hidden" data-i18n="loadMoreBtn">載入更多</button>
            </div>
        </div>
    </section>

    <section id="newsletter" class="py-12 bg-green-600 text-white">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto text-center">
                <h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">訂閱永續生活電子報</h2>
                <p class="mb-6" data-i18n="newsletterSubtitle">獲取最新的永續商店資訊、環保生活技巧和特別優惠</p>
                <div class="flex flex-col md:flex-row gap-2">
                    <input type="email" id="newsletter-email" placeholder="" class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none" data-i18n="newsletterPlaceholder">
                    <button id="subscribe-button" class="bg-white text-green-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="subscribeBtn">訂閱</button>
                </div>
            </div>
        </div>
    </section>

    <section id="report-issue" class="py-12 bg-yellow-50">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-3xl font-bold text-center mb-6" data-i18n="reportIssueTitle">問題回報</h2>
                <form id="issue-form">
                    <div class="mb-4">
                        <label for="issue" class="block text-gray-700 text-sm font-bold mb-2" data-i18n="reportIssueLabel">請描述您遇到的問題：</label>
                        <textarea id="issue" name="issue" rows="6" required
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                  data-i18n="reportIssuePlaceholder"
                                  placeholder="例如：某間商店資訊錯誤、地圖位置有誤..."></textarea>
                    </div>
                    <div class="text-center">
                        <button type="submit"
                                class="btn-primary px-6 py-2 rounded-lg font-medium"
                                data-i18n="reportIssueSubmitBtn">
                            送出回報
                        </button>
                    </div>
                </form>
                <p id="issue-message" class="text-center text-green-600 mt-4 hidden" data-i18n="reportIssueSuccessMsg">感謝您的回報，我們會儘快處理！</p>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-10">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="footerAppName">永續商店地圖</h3>
                    <p class="text-gray-300" data-i18n="footerAppDescription">幫助消費者找到並支持永續發展的商店，一起為地球盡一份心力。</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="contactUsTitle">聯絡我們</h3>
                    <p class="text-gray-300" data-i18n="contactUsText">有任何問題或建議，歡迎與我們聯繫</p>
                    <p class="text-gray-300" data-i18n="contactUsEmail">電子郵件：artistworld0815@gmail.com</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="followUsTitle">關注我們</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p data-i18n="copyright">© 2025 永續商店地圖 - 版權所有</p>
            </div>
        </div>
    </footer>

    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center modal">
        <div class="bg-white rounded-xl max-w-4xl w-full mx-4 modal-content">
            <div id="shop-detail-content" class="relative">
                <!-- Shop detail content will be injected here -->
            </div>
        </div>
    </div>

    <div id="custom-message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto text-center">
            <p id="message-modal-text" class="text-gray-800 text-lg mb-4"></p>
            <button id="close-message-modal" class="btn-primary px-6 py-2 rounded-lg font-medium" data-i18n="okButton">確定</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // [MODIFIED] Updated Google Apps Script URL
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4NR0LWj6j27lB_1-LxIDthj2ihaGyEQTQ1hqUNMyX5KC7a1bQtzpZwJYQVvq-6aILUA/exec';
        const ADMIN_PASSWORD = 'index@1215312836';
        
        // EmailJS Configuration
        const EMAILJS_PUBLIC_KEY = '4dCp-T-DcTtjFzpuA';
        const EMAILJS_SERVICE_ID = 'service_1o6wdpm';
        const EMAILJS_TEMPLATE_ID = 'template_ibn7ezs';

        // Initialize EmailJS (check if emailjs is loaded)
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        }

        // Admin mode state
        let isAdminMode = false;

        // Language translation data
        const translations = {
            'zh-TW': {
                pageTitle: '永續商店地圖 - 首頁',
                appName: '永續商店地圖',
                home: '首頁',
                map: '地圖',
                shopList: '商店列表',
                newsletter: '訂閱電子報',
                reportIssueNavLink: '問題回報',
                langChinese: '繁體中文',
                langEnglish: 'English',
                langFrench: 'Français',
                langGerman: 'Deutsch',
                langSpanish: 'Español',
                langLatin: 'Latin',
                langJapanese: '日本語',
                heroTitle: '探索台灣永續商店',
                heroSubtitle: '找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力',
                viewMapBtn: '查看地圖',
                browseShopsBtn: '瀏覽商店列表',
                searchTitle: '搜尋永續商店',
                searchPlaceholder: '輸入商店名稱或地址...',
                filterCategoryTitle: '依類別篩選',
                filterAll: '全部',
                filterApparel: '服飾',
                filterFood: '食品',
                filterCafe: '咖啡廳',
                filterHomeGoods: '家居用品',
                filterZeroWaste: '無包裝商店',
                filterSecondHand: '二手商店',
                filterCreative: '文創',
                mapSectionTitle: '永續商店地圖',
                shopListSectionTitle: '永續商店列表',
                viewDetailsBtn: '查看詳情',
                loadMoreBtn: '載入更多',
                newsletterTitle: '訂閱永續生活電子報',
                newsletterSubtitle: '獲取最新的永續商店資訊、環保生活技巧和特別優惠',
                newsletterPlaceholder: '您的電子郵件',
                subscribeBtn: '訂閱',
                reportIssueTitle: '問題回報',
                reportIssueLabel: '請描述您遇到的問題：',
                reportIssuePlaceholder: '例如：某間商店資訊錯誤、地圖位置有誤...',
                reportIssueSubmitBtn: '送出回報',
                reportIssueSuccessMsg: '感謝您的回報，我們會儘快處理！',
                reportIssueErrorMsg: '回報失敗，請稍後再試。',
                footerAppName: '永續商店地圖',
                footerAppDescription: '幫助消費者找到並支持永續發展的商店，一起為地球盡一份心力。',
                contactUsTitle: '聯絡我們',
                contactUsText: '有任何問題或建議，歡迎與我們聯繫',
                contactUsEmail: '電子郵件：artistworld0815@gmail.com',
                followUsTitle: '關注我們',
                copyright: '© 2025 永續商店地圖 - 版權所有',
                modalAboutUs: '關於我們',
                modalSustainability: '永續理念',
                modalVideoIntro: '影片介紹',
                modalLatestCollections: '最新系列',
                modalShopInfo: '商店資訊',
                modalAddress: '地址',
                modalOpeningHours: '營業時間',
                modalContactInfo: '聯絡方式',
                modalPhone: '電話',
                modalEmail: 'Email',
                modalWebsite: '網站',
                modalSocialMedia: '社群媒體',
                modalLocation: '位置',
                shopDetailsNotAvailable: '此店家詳情尚未建立，敬請期待！',
                okButton: '確定',
                notProvided: '未提供',
                newsletterSuccess: '感謝您的訂閱！您將收到我們的最新消息。',
                newsletterInvalidEmail: '請輸入有效的電子郵件地址。',
                newsletterError: '訂閱失敗，請稍後再試。',
                adminRecommendBtn: '📧 推薦此店家給所有訂閱者',
                adminLoginPrompt: '請輸入管理員密碼：',
                adminLoginFailed: '密碼錯誤！',
                adminLoginSuccess: '已進入管理員模式',
                recommendationSending: '正在發送推薦信...',
                recommendationSent: '推薦信已成功發送給所有訂閱者！',
                recommendationFailed: '發送推薦信失敗，請稍後再試。',
            },
            'en': {
                pageTitle: 'Sustainable Store Map - Home',
                appName: 'Sustainable Store Map',
                home: 'Home',
                map: 'Map',
                shopList: 'Shop List',
                newsletter: 'Newsletter',
                reportIssueNavLink: 'Report Issue',
                langChinese: '繁體中文',
                langEnglish: 'English',
                langFrench: 'Français',
                langGerman: 'Deutsch',
                langSpanish: 'Español',
                langLatin: 'Latin',
                langJapanese: '日本語',
                heroTitle: 'Explore Taiwan\'s Sustainable Stores',
                heroSubtitle: 'Find stores that support environmental protection, fair trade, and sustainable development, and contribute to the Earth together.',
                viewMapBtn: 'View Map',
                browseShopsBtn: 'Browse Shop List',
                searchTitle: 'Search Sustainable Stores',
                searchPlaceholder: 'Enter store name or address...',
                filterCategoryTitle: 'Filter by Category',
                filterAll: 'All',
                filterApparel: 'Apparel',
                filterFood: 'Food',
                filterCafe: 'Cafe',
                filterHomeGoods: 'Home Goods',
                filterZeroWaste: 'Zero-Waste Stores',
                filterSecondHand: 'Second-hand Stores',
                filterCreative: 'Creative & Cultural',
                mapSectionTitle: 'Sustainable Store Map',
                shopListSectionTitle: 'Sustainable Shop List',
                viewDetailsBtn: 'View Details',
                loadMoreBtn: 'Load More',
                newsletterTitle: 'Subscribe to Sustainable Living Newsletter',
                newsletterSubtitle: 'Get the latest sustainable store information, eco-friendly living tips, and special offers',
                newsletterPlaceholder: 'Your email',
                subscribeBtn: 'Subscribe',
                reportIssueTitle: 'Report an Issue',
                reportIssueLabel: 'Please describe the issue you encountered:',
                reportIssuePlaceholder: 'e.g., Incorrect store information, wrong map location...',
                reportIssueSubmitBtn: 'Submit Report',
                reportIssueSuccessMsg: 'Thank you for your report, we will process it soon!',
                reportIssueErrorMsg: 'Failed to submit report. Please try again later.',
                footerAppName: 'Sustainable Store Map',
                footerAppDescription: 'Helping consumers find and support sustainable development stores, contributing to the Earth together.',
                contactUsTitle: 'Contact Us',
                contactUsText: 'For any questions or suggestions, please contact us',
                contactUsEmail: 'Email: artistworld0815@gmail.com',
                followUsTitle: 'Follow Us',
                copyright: '© 2025 Sustainable Store Map - All Rights Reserved',
                modalAboutUs: 'About Us',
                modalSustainability: 'Sustainability Philosophy',
                modalVideoIntro: 'Video Introduction',
                modalLatestCollections: 'Latest Collections',
                modalShopInfo: 'Store Information',
                modalAddress: 'Address',
                modalOpeningHours: 'Opening Hours',
                modalContactInfo: 'Contact Info',
                modalPhone: 'Phone',
                modalEmail: 'Email',
                modalWebsite: 'Website',
                modalSocialMedia: 'Social Media',
                modalLocation: 'Location',
                shopDetailsNotAvailable: 'Shop details not yet available, please look forward to it!',
                okButton: 'OK',
                notProvided: 'Not provided',
                newsletterSuccess: 'Thank you for subscribing! You will receive our latest news.',
                newsletterInvalidEmail: 'Please enter a valid email address.',
                newsletterError: 'Subscription failed, please try again later.',
                adminRecommendBtn: '📧 Recommend this store to all subscribers',
                adminLoginPrompt: 'Please enter admin password:',
                adminLoginFailed: 'Incorrect password!',
                adminLoginSuccess: 'Admin mode activated',
                recommendationSending: 'Sending recommendation email...',
                recommendationSent: 'Recommendation email sent successfully to all subscribers!',
                recommendationFailed: 'Failed to send recommendation email, please try again later.',
            },
            'fr': {
                pageTitle: 'Carte des Magasins Durables - Accueil',
                appName: 'Carte des Magasins Durables',
                home: 'Accueil',
                map: 'Carte',
                shopList: 'Liste des Magasins',
                newsletter: 'Newsletter',
                reportIssueNavLink: 'Signaler un Problème',
                langChinese: '繁體中文',
                langEnglish: 'English',
                langFrench: 'Français',
                langGerman: 'Deutsch',
                langSpanish: 'Español',
                langLatin: 'Latin',
                langJapanese: '日本語',
                heroTitle: 'Découvrez les Magasins Durables de Taïwan',
                heroSubtitle: 'Trouvez des magasins qui soutiennent la protection de l\'environnement, le commerce équitable et le développement durable.',
                viewMapBtn: 'Voir la Carte',
                browseShopsBtn: 'Parcourir les Magasins',
                searchTitle: 'Rechercher des Magasins Durables',
                searchPlaceholder: 'Entrez le nom ou l\'adresse du magasin...',
                filterCategoryTitle: 'Filtrer par Catégorie',
                filterAll: 'Tous',
                filterApparel: 'Vêtements',
                filterFood: 'Alimentation',
                filterCafe: 'Café',
                filterHomeGoods: 'Articles Ménagers',
                filterZeroWaste: 'Magasins Zéro Déchet',
                filterSecondHand: 'Magasins d\'Occasion',
                filterCreative: 'Créatif et Culturel',
                mapSectionTitle: 'Carte des Magasins Durables',
                shopListSectionTitle: 'Liste des Magasins Durables',
                viewDetailsBtn: 'Voir les Détails',
                loadMoreBtn: 'Charger Plus',
                newsletterTitle: 'Abonnez-vous à la Newsletter sur la Vie Durable',
                newsletterSubtitle: 'Recevez les dernières informations sur les magasins durables, des conseils de vie écologique et des offres spéciales.',
                newsletterPlaceholder: 'Votre email',
                subscribeBtn: 'S\'abonner',
                reportIssueTitle: 'Signaler un Problème',
                reportIssueLabel: 'Veuillez décrire le problème que vous avez rencontré :',
                reportIssuePlaceholder: 'Ex: Informations incorrectes sur un magasin, mauvais emplacement sur la carte...',
                reportIssueSubmitBtn: 'Envoyer le Rapport',
                reportIssueSuccessMsg: 'Merci pour votre rapport, nous le traiterons bientôt !',
                reportIssueErrorMsg: 'Échec de l\'envoi du rapport. Veuillez réessayer plus tard.',
                footerAppName: 'Carte des Magasins Durables',
                footerAppDescription: 'Aider les consommateurs à trouver et à soutenir les magasins de développement durable.',
                contactUsTitle: 'Contactez-nous',
                contactUsText: 'Pour toute question ou suggestion, veuillez nous contacter.',
                contactUsEmail: 'Email: artistworld0815@gmail.com',
                followUsTitle: 'Suivez-nous',
                copyright: '© 2025 Carte des Magasins Durables - Tous Droits Réservés',
                modalAboutUs: 'À Propos de Nous',
                modalSustainability: 'Philosophie de Durabilité',
                okButton: 'OK',
                notProvided: 'Non fourni',
                newsletterSuccess: 'Merci pour votre abonnement !',
                newsletterInvalidEmail: 'Veuillez entrer une adresse email valide.',
                newsletterError: 'L\'abonnement a échoué, veuillez réessayer.',
            },
            'de': {
                pageTitle: 'Nachhaltigkeitsladen-Karte - Startseite',
                appName: 'Nachhaltigkeitsladen-Karte',
                home: 'Startseite',
                map: 'Karte',
                shopList: 'Ladenliste',
                newsletter: 'Newsletter',
                reportIssueNavLink: 'Problem Melden',
                langChinese: '繁體中文',
                langEnglish: 'English',
                langFrench: 'Français',
                langGerman: 'Deutsch',
                langSpanish: 'Español',
                langLatin: 'Latin',
                langJapanese: '日本語',
                heroTitle: 'Entdecken Sie Taiwans nachhaltige Läden',
                heroSubtitle: 'Finden Sie Geschäfte, die Umweltschutz, fairen Handel und nachhaltige Entwicklung unterstützen.',
                viewMapBtn: 'Karte Anzeigen',
                browseShopsBtn: 'Läden Durchsuchen',
                searchTitle: 'Nachhaltige Läden Suchen',
                searchPlaceholder: 'Ladennamen oder Adresse eingeben...',
                filterCategoryTitle: 'Nach Kategorie Filtern',
                filterAll: 'Alle',
                filterApparel: 'Kleidung',
                filterFood: 'Lebensmittel',
                filterCafe: 'Café',
                filterHomeGoods: 'Haushaltswaren',
                filterZeroWaste: 'Unverpackt-Läden',
                filterSecondHand: 'Second-Hand-Läden',
                filterCreative: 'Kreativ & Kulturell',
                mapSectionTitle: 'Nachhaltigkeitsladen-Karte',
                shopListSectionTitle: 'Liste Nachhaltiger Läden',
                viewDetailsBtn: 'Details Anzeigen',
                loadMoreBtn: 'Mehr Laden',
                newsletterTitle: 'Abonnieren Sie den Newsletter für nachhaltiges Leben',
                newsletterSubtitle: 'Erhalten Sie die neuesten Informationen zu nachhaltigen Geschäften, umweltfreundliche Tipps und Sonderangebote.',
                newsletterPlaceholder: 'Ihre E-Mail',
                subscribeBtn: 'Abonnieren',
                reportIssueTitle: 'Ein Problem Melden',
                reportIssueLabel: 'Bitte beschreiben Sie das aufgetretene Problem:',
                reportIssuePlaceholder: 'z.B. Falsche Ladeninformationen, falscher Kartenstandort...',
                reportIssueSubmitBtn: 'Bericht Senden',
                reportIssueSuccessMsg: 'Vielen Dank für Ihre Meldung, wir werden sie bald bearbeiten!',
                reportIssueErrorMsg: 'Fehler beim Senden des Berichts. Bitte versuchen Sie es später erneut.',
                footerAppName: 'Nachhaltigkeitsladen-Karte',
                footerAppDescription: 'Verbrauchern helfen, nachhaltige Entwicklungsläden zu finden und zu unterstützen.',
                contactUsTitle: 'Kontaktieren Sie Uns',
                contactUsText: 'Bei Fragen oder Anregungen kontaktieren Sie uns bitte.',
                contactUsEmail: 'E-Mail: artistworld0815@gmail.com',
                followUsTitle: 'Folgen Sie Uns',
                copyright: '© 2025 Nachhaltigkeitsladen-Karte - Alle Rechte Vorbehalten',
                modalAboutUs: 'Über Uns',
                modalSustainability: 'Nachhaltigkeitsphilosophie',
                okButton: 'OK',
                notProvided: 'Nicht angegeben',
                newsletterSuccess: 'Danke für Ihr Abonnement!',
                newsletterInvalidEmail: 'Bitte geben Sie eine gültige E-Mail-Adresse ein.',
                newsletterError: 'Abonnement fehlgeschlagen, bitte versuchen Sie es erneut.',
            },
            'es': {
                pageTitle: 'Mapa de Tiendas Sostenibles - Inicio',
                appName: 'Mapa de Tiendas Sostenibles',
                home: 'Inicio',
                map: 'Mapa',
                shopList: 'Lista de Tiendas',
                newsletter: 'Boletín',
                reportIssueNavLink: 'Reportar un Problema',
                langChinese: '繁體中文',
                langEnglish: 'English',
                langFrench: 'Français',
                langGerman: 'Deutsch',
                langSpanish: 'Español',
                langLatin: 'Latin',
                langJapanese: '日本語',
                heroTitle: 'Explore las Tiendas Sostenibles de Taiwán',
                heroSubtitle: 'Encuentre tiendas que apoyan la protección del medio ambiente, el comercio justo y el desarrollo sostenible.',
                viewMapBtn: 'Ver Mapa',
                browseShopsBtn: 'Explorar Tiendas',
                searchTitle: 'Buscar Tiendas Sostenibles',
                searchPlaceholder: 'Ingrese el nombre o la dirección de la tienda...',
                filterCategoryTitle: 'Filtrar por Categoría',
                filterAll: 'Todas',
                filterApparel: 'Ropa',
                filterFood: 'Comida',
                filterCafe: 'Cafetería',
                filterHomeGoods: 'Artículos para el Hogar',
                filterZeroWaste: 'Tiendas sin Residuos',
                filterSecondHand: 'Tiendas de Segunda Mano',
                filterCreative: 'Creativo y Cultural',
                mapSectionTitle: 'Mapa de Tiendas Sostenibles',
                shopListSectionTitle: 'Lista de Tiendas Sostenibles',
                viewDetailsBtn: 'Ver Detalles',
                loadMoreBtn: 'Cargar Más',
                newsletterTitle: 'Suscríbase al Boletín de Vida Sostenible',
                newsletterSubtitle: 'Obtenga la información más reciente sobre tiendas sostenibles, consejos de vida ecológica y ofertas especiales.',
                newsletterPlaceholder: 'Tu correo electrónico',
                subscribeBtn: 'Suscribirse',
                reportIssueTitle: 'Reportar un Problema',
                reportIssueLabel: 'Por favor, describa el problema que encontró:',
                reportIssuePlaceholder: 'Ej: Información incorrecta de la tienda, ubicación incorrecta en el mapa...',
                reportIssueSubmitBtn: 'Enviar Reporte',
                reportIssueSuccessMsg: '¡Gracias por su informe, lo procesaremos pronto!',
                reportIssueErrorMsg: 'Error al enviar el informe. Por favor, inténtelo de nuevo más tarde.',
                footerAppName: 'Mapa de Tiendas Sostenibles',
                footerAppDescription: 'Ayudando a los consumidores a encontrar y apoyar tiendas de desarrollo sostenible.',
                contactUsTitle: 'Contáctenos',
                contactUsText: 'Para cualquier pregunta o sugerencia, por favor contáctenos.',
                contactUsEmail: 'Correo: artistworld0815@gmail.com',
                followUsTitle: 'Síganos',
                copyright: '© 2025 Mapa de Tiendas Sostenibles - Todos los Derechos Reservados',
                modalAboutUs: 'Sobre Nosotros',
                modalSustainability: 'Filosofía de Sostenibilidad',
                okButton: 'OK',
                notProvided: 'No proporcionado',
                newsletterSuccess: '¡Gracias por suscribirte!',
                newsletterInvalidEmail: 'Por favor, introduce una dirección de correo electrónico válida.',
                newsletterError: 'La suscripción falló, por favor inténtalo de nuevo.',
            },
            'la': {
                pageTitle: 'Tabula Tabernarum Durabilium - Domus',
                appName: 'Tabula Tabernarum Durabilium',
                home: 'Domus',
                map: 'Tabula',
                shopList: 'Index Tabernarum',
                newsletter: 'Epistula',
                reportIssueNavLink: 'Nuntia Problema',
                langChinese: '繁體中文',
                langEnglish: 'English',
                langFrench: 'Français',
                langGerman: 'Deutsch',
                langSpanish: 'Español',
                langLatin: 'Latin',
                langJapanese: '日本語',
                heroTitle: 'Explora Tabernas Durabiles Taivaniae',
                heroSubtitle: 'Inveni tabernas quae ambitum tuentur, commercium aequum et progressum durabilem fovent.',
                viewMapBtn: 'Vide Tabulam',
                browseShopsBtn: 'Explora Tabernas',
                searchTitle: 'Quaere Tabernas Durabiles',
                searchPlaceholder: 'Nomen vel inscriptionem tabernae inscribe...',
                filterCategoryTitle: 'Filtra per Genus',
                filterAll: 'Omnes',
                filterApparel: 'Vestimenta',
                filterFood: 'Cibus',
                filterCafe: 'Cafea',
                filterHomeGoods: 'Res Domesticae',
                filterZeroWaste: 'Tabernae Sine Scirpo',
                filterSecondHand: 'Tabernae Rerum Usuarum',
                filterCreative: 'Creativum et Culturale',
                mapSectionTitle: 'Tabula Tabernarum Durabilium',
                shopListSectionTitle: 'Index Tabernarum Durabilium',
                viewDetailsBtn: 'Vide Singula',
                loadMoreBtn: 'Plus Onera',
                newsletterTitle: 'Scribe ad Epistulam de Vita Durabili',
                newsletterSubtitle: 'Accipe novissimas informationes de tabernis durabilibus, consilia vitae oecologicae et oblationes speciales.',
                newsletterPlaceholder: 'Tuum electronicum',
                subscribeBtn: 'Scribe',
                reportIssueTitle: 'Nuntia Problema',
                reportIssueLabel: 'Quaeso describe problema quod invenisti:',
                reportIssuePlaceholder: 'Ex: Informatio falsa de taberna, locus falsus in tabula...',
                reportIssueSubmitBtn: 'Mitte Nuntium',
                reportIssueSuccessMsg: 'Gratias pro nuntio tuo, mox eum tractabimus!',
                reportIssueErrorMsg: 'Error in mittendo nuntio. Quaeso, postea iterum conare.',
                footerAppName: 'Tabula Tabernarum Durabilium',
                footerAppDescription: 'Consumptores adiuvantes ad inveniendas et sustinendas tabernas progressus durabilis.',
                contactUsTitle: 'Contacta Nos',
                contactUsText: 'Pro quibusvis quaestionibus vel suggestionibus, quaeso nos contacta.',
                contactUsEmail: 'Electronicum: artistworld0815@gmail.com',
                followUsTitle: 'Sequere Nos',
                copyright: '© 2025 Tabula Tabernarum Durabilium - Omnia Iura Reservata',
                modalAboutUs: 'De Nobis',
                modalSustainability: 'Philosophia Durabilitatis',
                okButton: 'OK',
                notProvided: 'Non provisum',
                newsletterSuccess: 'Gratias pro subscriptione!',
                newsletterInvalidEmail: 'Quaeso, inscriptionem electronicam validam inscribe.',
                newsletterError: 'Subscriptio fefellit, quaeso iterum conare.',
            },
            'ja': {
                pageTitle: 'サステナブルストアマップ - ホーム',
                appName: 'サステナブルストアマップ',
                home: 'ホーム',
                map: '地図',
                shopList: '店舗リスト',
                newsletter: 'ニュースレター',
                reportIssueNavLink: '問題を報告',
                langChinese: '繁體中文',
                langEnglish: 'English',
                langFrench: 'Français',
                langGerman: 'Deutsch',
                langSpanish: 'Español',
                langLatin: 'Latin',
                langJapanese: '日本語',
                heroTitle: '台湾のサステナブルストアを探検',
                heroSubtitle: '環境保護、フェアトレード、持続可能な開発を支援する店舗を見つけ、地球に貢献しましょう。',
                viewMapBtn: '地図を見る',
                browseShopsBtn: '店舗を閲覧',
                searchTitle: 'サステナブルストアを検索',
                searchPlaceholder: '店舗名または住所を入力...',
                filterCategoryTitle: 'カテゴリーで絞り込む',
                filterAll: 'すべて',
                filterApparel: 'アパレル',
                filterFood: '食品',
                filterCafe: 'カフェ',
                filterHomeGoods: '家庭用品',
                filterZeroWaste: 'ゼロウェイストストア',
                filterSecondHand: '中古店',
                filterCreative: 'クリエイティブ・文化',
                mapSectionTitle: 'サステナブルストアマップ',
                shopListSectionTitle: 'サステナブルストアリスト',
                viewDetailsBtn: '詳細を見る',
                loadMoreBtn: 'さらに読み込む',
                newsletterTitle: 'サステナブルな生活ニュースレターを購読',
                newsletterSubtitle: '最新のサステナブルストア情報、エコな生活のヒント、特別オファーを入手できます。',
                newsletterPlaceholder: 'あなたのメールアドレス',
                subscribeBtn: '購読する',
                reportIssueTitle: '問題を報告',
                reportIssueLabel: '発生した問題を説明してください：',
                reportIssuePlaceholder: '例：店舗情報の間違い、地図の場所が違うなど...',
                reportIssueSubmitBtn: '報告を送信',
                reportIssueSuccessMsg: 'ご報告ありがとうございます。すぐに対応いたします！',
                reportIssueErrorMsg: '報告の送信に失敗しました。後でもう一度お試しください。',
                footerAppName: 'サステナブルストアマップ',
                footerAppDescription: '消費者が持続可能な開発店舗を見つけて支援するのを助けます。',
                contactUsTitle: 'お問い合わせ',
                contactUsText: 'ご質問やご提案がございましたら、お問い合わせください。',
                contactUsEmail: 'メール: artistworld0815@gmail.com',
                followUsTitle: 'フォローする',
                copyright: '© 2025 サステナブルストアマップ - 無断複写・転載を禁じます',
                modalAboutUs: '私たちについて',
                modalSustainability: 'サステナビリティ哲学',
                okButton: 'OK',
                notProvided: '提供されていません',
                newsletterSuccess: 'ご購読ありがとうございます！',
                newsletterInvalidEmail: '有効なメールアドレスを入力してください。',
                newsletterError: '購読に失敗しました。もう一度お試しください。',
            }
        };

        let currentLang = localStorage.getItem('lang') || 'zh-TW';

        // Shop data with complete multilingual support
        const shopDetails = {
            "eco-goodies": {
                name: { 'zh-TW': "綠好物", 'en': "Eco Goodies" },
                type: { 'zh-TW': "家居用品", 'en': "Home Goods" },
                address: { 'zh-TW': "106台北市大安區信義路四段187之2號", 'en': "No. 187-2, Sec. 4, Xinyi Rd., Da'an Dist., Taipei City 106, Taiwan" },
                hours: { 'zh-TW': "週一至三、五 11:00-19:00，週四 12:00-19:00，週六日休息", 'en': "Mon-Wed, Fri 11:00-19:00, Thu 12:00-19:00, Closed Sat-Sun" },
                phone: "02 2706 8819",
                email: "service@ecogoodies.com.tw",
                website: "ecogoodies.com.tw",
                description: { 'zh-TW': "綠好物是一家專注於提供環保、永續生活用品的商店，致力於推廣零廢棄生活方式。", 'en': "Eco Goodies specializes in eco-friendly and sustainable home products, promoting a zero-waste lifestyle." },
                longDescription: { 'zh-TW': "我們提供各種環保替代品，從日常生活用品到個人護理產品，幫助消費者減少塑料使用和環境足跡。我們的產品經過嚴格篩選，確保它們是真正環保且實用的。", 'en': "We offer a wide range of eco-friendly alternatives, from daily necessities to personal care products, helping consumers reduce plastic use and environmental footprint. Our products are rigorously screened to ensure they are truly eco-friendly and practical." },
                sustainability: { 'zh-TW': "我們的使命是讓永續生活變得簡單且可行。我們的產品都經過嚴格篩選，確保它們是真正環保、耐用且實用的。我們優先選擇使用可再生材料、可生物降解或可回收的產品，並與符合道德標準的供應商合作。", 'en': "Our mission is to make sustainable living simple and achievable. Our products are rigorously screened to ensure they are truly eco-friendly, durable, and practical. We prioritize products made from renewable, biodegradable, or recyclable materials, and partner with ethically compliant suppliers." },
                tags: { 'zh-TW': ["零廢棄", "環保生活", "可重複使用", "無塑", "永續消費"], 'en': ["Zero-Waste", "Eco-friendly Living", "Reusable", "Plastic-Free", "Sustainable Consumption"] },
                lat: 25.0330,
                lng: 121.5654,
                collections: [
                    {
                        name: { 'zh-TW': "廚房零廢棄系列", 'en': "Zero-Waste Kitchen Collection" },
                        description: { 'zh-TW': "包括可重複使用的食物保鮮袋、蜂蠟保鮮膜、竹製餐具等，幫助您建立一個無塑廚房。", 'en': "Includes reusable food storage bags, beeswax wraps, bamboo utensils, etc., to help you create a plastic-free kitchen." }
                    },
                    {
                        name: { 'zh-TW': "個人護理系列", 'en': "Personal Care Collection" },
                        description: { 'zh-TW': "提供天然成分製成的肥皂、洗髮餅、竹牙刷等，減少塑料包裝和有害化學物質。", 'en': "Offers soaps, shampoo bars, bamboo toothbrushes made from natural ingredients, reducing plastic packaging and harmful chemicals." }
                    }
                ]
            },
            "sustainable-cafe": {
                name: { 'zh-TW': "永續咖啡", 'en': "Sustainable Cafe" },
                type: { 'zh-TW': "咖啡廳", 'en': "Cafe" },
                address: { 'zh-TW': "110台北市信義區松壽路11號", 'en': "No. 11, Songshou Rd., Xinyi Dist., Taipei City 110, Taiwan" },
                hours: { 'zh-TW': "每日 08:00-21:00", 'en': "Daily 08:00-21:00" },
                phone: "02 2722 5566",
                email: "hello@sustainablecafe.tw",
                website: "sustainablecafe.tw",
                description: { 'zh-TW': "專注於公平貿易咖啡豆和永續經營理念的咖啡廳，提供有機美食。", 'en': "A cafe focused on fair trade coffee beans and sustainable business practices, serving organic food." },
                longDescription: { 'zh-TW': "我們堅持使用公平貿易認證的咖啡豆，與產地農民建立直接合作關係。店內採用環保材料裝潢，提供可重複使用的杯具，並推廣減塑生活。", 'en': "We insist on using fair trade certified coffee beans and establish direct partnerships with origin farmers. The store uses eco-friendly decoration materials, provides reusable cups, and promotes plastic-free living." },
                sustainability: { 'zh-TW': "支持公平貿易，確保咖啡農獲得合理報酬。使用可再生能源，實施零廢棄政策，所有包裝材料均可回收或可堆肥。", 'en': "Supporting fair trade to ensure coffee farmers receive fair compensation. Using renewable energy, implementing zero-waste policies, all packaging materials are recyclable or compostable." },
                tags: { 'zh-TW': ["公平貿易", "有機咖啡", "零廢棄", "可回收包裝"], 'en': ["Fair Trade", "Organic Coffee", "Zero Waste", "Recyclable Packaging"] },
                lat: 25.0369,
                lng: 121.5645
            },
            "green-fashion": {
                name: { 'zh-TW': "綠色時尚", 'en': "Green Fashion" },
                type: { 'zh-TW': "服飾", 'en': "Apparel" },
                address: { 'zh-TW': "104台北市中山區南京東路三段219號", 'en': "No. 219, Sec. 3, Nanjing E. Rd., Zhongshan Dist., Taipei City 104, Taiwan" },
                hours: { 'zh-TW': "週二至日 11:00-20:00，週一休息", 'en': "Tue-Sun 11:00-20:00, Closed Mon" },
                phone: "02 2545 7788",
                email: "info@greenfashion.com.tw",
                website: "greenfashion.com.tw",
                description: { 'zh-TW': "販售有機棉、再生纖維等環保材質製作的時尚服飾。", 'en': "Selling fashionable clothing made from eco-friendly materials like organic cotton and recycled fibers." },
                longDescription: { 'zh-TW': "我們致力於推廣永續時尚，所有服飾均採用有機棉、天絲、再生聚酯纖維等環保材料製作。與國際認證工廠合作，確保生產過程符合環保和勞工權益標準。", 'en': "We are committed to promoting sustainable fashion. All clothing is made from eco-friendly materials such as organic cotton, Tencel, and recycled polyester. We partner with internationally certified factories to ensure production processes meet environmental and labor rights standards." },
                sustainability: { 'zh-TW': "使用有機和再生材料，支持循環經濟。工廠符合GOTS有機紡織品標準，確保從原料到成品的環保生產鏈。", 'en': "Using organic and recycled materials to support circular economy. Factories comply with GOTS organic textile standards, ensuring an eco-friendly production chain from raw materials to finished products." },
                tags: { 'zh-TW': ["有機棉", "再生纖維", "公平勞動", "循環時尚"], 'en': ["Organic Cotton", "Recycled Fibers", "Fair Labor", "Circular Fashion"] },
                lat: 25.0522,
                lng: 121.5437
            }
        };

        const shops = Object.keys(shopDetails).map(id => ({
            id: id,
            lat: shopDetails[id].lat,
            lng: shopDetails[id].lng
        }));

        // ===== GLOBAL VARIABLES =====
        let currentFilterCategory = 'all';
        let currentSearchQuery = '';
        const shopsPerPage = 6;
        let currentLoadedShops = 0;
        let mapInstance;
        let markersGroup = L.featureGroup();

        // ===== ADMIN FUNCTIONS =====
        function promptAdminLogin() {
            const password = prompt(translations[currentLang].adminLoginPrompt);
            if (password === ADMIN_PASSWORD) {
                isAdminMode = true;
                document.getElementById('admin-indicator').classList.remove('hidden');
                showMessageModal(translations[currentLang].adminLoginSuccess);
            } else if (password !== null) {
                showMessageModal(translations[currentLang].adminLoginFailed);
            }
        }

        // Make admin trigger accessible globally for keyboard shortcut
        window.promptAdminLogin = promptAdminLogin;

        // Admin keyboard shortcut (Ctrl+Shift+A)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                promptAdminLogin();
            }
        });

        // ===== EMAIL FUNCTIONS =====
        async function getSubscriberEmails() {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL + '?action=getEmails');
                const data = await response.json();
                if (data.success && data.emails) {
                    return data.emails;
                } else {
                    console.error('Error from Apps Script:', data.error);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching subscriber emails:', error);
                return [];
            }
        }

        async function sendRecommendationEmail(shopId) {
            if (typeof emailjs === 'undefined') {
                console.error('EmailJS not loaded');
                showMessageModal('EmailJS service not available');
                return;
            }

            const shop = shopDetails[shopId];
            if (!shop) return;

            try {
                showMessageModal(translations[currentLang].recommendationSending);
                
                const emails = await getSubscriberEmails();
                if (emails.length === 0) {
                    showMessageModal('沒有找到訂閱者');
                    return;
                }

                // Prepare email template parameters
                const templateParams = {
                    shop_name: shop.name[currentLang] || shop.name['zh-TW'],
                    shop_description: shop.description[currentLang] || shop.description['zh-TW'],
                    shop_address: shop.address[currentLang] || shop.address['zh-TW'],
                    shop_phone: shop.phone || '未提供',
                    shop_website: shop.website || '未提供',
                    subscriber_emails: emails.join(','), // EmailJS will handle multiple recipients
                };

                // Send email via EmailJS
                const result = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                
                if (result.status === 200) {
                    showMessageModal(translations[currentLang].recommendationSent);
                } else {
                    throw new Error('EmailJS returned non-200 status');
                }
            } catch (error) {
                console.error('Error sending recommendation email:', error);
                showMessageModal(translations[currentLang].recommendationFailed);
            }
        }

        // ===== LANGUAGE FUNCTIONS =====
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);

            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else if (element.tagName === 'TEXTAREA' && element.hasAttribute('placeholder')) {
                        element.placeholder = translations[lang][key];
                    }
                    else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            const langSelect = document.getElementById('language-select');
            const langSelectMobile = document.getElementById('language-select-mobile');
            if (langSelect) langSelect.value = lang;
            if (langSelectMobile) langSelectMobile.value = lang;
            
            document.documentElement.lang = lang;

            currentLoadedShops = 0;
            filterAndDisplayShops();

            const shopDetailModal = document.getElementById('shop-detail-modal');
            if (!shopDetailModal.classList.contains('hidden')) {
                const currentShopId = shopDetailModal.dataset.shopId;
                if (currentShopId) {
                    showShopDetail(currentShopId); 
                }
            }
        }

        // ===== SHOP FILTERING AND DISPLAY FUNCTIONS =====
        function getFilteredShops() {
            return shops.filter(shopData => {
                const shop = shopDetails[shopData.id];
                if (!shop) return false;

                const categoryKey = 'filter' + currentFilterCategory.charAt(0).toUpperCase() + currentFilterCategory.slice(1);
                const translatedCategory = translations[currentLang][categoryKey];
                
                const matchesCategory = currentFilterCategory === 'all' || 
                                        (shop.type[currentLang] && translatedCategory && shop.type[currentLang].toLowerCase().includes(translatedCategory.toLowerCase())) ||
                                        (shop.tags[currentLang] && translatedCategory && shop.tags[currentLang].some(tag => tag.toLowerCase().includes(translatedCategory.toLowerCase())));
                
                const matchesSearch = currentSearchQuery === '' ||
                                      (shop.name[currentLang] && shop.name[currentLang].toLowerCase().includes(currentSearchQuery.toLowerCase())) ||
                                      (shop.address[currentLang] && shop.address[currentLang].toLowerCase().includes(currentSearchQuery.toLowerCase())) ||
                                      (shop.description[currentLang] && shop.description[currentLang].toLowerCase().includes(currentSearchQuery.toLowerCase()));
                
                return matchesCategory && matchesSearch;
            });
        }

        function renderShopCards(filteredShops) {
            const shopCardsContainer = document.getElementById('shop-cards-container');
            if (currentLoadedShops === 0) {
                shopCardsContainer.innerHTML = ''; 
            }

            const shopsToDisplay = filteredShops.slice(currentLoadedShops, currentLoadedShops + shopsPerPage);
            
            shopsToDisplay.forEach(shopData => {
                const shop = shopDetails[shopData.id];
                if (!shop) return;

                const cardHTML = `
                    <div class="shop-card bg-white rounded-xl overflow-hidden shadow-md">
                        <div class="h-48 bg-green-100 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                            </svg>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold">${shop.name[currentLang] || shop.name['zh-TW'] || translations[currentLang].notProvided}</h3>
                                <span class="tag px-2 py-1 rounded-full text-xs">${shop.type[currentLang] || shop.type['zh-TW'] || translations[currentLang].notProvided}</span>
                            </div>
                            <p class="text-gray-600 mb-4">${shop.description[currentLang] || shop.description['zh-TW'] || translations[currentLang].notProvided}</p>
                            <div class="mb-4">
                                <div class="flex items-center text-gray-600 text-sm mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    ${shop.address[currentLang] || shop.address['zh-TW'] || translations[currentLang].notProvided}
                                </div>
                                <div class="flex items-center text-gray-600 text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    ${shop.hours[currentLang] || shop.hours['zh-TW'] || translations[currentLang].notProvided}
                                </div>
                            </div>
                            <button class="block w-full text-center py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" onclick="showShopDetail('${shopData.id}')" data-i18n="viewDetailsBtn">${translations[currentLang].viewDetailsBtn}</button>
                        </div>
                    </div>
                `;
                shopCardsContainer.insertAdjacentHTML('beforeend', cardHTML);
            });

            currentLoadedShops += shopsToDisplay.length;
            updateLoadMoreButton(filteredShops.length);
        }

        // Update map markers
        function updateMapMarkers(filteredShops) {
            if (!mapInstance) return;
            
            markersGroup.clearLayers();

            filteredShops.forEach(shopData => {
                const shop = shopDetails[shopData.id];
                if (!shop) return;
                
                const marker = L.marker([shopData.lat, shopData.lng]);
                const shopName = shop.name[currentLang] || shop.name['zh-TW'] || translations[currentLang].notProvided;
                const shopType = shop.type[currentLang] || shop.type['zh-TW'] || translations[currentLang].notProvided;
                const shopAddress = shop.address[currentLang] || shop.address['zh-TW'] || translations[currentLang].notProvided;
                
                marker.bindPopup(`
                    <div class="p-2">
                        <h3 class="font-bold text-lg mb-1">${shopName}</h3>
                        <p class="text-sm text-gray-600 mb-1">${shopType}</p>
                        <p class="text-xs text-gray-500 mb-2">${shopAddress}</p>
                        <button onclick="showShopDetail('${shopData.id}')" class="text-green-600 text-sm hover:underline">${translations[currentLang].viewDetailsBtn}</button>
                    </div>
                `);
                markersGroup.addLayer(marker);
            });
            
            mapInstance.addLayer(markersGroup);
        }

        // Filter and display shops (main control function)
        function filterAndDisplayShops() {
            const filteredShops = getFilteredShops();
            renderShopCards(filteredShops);
            updateMapMarkers(filteredShops);
        }

        // Update "Load More" button state
        function updateLoadMoreButton(totalFilteredShops) {
            const loadMoreButton = document.getElementById('load-more-button');
            if (currentLoadedShops < totalFilteredShops) {
                loadMoreButton.classList.remove('hidden');
            } else {
                loadMoreButton.classList.add('hidden');
            }
        }

        // Show shop details
        function showShopDetail(shopId) {
            const shop = shopDetails[shopId];
            if (!shop) {
                showMessageModal(translations[currentLang].shopDetailsNotAvailable);
                return;
            }

            document.getElementById('shop-detail-modal').dataset.shopId = shopId;

            let detailHTML = `
                <div class="shop-detail-header py-12 text-white rounded-t-xl">
                    <div class="container mx-auto px-4 text-center">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2">${shop.name[currentLang] || shop.name['zh-TW'] || translations[currentLang].notProvided}</h1>
                        <p class="text-lg">${shop.type[currentLang] || shop.type['zh-TW'] || translations[currentLang].notProvided}</p>
                    </div>
                </div>
                <button id="close-modal" class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-md z-[1010]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <h2 class="text-2xl font-bold mb-4" data-i18n="modalAboutUs">${translations[currentLang].modalAboutUs}</h2>
                            <p class="text-gray-700 mb-4">${shop.description[currentLang] || shop.description['zh-TW'] || translations[currentLang].notProvided}</p>
                            ${shop.longDescription && (shop.longDescription[currentLang] || shop.longDescription['zh-TW']) ? `<p class="text-gray-700 mb-6">${shop.longDescription[currentLang] || shop.longDescription['zh-TW']}</p>` : ''}
                            
                            ${shop.sustainability && (shop.sustainability[currentLang] || shop.sustainability['zh-TW']) ? `
                            <h2 class="text-2xl font-bold mb-4" data-i18n="modalSustainability">${translations[currentLang].modalSustainability}</h2>
                            <div class="mb-6">
                                <p class="text-gray-700 mb-4">${shop.sustainability[currentLang] || shop.sustainability['zh-TW']}</p>
                                ${shop.tags && (shop.tags[currentLang] || shop.tags['zh-TW']) && (shop.tags[currentLang] || shop.tags['zh-TW']).length > 0 ? `
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${(shop.tags[currentLang] || shop.tags['zh-TW']).map(tag => `<span class="tag px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                            
                            ${isAdminMode ? `
                            <button onclick="sendRecommendationEmail('${shopId}')" class="admin-button" data-i18n="adminRecommendBtn">
                                ${translations[currentLang].adminRecommendBtn}
                            </button>
                            ` : ''}
                        </div>
                        
                        <div class="bg-green-50 p-6 rounded-xl">
                            <h3 class="text-xl font-bold mb-4" data-i18n="modalShopInfo">${translations[currentLang].modalShopInfo}</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-medium text-gray-700" data-i18n="modalAddress">${translations[currentLang].modalAddress}</h4>
                                    <p class="text-gray-600">${shop.address[currentLang] || shop.address['zh-TW'] || translations[currentLang].notProvided}</p>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-700" data-i18n="modalOpeningHours">${translations[currentLang].modalOpeningHours}</h4>
                                    <p class="text-gray-600">${shop.hours[currentLang] || shop.hours['zh-TW'] || translations[currentLang].notProvided}</p>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-700" data-i18n="modalContactInfo">${translations[currentLang].modalContactInfo}</h4>
                                    <p class="text-gray-600">${translations[currentLang].modalPhone}: ${shop.phone || translations[currentLang].notProvided}</p>
                                    <p class="text-gray-600">${translations[currentLang].modalEmail}: ${shop.email || translations[currentLang].notProvided}</p>
                                    ${shop.website ? `<p class="text-gray-600">${translations[currentLang].modalWebsite}: <a href="https://${shop.website}" target="_blank" class="text-green-600 hover:underline">${shop.website}</a></p>` : ''}
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <h3 class="text-xl font-bold mb-4" data-i18n="modalLocation">${translations[currentLang].modalLocation}</h3>
                                <div class="h-64 bg-gray-200 rounded-lg overflow-hidden shop-map">
                                    <div id="shop-map-${shopId}" class="h-full w-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('shop-detail-content').innerHTML = detailHTML;
            document.getElementById('shop-detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Initialize shop detail map
            setTimeout(() => {
                try {
                    const shopMap = L.map(`shop-map-${shopId}`, {
                        zoomControl: false,
                        attributionControl: false
                    }).setView([shop.lat, shop.lng], 16);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(shopMap);
                    
                    L.marker([shop.lat, shop.lng]).addTo(shopMap)
                        .bindPopup(`<b>${shop.name[currentLang] || shop.name['zh-TW']}</b>`).openPopup();
                    
                    shopMap.dragging.disable();
                    shopMap.touchZoom.disable();
                    shopMap.doubleClickZoom.disable();
                    shopMap.scrollWheelZoom.disable();
                } catch (error) {
                    console.error('Error initializing shop detail map:', error);
                }
            }, 300);

            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('shop-detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }
        
        function closeModal() {
            document.getElementById('shop-detail-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Custom message box function (replaces alert)
        function showMessageModal(message) {
            const messageModal = document.getElementById('custom-message-modal');
            document.getElementById('message-modal-text').textContent = message;
            messageModal.classList.remove('hidden');

            const closeButton = document.getElementById('close-message-modal');
            
            // Clone and replace the button to remove old event listeners
            const newCloseButton = closeButton.cloneNode(true);
            closeButton.parentNode.replaceChild(newCloseButton, closeButton);

            newCloseButton.addEventListener('click', function() {
                messageModal.classList.add('hidden');
            });
        }

        // Initialize map with error handling
        function initializeMap() {
            try {
                mapInstance = L.map('sustainability-map').setView([25.0330, 121.5654], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapInstance);
                
                markersGroup.addTo(mapInstance);
                
                // Force map to resize and render properly
                setTimeout(() => {
                    if (mapInstance) {
                        mapInstance.invalidateSize();
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            initializeMap();

            // Initial language setup
            setLanguage(currentLang);
            
            // Event Listeners
            document.getElementById('menu-toggle').addEventListener('click', function() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            document.getElementById('language-select').addEventListener('change', function() {
                setLanguage(this.value);
            });
            document.getElementById('language-select-mobile').addEventListener('change', function() {
                setLanguage(this.value);
            });

            document.getElementById('search-button').addEventListener('click', () => {
                currentSearchQuery = document.getElementById('search-input').value.trim();
                currentLoadedShops = 0;
                filterAndDisplayShops();
            });

            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('search-button').click();
                }
            });

            document.getElementById('filter-buttons-container').addEventListener('click', (e) => {
                const clickedButton = e.target.closest('.tag');
                if (clickedButton) {
                    document.querySelectorAll('#filter-buttons-container .tag').forEach(btn => btn.classList.remove('active'));
                    clickedButton.classList.add('active');
                    currentFilterCategory = clickedButton.dataset.category;
                    currentLoadedShops = 0;
                    filterAndDisplayShops();
                }
            });

            document.getElementById('load-more-button').addEventListener('click', () => {
                filterAndDisplayShops();
            });

            // [MODIFIED] Newsletter subscription with robust error handling
            document.getElementById('subscribe-button').addEventListener('click', async () => {
                const emailInput = document.getElementById('newsletter-email');
                const email = emailInput.value.trim();

                if (!email || !/\S+@\S+\.\S+/.test(email)) {
                    showMessageModal(translations[currentLang].newsletterInvalidEmail);
                    return;
                }

                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        // Use text/plain to avoid potential CORS preflight issues with Apps Script
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'subscribe', email })
                    });

                    if (!response.ok) {
                        // If the server response is not OK, throw an error
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    // First, get the response as text. This prevents errors if the response is not valid JSON.
                    const text = await response.text();
                    const result = JSON.parse(text); // Now, parse the text as JSON

                    if (result && result.success) {
                        showMessageModal(translations[currentLang].newsletterSuccess);
                        emailInput.value = '';
                    } else {
                        // If the script returned an error message, display it. Otherwise, show a generic error.
                        const errorMessage = result.error || translations[currentLang].newsletterError;
                        showMessageModal(errorMessage);
                    }
                } catch (err) {
                    console.error('Newsletter subscription error:', err);
                    showMessageModal(translations[currentLang].newsletterError);
                }
            });

            // Issue report form submission
            document.getElementById('issue-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const issueText = document.getElementById('issue').value.trim();
                const submitButton = this.querySelector('button[type="submit"]');

                if (!issueText) return;

                submitButton.disabled = true;
                submitButton.textContent = '...';

                try {
                    const response = await fetch('https://formsubmit.co/ajax/artistworld0815@gmail.com', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            _subject: "永續商店地圖 - 問題回報",
                            message: issueText
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success === "true" || response.ok) {
                        document.getElementById('issue-message').classList.remove('hidden');
                        document.getElementById('issue-form').reset();
                        setTimeout(() => {
                           document.getElementById('issue-message').classList.add('hidden');
                        }, 5000);
                    } else {
                       throw new Error('Formsubmit.co returned an error.');
                    }
                } catch (error) {
                    console.error("Issue report error:", error);
                    showMessageModal(translations[currentLang].reportIssueErrorMsg);
                } finally {
                    submitButton.disabled = false;
                    const originalTextKey = submitButton.getAttribute('data-i18n');
                    if (originalTextKey) {
                       submitButton.textContent = translations[currentLang][originalTextKey];
                    } else {
                       submitButton.textContent = '送出回報';
                    }
                }
            });
        });

        // Make functions globally accessible
        window.showShopDetail = showShopDetail;
        window.sendRecommendationEmail = sendRecommendationEmail;
    </script>
</body>
</html>
