<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* TailwindCSS Preflight & Compiled Utilities */
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}body{margin:0;line-height:inherit;font-family:'Noto Sans TC',sans-serif;background-color:#f0f7f4}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button;background-color:transparent;background-image:none}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.hero-section{background:linear-gradient(rgba(0,0,0,.6),rgba(0,0,0,.6)),url(https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80);background-size:cover;background-position:center}.tag{transition:all .2s ease-in-out;cursor:pointer}.tag.active,.tag:hover{background-color:#16a34a;color:#fff}.shop-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,.1)}.modal-content{max-height:90vh;overflow-y:auto}.favorite-btn.favorited svg{fill:#ef4444;stroke:#ef4444}.spinner{border-top-color:#10B981;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}#shop-detail-modal, #policy-modal{display:none}#shop-detail-modal.flex, #policy-modal.flex{display:flex}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.top-4{top:1rem}.right-4{right:1rem}.left-1\/2{left:50%}.z-0{z-index:0}.z-20{z-index:20}.z-50{z-index:50}.z-\[1000\]{z-index:1000}.z-\[2000\]{z-index:2000}.z-\[9998\]{z-index:9998}.z-\[9999\]{z-index:9999}.mx-2{margin-left:.5rem;margin-right:.5rem}.mx-4{margin-left:1rem;margin-right:1rem}.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.-mt-16{margin-top:-4rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-8{height:2rem}.h-12{height:3rem}.h-16{height:4rem}.h-48{height:12rem}.h-64{height:16rem}.h-96{height:24rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-12{width:3rem}.w-16{width:4rem}.w-full{width:100%}.max-w-sm{max-width:24rem}.max-w-2xl{max-width:42rem}.max-w-4xl{max-width:56rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.-translate-x-1\/2{--tw-translate-x:-50%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-y-full{--tw-translate-y:-100%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:.5rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.gap-8{gap:2rem}.space-x-2>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.5rem * var(--tw-space-x-reverse));margin-left:calc(.5rem * (1 - var(--tw-space-x-reverse)))}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * (1 - var(--tw-space-x-reverse)))}.space-x-6>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1.5rem * var(--tw-space-x-reverse));margin-left:calc(1.5rem * (1 - var(--tw-space-x-reverse)))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem * (1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem * var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * (1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * (1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded-md{border-radius:.375rem}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-4{border-width:4px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity))}.border-t{border-top-width:1px}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81/var(--tw-border-opacity))}.border-yellow-200{--tw-border-opacity:1;border-color:rgb(254 240 138/var(--tw-border-opacity))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0/var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55/var(--tw-bg-opacity))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity))}.bg-green-700{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232/var(--tw-bg-opacity))}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgb(254 249 195/var(--tw-bg-opacity))}.bg-opacity-60{--tw-bg-opacity:.6}.p-1{padding:.25rem}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2\.5{padding-left:.625rem;padding-right:.625rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-10{padding-top:2.5rem;padding-bottom:2.5rem}.py-12{padding-top:3rem;padding-bottom:3rem}.py-20{padding-top:5rem;padding-bottom:5rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pt-6{padding-top:1.5rem}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.text-center{text-align:center}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.text-yellow-800{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity))}.opacity-0{opacity:0}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0/.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0/.1),0 8px 10px -6px rgb(0 0 0/.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.outline-none:focus{outline:2px solid transparent;outline-offset:2px}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.focus\:ring-green-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(34 197 94/var(--tw-ring-opacity))}@media (min-width:768px){.md\:hidden{display:none}.md\:flex{display:flex}.md\:h-\[500px\]{height:500px}.md\:flex-row{flex-direction:row}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:py-32{padding-top:8rem;padding-bottom:8rem}.md\:text-left{text-align:left}.md\:text-5xl{font-size:3rem;line-height:1}}@media (min-width:1024px){.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="spinner h-12 w-12 border-4 border-gray-200 rounded-full"></div>
        <p class="mt-4 text-gray-600" data-i18n="loading">載入中...</p>
    </div>
    <div id="toast" class="fixed top-0 left-1/2 -translate-x-1/2 -translate-y-full transition-transform duration-300 z-[9998] w-full max-w-sm">
        <div id="toast-content" class="flex items-center gap-4 p-4 mt-4 mx-2 rounded-lg shadow-lg">
            <div id="toast-icon"></div>
            <p id="toast-message" class="font-medium"></p>
        </div>
    </div>
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <a href="#" class="text-2xl font-bold text-gray-800" data-i18n="appName">永續商店地圖</a>
            </div>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#map" class="text-gray-700 hover:text-green-600 transition" data-i18n="map">地圖</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600 transition" data-i18n="shopList">商店列表</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600 transition" data-i18n="newsletter">訂閱電子報</a>
                <a href="#report-issue" class="text-gray-700 hover:text-green-600 transition" data-i18n="reportIssueNavLink">問題回報</a>
                 <select id="language-select" class="bg-gray-100 text-sm px-3 py-1 rounded-full hover:bg-gray-200 transition cursor-pointer border">
                    <option value="zh-TW">繁體中文</option><option value="en">English</option><option value="fr">Français</option><option value="de">Deutsch</option><option value="es">Español</option><option value="ja">日本語</option><option value="la">Latin</option>
                </select>
            </div>
            <div class="md:hidden flex items-center"><button id="menu-toggle" class="text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button></div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white"></div>
    </nav>
    <div id="announcement-bar" class="hidden bg-yellow-100 border-b-2 border-yellow-200 text-yellow-800 p-3 text-center text-sm"><p id="announcement-text" class="font-medium"></p></div>
    <main>
        <section class="hero-section py-20 md:py-32 text-white">
            <div class="container mx-auto px-4 text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">探索台灣永續商店</h1>
                <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力</p>
                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <a href="#map" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition" data-i18n="viewMapBtn">查看地圖</a>
                    <a href="#shops" class="bg-white text-green-600 px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="browseShopsBtn">瀏覽商店列表</a>
                </div>
            </div>
        </section>
        <section class="py-12 bg-white relative -mt-16 z-20 mx-4 md:mx-auto max-w-5xl rounded-xl shadow-lg">
            <div class="container mx-auto px-6">
                <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">搜尋永續商店</h2>
                <div class="flex mb-4"><input type="text" id="search-input" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500" data-i18n="searchPlaceholder"><button id="search-button" class="bg-green-600 text-white px-6 py-3 rounded-r-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></button></div>
                <div>
                    <h3 class="font-medium mb-3" data-i18n="filterCategoryTitle">依類別篩選</h3>
                    <div class="flex flex-wrap gap-2" id="filter-buttons-container">
                        <button class="tag bg-green-600 text-white px-3 py-1 rounded-full text-sm" data-category="" data-i18n="filterAll"></button>
                        <button class="tag bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm" data-category="favorites" data-i18n="filterFavorites"></button>
                    </div>
                </div>
            </div>
        </section>
        <section id="map" class="py-12 bg-green-50">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">永續商店地圖</h2>
                <div id="sustainability-map" class="h-96 md:h-[500px] w-full rounded-xl shadow-lg bg-gray-200"></div>
            </div>
        </section>
        <section id="shops" class="py-12 bg-white">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">永續商店列表</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="shop-cards-container"></div>
                <div class="text-center mt-8"><button id="load-more-button" class="bg-green-600 text-white px-8 py-3 rounded-lg font-medium hidden" data-i18n="loadMoreBtn"></button></div>
            </div>
        </section>
        <section id="newsletter" class="py-12 bg-green-700 text-white">
            <form id="newsletter-form" class="container mx-auto px-4 max-w-2xl text-center">
                <h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">訂閱永續生活電子報</h2>
                <p class="mb-6" data-i18n="newsletterSubtitle">獲取最新的永續商店資訊、環保生活技巧和特別優惠</p>
                <div class="flex flex-col md:flex-row gap-2"><input type="email" name="email" class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none" data-i18n="newsletterPlaceholder" required><button type="submit" class="bg-white text-green-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="subscribeBtn"></button></div>
            </form>
        </section>
        <section id="report-issue" class="py-12 bg-yellow-50">
            <div class="container mx-auto px-4 max-w-2xl bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-3xl font-bold text-center mb-6" data-i18n="reportIssueTitle">問題回報</h2>
                <form id="issue-form" class="space-y-4">
                    <div><label class="block text-sm font-medium" data-i18n="reportIssueEmailLabel">您的電子郵件</label><input type="email" name="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" data-i18n="reportIssueEmailPlaceholder" required></div>
                    <div><label class="block text-sm font-medium" data-i18n="reportIssueTypeLabel">問題類型</label><select name="type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required><option value="info_error" data-i18n="reportTypeInfoError">店家資訊錯誤</option><option value="bug" data-i18n="reportTypeBug">網站功能問題</option><option value="suggestion" data-i18n="reportTypeSuggestion">功能建議</option><option value="other" data-i18n="reportTypeOther">其他</option></select></div>
                    <div><label class="block text-sm font-medium" data-i18n="reportIssueLabel">請描述您遇到的問題</label><textarea name="message" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" data-i18n="reportIssuePlaceholder" required></textarea></div>
                    <div class="text-center pt-2"><button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium" data-i18n="reportIssueSubmitBtn"></button></div>
                </form>
            </div>
        </section>
    </main>
    <footer class="bg-gray-800 text-white py-10">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="appName">永續商店地圖</h3>
                    <p class="text-gray-300" data-i18n="heroSubtitle"></p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="policiesNavLink">政策聲明</h3>
                    <div class="flex flex-col items-center md:items-start space-y-2">
                        <button data-policy="privacy" class="text-gray-300 hover:text-white transition" data-i18n="privacyPolicyTitle"></button>
                        <button data-policy="disclaimer" class="text-gray-300 hover:text-white transition" data-i18n="disclaimerTitle"></button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="contactUsTitle">聯絡我們</h3>
                    <p class="text-gray-300">artistworld0815@gmail.com</p>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>© 2025 <span data-i18n="appName"></span> - All Rights Reserved</p>
            </div>
        </div>
    </footer>
    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[1000] items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-6xl w-full mx-auto modal-content">
            <div id="shop-detail-content" class="relative"></div>
        </div>
    </div>
    <div id="policy-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[2000] items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full mx-auto modal-content">
            <div class="p-6 relative">
                <button id="closePolicyModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                <h2 id="policy-modal-title" class="text-2xl font-bold mb-4"></h2>
                <div id="policy-modal-body" class="text-gray-600 space-y-4"></div>
            </div>
        </div>
    </div>
    
<script>
// [FINAL & COMPLETE SCRIPT - v20.0]
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://script.google.com/macros/s/AKfycbwgQoUrk2fspuJTc0aPJHzJe_xHhIB9s50qcJQj5xLC4wujhhqW2TBG2Q07hIjcHEMqEg/exec';
    const LANGUAGES = ['zh-TW', 'en', 'fr', 'de', 'es', 'ja', 'la'];
    
    let allShops = [], allTags = [], policies = {}, announcements = {};
    let currentLang = localStorage.getItem('lang') || 'zh-TW';
    let favoriteShops = JSON.parse(localStorage.getItem('favoriteShops')) || [];
    let mapInstance;
    let markersGroup = L.featureGroup();
    let currentFilter = { tagId: '', query: '' };
    const shopsPerPage = 6;
    let renderedShopCount = 0;

    const ui = {
        loadingOverlay: document.getElementById('loading-overlay'),
        toast: document.getElementById('toast'),
        toastContent: document.getElementById('toast-content'),
        toastIcon: document.getElementById('toast-icon'),
        toastMessage: document.getElementById('toast-message'),
        languageSelect: document.getElementById('language-select'),
        mobileMenu: document.getElementById('mobile-menu'),
        announcementBar: document.getElementById('announcement-bar'),
        announcementText: document.getElementById('announcement-text'),
        searchInput: document.getElementById('search-input'),
        searchButton: document.getElementById('search-button'),
        filterButtonsContainer: document.getElementById('filter-buttons-container'),
        sustainabilityMap: document.getElementById('sustainability-map'),
        shopCardsContainer: document.getElementById('shop-cards-container'),
        loadMoreButton: document.getElementById('load-more-button'),
        newsletterForm: document.getElementById('newsletter-form'),
        issueForm: document.getElementById('issue-form'),
        footer: document.querySelector('footer'),
        shopDetailModal: document.getElementById('shop-detail-modal'),
        shopDetailContent: document.getElementById('shop-detail-content'),
        policyModal: document.getElementById('policy-modal'),
        policyModalTitle: document.getElementById('policy-modal-title'),
        policyModalBody: document.getElementById('policy-modal-body'),
        closePolicyModal: document.getElementById('closePolicyModal'),
        menuToggle: document.getElementById('menu-toggle')
    };
    
    const staticTranslations = {"zh-TW":{"pageTitle":"永續商店地圖","appName":"永續商店地圖","map":"地圖","shopList":"商店列表","newsletter":"訂閱電子報","reportIssueNavLink":"問題回報","policiesNavLink":"政策聲明","heroTitle":"探索台灣永續商店","heroSubtitle":"找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力","searchTitle":"搜尋永續商店","searchPlaceholder":"輸入商店名稱、地址或標籤...","filterCategoryTitle":"依類別篩選","filterAll":"全部","filterFavorites":"❤️ 我的收藏","mapSectionTitle":"永續商店地圖","shopListSectionTitle":"永續商店列表","loadMoreBtn":"載入更多","newsletterTitle":"訂閱永續生活電子報","newsletterSubtitle":"獲取最新的永續商店資訊、環保生活技巧和特別優惠","newsletterPlaceholder":"您的電子郵件","subscribeBtn":"訂閱","reportIssueTitle":"問題回報","reportIssueEmailLabel":"您的電子郵件","reportIssueEmailPlaceholder":"請輸入您的 Email","reportIssueTypeLabel":"問題類型","reportTypeInfoError":"店家資訊錯誤","reportTypeBug":"網站功能問題","reportTypeSuggestion":"功能建議","reportTypeOther":"其他","reportIssueLabel":"請描述您遇到的問題","reportIssuePlaceholder":"請詳細說明...","reportIssueSubmitBtn":"送出回報","privacyPolicyTitle":"隱私權政策","disclaimerTitle":"免責聲明","loading":"載入中...","newsletterSuccess":"訂閱成功！感謝您的加入","reportIssueSuccessMsg":"感謝您的回報！","contactUsTitle":"聯絡我們", "viewMapBtn":"查看地圖", "browseShopsBtn":"瀏覽商店列表"},"en":{"pageTitle":"Sustainable Store Map","appName":"Sustainable Store Map","map":"Map","shopList":"Shop List","newsletter":"Newsletter","reportIssueNavLink":"Report Issue","policiesNavLink":"Policies","heroTitle":"Explore Taiwan's Sustainable Stores","heroSubtitle":"Find stores that support environmental protection, fair trade, and sustainable development.","searchTitle":"Search Sustainable Stores","searchPlaceholder":"Enter store name, address, or tag...","filterCategoryTitle":"Filter by Category","filterAll":"All","filterFavorites":"❤️ My Favorites","mapSectionTitle":"Sustainable Store Map","shopListSectionTitle":"Sustainable Shop List","loadMoreBtn":"Load More","newsletterTitle":"Subscribe to Sustainable Living Newsletter","newsletterSubtitle":"Get the latest info on sustainable stores, eco-friendly tips, and special offers.","newsletterPlaceholder":"Your email address","subscribeBtn":"Subscribe","reportIssueTitle":"Report an Issue","reportIssueEmailLabel":"Your Email","reportIssueEmailPlaceholder":"Enter your email","reportIssueTypeLabel":"Type of Issue","reportTypeInfoError":"Incorrect Store Info","reportTypeBug":"Website Bug","reportTypeSuggestion":"Suggestion","reportTypeOther":"Other","reportIssueLabel":"Please describe the issue","reportIssuePlaceholder":"Please provide details...","reportIssueSubmitBtn":"Submit Report","privacyPolicyTitle":"Privacy Policy","disclaimerTitle":"Disclaimer","loading":"Loading...","newsletterSuccess":"Subscription successful! Thank you for joining.","reportIssueSuccessMsg":"Thank you for your feedback!","contactUsTitle":"Contact Us", "viewMapBtn":"View Map", "browseShopsBtn":"Browse Shop List"}};

    const getI18nValue = (dataObject, baseKey, lang, fallbackLang = 'zh-TW') => {
        if (!dataObject) return '';
        return dataObject[`${baseKey}_${lang}`] || dataObject[`${baseKey}_${fallbackLang}`] || '';
    };

    const showToast = (message, isSuccess = true) => {
        ui.toastMessage.textContent = message;
        if (isSuccess) {
            ui.toastContent.className = 'flex items-center gap-4 p-4 mt-4 mx-2 rounded-lg shadow-lg bg-green-500 text-white';
            ui.toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        } else {
            ui.toastContent.className = 'flex items-center gap-4 p-4 mt-4 mx-2 rounded-lg shadow-lg bg-red-500 text-white';
            ui.toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        }
        ui.toast.style.transform = 'translate(-50%, 0)';
        setTimeout(() => { ui.toast.style.transform = 'translate(-50%, -100%)'; }, 3000);
    };

    async function apiRequest(action, payload = {}) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...payload }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            });
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            const text = await response.text();
            const result = JSON.parse(text);
            if (result.status === 'error') throw new Error(result.message);
            return result.data;
        } catch (error) {
            console.error(`API Error (${action}):`, error);
            showToast(`操作失敗: ${error.message}`, false);
            throw error;
        }
    }
    
    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem('lang', lang);
        if (ui.languageSelect.value !== lang) ui.languageSelect.value = lang;
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            const translation = staticTranslations[lang]?.[key] || staticTranslations['zh-TW']?.[key] || `[${key}]`;
            if (el.placeholder !== undefined) el.placeholder = translation; else el.textContent = translation;
        });
        
        renderDynamicContent();
        filterAndDisplayShops(true);
    };

    const renderDynamicContent = () => {
        const announcement = announcements[currentLang] || announcements['zh-TW'];
        if (announcement) {
            ui.announcementText.textContent = announcement;
            ui.announcementBar.classList.remove('hidden');
        } else {
            ui.announcementBar.classList.add('hidden');
        }
        renderFilterButtons();
    };
    
    const renderFilterButtons = () => {
        const staticButtons = Array.from(ui.filterButtonsContainer.querySelectorAll('button[data-category]'));
        ui.filterButtonsContainer.innerHTML = '';
        staticButtons.forEach(btn => ui.filterButtonsContainer.appendChild(btn));
        
        const uniqueTags = [...new Map(allShops.flatMap(s => s.tags || []).filter(Boolean).map(item => [item.id, item])).values()];
        uniqueTags.forEach(tag => {
            const button = document.createElement('button');
            button.className = 'tag bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm';
            button.dataset.tagId = tag.id;
            button.textContent = getI18nValue(tag, 'name', currentLang);
            ui.filterButtonsContainer.appendChild(button);
        });
    };

    const filterAndDisplayShops = (reset = false) => {
        if (reset) renderedShopCount = 0;
        
        const filtered = allShops.filter(shop => {
            const matchesCategory = currentFilter.category === '' || (currentFilter.category === 'favorites' ? favoriteShops.includes(String(shop.id)) : false);
            const matchesTag = currentFilter.tagId === '' || (shop.tags || []).some(t => String(t.id) === String(currentFilter.tagId));
            const query = currentFilter.query.toLowerCase();
            const matchesQuery = query === '' || 
                getI18nValue(shop, 'name', currentLang).toLowerCase().includes(query) ||
                getI18nValue(shop, 'address', currentLang).toLowerCase().includes(query) ||
                (shop.tags || []).some(t => getI18nValue(t, 'name', currentLang).toLowerCase().includes(query));
            return (matchesCategory || matchesTag) && matchesQuery;
        });

        renderShopCards(filtered);
        updateMapMarkers(filtered);
    };

    const renderShopCards = (filteredShops) => {
        if (renderedShopCount === 0) ui.shopCardsContainer.innerHTML = '';
        const shopsToRender = filteredShops.slice(renderedShopCount, renderedShopCount + shopsPerPage);
        shopsToRender.forEach(shop => {
            const card = document.createElement('div');
            card.className = 'shop-card bg-white rounded-xl overflow-hidden shadow-md relative flex flex-col';
            const isFavorited = favoriteShops.includes(String(shop.id));
            card.innerHTML = `<div class="h-48 bg-green-100 flex items-center justify-center text-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg></div>
                <button class="favorite-btn absolute top-4 right-4 bg-white/80 rounded-full p-2 ${isFavorited ? 'favorited' : ''}" data-shop-id="${shop.id}">
                    <svg class="w-6 h-6 stroke-gray-700 stroke-2 fill-none" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
                <div class="p-6 flex flex-col flex-grow">
                    <h3 class="text-xl font-bold mb-2">${getI18nValue(shop, 'name', currentLang)}</h3>
                    <p class="text-gray-600 mb-4 text-sm flex-grow">${getI18nValue(shop, 'description', currentLang)}</p>
                    <button class="show-detail-btn block w-full text-center py-2 bg-green-600 text-white rounded-lg font-medium mt-4" data-shop-id="${shop.id}">${staticTranslations[currentLang].viewDetailsBtn || '查看詳情'}</button>
                </div>`;
            card.querySelector('.show-detail-btn').addEventListener('click', () => showShopDetail(shop.id));
            card.querySelector('.favorite-btn').addEventListener('click', (e) => { e.stopPropagation(); toggleFavorite(shop.id, e.currentTarget); });
            ui.shopCardsContainer.appendChild(card);
        });
        renderedShopCount += shopsToRender.length;
        ui.loadMoreButton.classList.toggle('hidden', renderedShopCount >= filteredShops.length);
        if (filteredShops.length === 0 && renderedShopCount === 0) {
            ui.shopCardsContainer.innerHTML = `<p class="text-gray-500 md:col-span-3 text-center">找不到符合條件的店家。</p>`;
        }
    };
    
    const updateMapMarkers = (filteredShops) => {
        if (!mapInstance) return;
        markersGroup.clearLayers();
        filteredShops.forEach(shop => {
            if (shop.lat && shop.lng) {
                const marker = L.marker([shop.lat, shop.lng]);
                marker.bindPopup(`<b>${getI18nValue(shop, 'name', currentLang)}</b><br><button class="text-green-600" onclick="document.dispatchEvent(new CustomEvent('show-shop', {detail: '${shop.id}'}))">查看詳情</button>`);
                markersGroup.addLayer(marker);
            }
        });
        if (filteredShops.length > 0 && markersGroup.getLayers().length > 0) {
            mapInstance.fitBounds(markersGroup.getBounds().pad(0.1));
        }
    };

    const toggleFavorite = (shopId, btnElement) => {
        const id = String(shopId);
        const index = favoriteShops.indexOf(id);
        if (index > -1) favoriteShops.splice(index, 1);
        else favoriteShops.push(id);
        localStorage.setItem('favoriteShops', JSON.stringify(favoriteShops));
        btnElement?.classList.toggle('favorited');
        if (currentFilter.category === 'favorites') filterAndDisplayShops(true);
    };

    const showShopDetail = (shopId) => {
        const shop = allShops.find(s => String(s.id) === String(shopId));
        if (!shop) return;
        const tagsHtml = (shop.tags || []).filter(Boolean).map(tag => `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">${getI18nValue(tag, 'name', currentLang)}</span>`).join('');
        ui.shopDetailContent.innerHTML = `<div class="p-8 space-y-6">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 class="text-3xl font-bold">${getI18nValue(shop, 'name', currentLang)}</h2>
            <p class="text-gray-600">${getI18nValue(shop, 'longDescription', currentLang) || getI18nValue(shop, 'description', currentLang)}</p>
            <div>${tagsHtml}</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                <div class="space-y-4">
                    <h3 class="font-semibold">商店資訊</h3>
                    <p><b>地址:</b> ${getI18nValue(shop, 'address', currentLang)}</p>
                    <p><b>電話:</b> ${shop.phone || '未提供'}</p>
                    <p><b>網站:</b> ${shop.website ? `<a href="${shop.website.startsWith('http') ? '' : '//'}${shop.website}" target="_blank" class="text-green-600">${shop.website}</a>` : '未提供'}</p>
                </div>
                <div id="detail-map" class="h-64 rounded-lg bg-gray-200 z-0"></div>
            </div>
        </div>`;
        ui.shopDetailContent.querySelector('#closeModalBtn').onclick = closeModal;
        ui.shopDetailModal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
            try {
                const detailMap = L.map('detail-map').setView([shop.lat, shop.lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);
                L.marker([shop.lat, shop.lng]).addTo(detailMap);
            } catch(e) { console.error("Could not initialize detail map:", e) }
        }, 100);
    };
    const closeModal = () => {
        ui.shopDetailModal.classList.remove('flex');
        document.body.style.overflow = '';
    };

    const showPolicyModal = (policyKey) => {
        const title = staticTranslations[currentLang][`${policyKey}Title`] || policyKey;
        const content = policies[policyKey] ? (policies[policyKey][currentLang] || policies[policyKey]['zh-TW']) : '內容未提供';
        ui.policyModalTitle.textContent = title;
        ui.policyModalBody.innerHTML = content.replace(/\n/g, '<br>');
        ui.policyModal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    };
    const closePolicyModal = () => {
        ui.policyModal.classList.remove('flex');
        document.body.style.overflow = '';
    };

    const initializeMap = () => {
        mapInstance = L.map(ui.sustainabilityMap).setView([25.0330, 121.5654], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
        markersGroup.addTo(mapInstance);
    };

    ui.languageSelect.addEventListener('change', (e) => setLanguage(e.target.value));
    ui.searchButton.addEventListener('click', () => { currentFilter.query = ui.searchInput.value; filterAndDisplayShops(true); });
    ui.searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') ui.searchButton.click(); });
    ui.loadMoreButton.addEventListener('click', () => filterAndDisplayShops());
    ui.filterButtonsContainer.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        ui.filterButtonsContainer.querySelectorAll('button').forEach(btn => {btn.classList.remove('active', 'bg-green-600', 'text-white'); btn.classList.add('bg-gray-200', 'text-gray-700'); });
        target.classList.add('active', 'bg-green-600', 'text-white');
        target.classList.remove('bg-gray-200', 'text-gray-700');
        currentFilter.category = target.dataset.category || '';
        currentFilter.tagId = target.dataset.tagId || '';
        filterAndDisplayShops(true);
    });
    ui.newsletterForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = new FormData(e.target).get('email'); await apiRequest('subscribe', { email }); showToast(staticTranslations[currentLang].newsletterSuccess); e.target.reset(); });
    ui.issueForm.addEventListener('submit', async (e) => { e.preventDefault(); const payload = Object.fromEntries(new FormData(e.target)); await apiRequest('submitFeedback', {payload}); showToast(staticTranslations[currentLang].reportIssueSuccessMsg); e.target.reset(); });
    document.addEventListener('show-shop', (e) => showShopDetail(e.detail));
    ui.footer.addEventListener('click', e => { if(e.target.dataset.policy) showPolicyModal(e.target.dataset.policy); });
    ui.closePolicyModal.addEventListener('click', closePolicyModal);

    async function initialize() {
        try {
            const data = await apiRequest('getPublicData');
            allShops = data.shops || [];
            allTags = data.tags || [];
            policies = data.policies || {};
            announcements = data.announcements || {};
            initializeMap();
            setLanguage(currentLang);

            if (!sessionStorage.getItem('policyPromptShown')) {
                const title = staticTranslations[currentLang].privacyPolicyTitle;
                const content = policies.privacy ? (policies.privacy[currentLang] || policies.privacy['zh-TW']) : '內容未提供';
                ui.policyModalTitle.textContent = title;
                ui.policyModalBody.innerHTML = `<p class="mb-4">歡迎！在您開始探索之前，請花點時間閱讀我們的<button onclick="document.querySelector('[data-policy=\'privacy\']').click()" class="text-green-600 underline">隱私權政策</button>。</p>${content.replace(/\n/g, '<br>')}`;
                ui.policyModal.classList.add('flex');
                document.body.style.overflow = 'hidden';
                sessionStorage.setItem('policyPromptShown', 'true');
            }
        } catch (error) {
            ui.loadingOverlay.innerHTML = `<p class="text-red-500 p-8 text-center">資料載入失敗，請檢查後端日誌或稍後重試。<br><br>${error.message}</p>`;
        } finally {
            ui.loadingOverlay.classList.add('opacity-0');
            setTimeout(() => ui.loadingOverlay.classList.add('hidden'), 300);
        }
    }
    initialize();
});
</script>
</body>
</html>
