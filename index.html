<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>永續商店地圖</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeafletJS Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- ShowdownJS for Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom Styles */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            overflow: hidden; /* Prevent scrolling of the whole page */
        }
        #map {
             height: 100%;
             width: 100%;
             z-index: 10;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            margin: 12px;
            font-size: 14px;
        }
        .shop-popup-content h3 {
            margin: 0 0 5px;
            font-weight: bold;
        }
        .shop-popup-content p {
            margin: 3px 0;
        }
        /* Custom scrollbar for search results */
        #search-results::-webkit-scrollbar {
            width: 5px;
        }
        #search-results::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 10px;
        }
        #search-results::-webkit-scrollbar-track {
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-800 text-white">

    <div id="app-container" class="relative h-screen w-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-900 shadow-lg p-2 flex items-center space-x-4 z-30">
            <h1 class="text-xl md:text-2xl font-bold text-green-400">永續商店地圖</h1>
            <div class="relative flex-grow max-w-lg">
                <input type="text" id="search-input" placeholder="搜尋店名、地址或標籤..." class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-green-500">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <div id="search-results" class="absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-700 rounded-md shadow-lg max-h-60 overflow-y-auto hidden z-40"></div>
            </div>
            <select id="type-filter" class="bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                <option value="all">所有類型</option>
            </select>
        </header>

        <!-- Main Content (Map) -->
        <main class="flex-grow relative">
            <div id="map"></div>
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-3x text-green-400"></i>
                    <p class="mt-4 text-lg">正在載入地圖資料...</p>
                </div>
            </div>
        </main>

        <!-- Footer & Modals Trigger -->
        <footer class="bg-gray-900 p-2 text-center text-sm text-gray-400 z-30">
            <button id="open-subscribe-modal" class="hover:text-green-400">訂閱電子報</button> |
            <button id="open-feedback-modal" class="hover:text-green-400">問題回報</button> |
            <a href="#" onclick="showPolicy('privacy'); return false;" class="hover:text-green-400">隱私權政策</a> |
            <a href="#" onclick="showPolicy('disclaimer'); return false;" class="hover:text-green-400">免責聲明</a>
        </footer>

        <!-- Announcement Banner -->
        <div id="announcement-banner" class="absolute top-16 left-1/2 -translate-x-1/2 bg-blue-600 bg-opacity-90 text-white p-3 rounded-lg shadow-xl z-20 hidden w-11/12 md:w-auto max-w-2xl">
            <p id="announcement-content" class="text-center"></p>
        </div>
    </div>

    <!-- Modals -->
    <!-- Subscription Modal -->
    <div id="subscribe-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-green-400">訂閱電子報</h2>
            <p class="mb-4 text-gray-300">獲取最新的永續商店資訊、環保生活技巧和特別優惠。</p>
            <form id="subscribe-form">
                <input type="email" id="subscribe-email" placeholder="請輸入您的電子郵件" class="w-full bg-gray-700 text-white rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="close-modal px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">取消</button>
                    <button type="submit" id="subscribe-submit-btn" class="px-4 py-2 bg-green-600 rounded-md hover:bg-green-500">訂閱</button>
                </div>
            </form>
            <div id="subscribe-message" class="mt-4 text-center"></div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-green-400">問題回報</h2>
            <p class="mb-4 text-gray-300">發現地圖資料有誤、網站有 Bug 或有任何建議？請告訴我們！</p>
            <form id="feedback-form">
                <input type="email" id="feedback-email" placeholder="您的電子郵件（方便我們回覆）" class="w-full bg-gray-700 text-white rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <textarea id="feedback-text" placeholder="請詳細描述您的問題或建議" rows="4" class="w-full bg-gray-700 text-white rounded-md p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="close-modal px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">取消</button>
                    <button type="submit" id="feedback-submit-btn" class="px-4 py-2 bg-green-600 rounded-md hover:bg-green-500">送出</button>
                </div>
            </form>
            <div id="feedback-message" class="mt-4 text-center"></div>
        </div>
    </div>
    
    <!-- Policy Modal -->
    <div id="policy-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 max-w-2xl max-h-[80vh] flex flex-col">
            <h2 id="policy-title" class="text-2xl font-bold mb-4 text-green-400"></h2>
            <div id="policy-loading" class="text-center py-8 hidden">
                <i class="fas fa-spinner fa-spin fa-2x text-green-400"></i>
            </div>
            <div id="policy-content" class="overflow-y-auto text-gray-300 prose prose-invert max-w-none"></div>
            <div class="flex justify-end mt-6">
                <button type="button" class="close-modal px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">關閉</button>
            </div>
        </div>
    </div>


    <script>
        // =================================================================
        // CONFIGURATION
        // =================================================================
        // !!! VERY IMPORTANT !!!
        // Replace this URL with the one you get after deploying the Google Apps Script.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyQz6D5P90b4d45p6QN_J5iUaIpjU0Xz6P5eF8B8D7k9R6J3s9S9a7Z8c7K6v5B4N3d/exec';
        
        // =================================================================
        // STATE VARIABLES
        // =================================================================
        let map;
        let allShops = [];
        let markers = [];
        const currentLang = 'zh-TW'; // Could be made dynamic in the future

        // =================================================================
        // DOM ELEMENTS
        // =================================================================
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const typeFilter = document.getElementById('type-filter');

        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setupEventListeners();
        });

        /**
         * [✅ FIXED] Fetches initial data from the backend.
         * Now calls a single, public endpoint 'getPublicData' to get all necessary data,
         * resolving the permission issue.
         */
        function fetchData() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');

            // Call the new, consolidated public endpoint
            fetch(SCRIPT_URL, {
                method: 'POST',
                // [🔧 FIXED] Added redirect and headers for better compatibility with Apps Script
                redirect: "follow", 
                body: JSON.stringify({ action: 'getPublicData' }),
                headers: { "Content-Type": "text/plain;charset=utf-8" } 
            })
            .then(res => res.json())
            .then(response => {
                if (response.status === 'success' && response.data) {
                    allShops = response.data.shops;
                    
                    // Render announcements
                    const announcementBanner = document.getElementById('announcement-banner');
                    const announcementContent = document.getElementById('announcement-content');
                    if (response.data.announcements) {
                        announcementContent.textContent = response.data.announcements;
                        announcementBanner.classList.remove('hidden');
                         // Auto-hide banner after 10 seconds
                        setTimeout(() => announcementBanner.classList.add('hidden'), 10000);
                    } else {
                        announcementBanner.classList.add('hidden');
                    }
                    
                    if (!map) initMap();
                    renderMarkers(allShops);
                    populateFilter();

                } else {
                    console.error('Failed to fetch public data:', response.message);
                    alert('無法載入商店資料，請稍後再試。');
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                alert('載入資料時發生錯誤，請檢查您的網路連線。');
            })
            .finally(() => {
                loadingIndicator.classList.add('hidden');
            });
        }
        
        /**
         * Initializes the Leaflet map.
         */
        function initMap() {
            map = L.map('map').setView([25.034, 121.565], 13); // Centered on Taipei
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
        }

        // =================================================================
        // MAP & MARKER LOGIC
        // =================================================================

        /**
         * Renders shop markers on the map.
         * @param {Array} shops - An array of shop objects.
         */
        function renderMarkers(shops) {
            markers.forEach(marker => marker.remove());
            markers = [];
            
            shops.forEach(shop => {
                if (shop.lat && shop.lng) {
                    const marker = L.marker([shop.lat, shop.lng]).addTo(map);
                    marker.bindPopup(createPopupContent(shop));
                    markers.push(marker);
                }
            });
        }
        
        /**
         * Creates HTML content for a shop's popup.
         * @param {object} shop - The shop object.
         * @returns {string} HTML content for the popup.
         */
        function createPopupContent(shop) {
            const name = shop[`name_${currentLang}`] || shop.name_zh_TW;
            const address = shop[`address_${currentLang}`] || shop.address_zh_TW;
            const description = shop[`description_${currentLang}`] || shop.description_zh_TW;
            
            return `
                <div class="shop-popup-content">
                    <h3>${name}</h3>
                    <p><i class="fas fa-map-marker-alt fa-fw"></i> ${address}</p>
                    <p><i class="fas fa-info-circle fa-fw"></i> ${description}</p>
                    ${shop.website ? `<p><i class="fas fa-globe fa-fw"></i> <a href="http://${shop.website}" target="_blank" class="text-blue-500 hover:underline">${shop.website}</a></p>` : ''}
                </div>
            `;
        }

        /**
         * Pans the map to a specific shop's location and opens its popup.
         * @param {string} shopId - The ID of the shop to focus on.
         */
        function focusOnShop(shopId) {
            const shop = allShops.find(s => s.id === shopId);
            if (shop && shop.lat && shop.lng) {
                const latLng = [shop.lat, shop.lng];
                map.flyTo(latLng, 17);
                // Find the corresponding marker and open its popup
                const marker = markers.find(m => {
                    const markerLatLng = m.getLatLng();
                    return markerLatLng.lat == shop.lat && markerLatLng.lng == shop.lng;
                });
                if (marker) {
                    marker.openPopup();
                }
            }
        }

        // =================================================================
        // FILTER & SEARCH LOGIC
        // =================================================================

        /**
         * Populates the type filter dropdown with unique shop types.
         */
        function populateFilter() {
            const types = [...new Set(allShops.map(shop => shop[`type_${currentLang}`]))];
            typeFilter.innerHTML = '<option value="all">所有類型</option>';
            types.forEach(type => {
                if(type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeFilter.appendChild(option);
                }
            });
        }
        
        /**
         * Filters shops based on search input and type filter, then re-renders markers.
         */
        function filterAndRender() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedType = typeFilter.value;

            const filteredShops = allShops.filter(shop => {
                const name = (shop[`name_${currentLang}`] || '').toLowerCase();
                const address = (shop[`address_${currentLang}`] || '').toLowerCase();
                const tags = (shop[`tags_${currentLang}`] || '').toLowerCase();
                const type = shop[`type_${currentLang}`] || '';

                const matchesSearch = name.includes(searchTerm) || address.includes(searchTerm) || tags.includes(searchTerm);
                const matchesType = selectedType === 'all' || type === selectedType;

                return matchesSearch && matchesType;
            });

            renderMarkers(filteredShops);
            updateSearchResults(filteredShops, searchTerm);
        }

        /**
         * Updates the search results dropdown.
         * @param {Array} shops - The filtered list of shops.
         * @param {string} searchTerm - The current search term.
         */
        function updateSearchResults(shops, searchTerm) {
            if (searchTerm.length < 1 || shops.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }
            searchResults.innerHTML = '';
            shops.slice(0, 10).forEach(shop => { // Show max 10 results
                const item = document.createElement('div');
                item.className = 'p-3 hover:bg-gray-700 cursor-pointer';
                item.textContent = shop[`name_${currentLang}`];
                item.onclick = () => {
                    searchInput.value = shop[`name_${currentLang}`];
                    searchResults.classList.add('hidden');
                    focusOnShop(shop.id);
                };
                searchResults.appendChild(item);
            });
            searchResults.classList.remove('hidden');
        }
        
        // =================================================================
        // MODAL & FORM HANDLING
        // =================================================================

        function setupEventListeners() {
            searchInput.addEventListener('input', filterAndRender);
            typeFilter.addEventListener('change', filterAndRender);
            
            // Hide search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                    searchResults.classList.add('hidden');
                }
            });

            // Modal Triggers
            document.getElementById('open-subscribe-modal').addEventListener('click', () => document.getElementById('subscribe-modal').classList.remove('hidden'));
            document.getElementById('open-feedback-modal').addEventListener('click', () => document.getElementById('feedback-modal').classList.remove('hidden'));

            // Close Modals
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.fixed').classList.add('hidden');
                });
            });

            // Form Submissions
            document.getElementById('subscribe-form').addEventListener('submit', handleSubscription);
            document.getElementById('feedback-form').addEventListener('submit', handleFeedback);
        }

        function handleSubscription(e) {
            e.preventDefault();
            const emailInput = document.getElementById('subscribe-email');
            const messageDiv = document.getElementById('subscribe-message');
            const submitBtn = document.getElementById('subscribe-submit-btn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = '處理中...';
            messageDiv.textContent = '';

            fetch(SCRIPT_URL, {
                method: 'POST',
                // [🔧 FIXED] Added redirect and headers
                redirect: "follow",
                body: JSON.stringify({ action: 'subscribe', email: emailInput.value }),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    messageDiv.textContent = data.data.message;
                    messageDiv.className = 'mt-4 text-center text-green-400';
                    emailInput.value = '';
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                messageDiv.textContent = `訂閱失敗：${error.message}`;
                messageDiv.className = 'mt-4 text-center text-red-400';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = '訂閱';
            });
        }
        
        function handleFeedback(e) {
            e.preventDefault();
            const emailInput = document.getElementById('feedback-email');
            const textInput = document.getElementById('feedback-text');
            const messageDiv = document.getElementById('feedback-message');
            const submitBtn = document.getElementById('feedback-submit-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = '傳送中...';
            messageDiv.textContent = '';

            fetch(SCRIPT_URL, {
                method: 'POST',
                // [🔧 FIXED] Added redirect and headers
                redirect: "follow",
                body: JSON.stringify({ action: 'submitFeedback', email: emailInput.value, feedback: textInput.value }),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    messageDiv.textContent = data.data.message;
                    messageDiv.className = 'mt-4 text-center text-green-400';
                    emailInput.value = '';
                    textInput.value = '';
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                messageDiv.textContent = `傳送失敗：${error.message}`;
                messageDiv.className = 'mt-4 text-center text-red-400';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = '送出';
            });
        }
        
        /**
         * [✅ FIXED] Fetches and displays a policy in a modal.
         * Now uses the new 'getPublicPolicies' endpoint.
         * @param {string} policyType - The key of the policy to display (e.g., 'privacy').
         */
        async function showPolicy(policyType) {
            const modal = document.getElementById('policy-modal');
            const title = document.getElementById('policy-title');
            const content = document.getElementById('policy-content');
            const loading = document.getElementById('policy-loading');

            title.textContent = '載入中...';
            content.innerHTML = '';
            loading.classList.remove('hidden');
            modal.classList.remove('hidden');

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    redirect: "follow",
                    body: JSON.stringify({ action: 'getPublicPolicies' }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
                const response = await res.json();

                if (response.status === 'success') {
                    const policyText = response.data[policyType];
                    title.textContent = policyType === 'privacy' ? '隱私權政策' : '免責聲明';
                    
                    if (policyText) {
                        // Use showdown to render markdown-like text with newlines
                        if (window.showdown) {
                            const converter = new showdown.Converter();
                            content.innerHTML = converter.makeHtml(policyText);
                        } else {
                            content.innerHTML = policyText.replace(/\n/g, '<br>');
                        }
                    } else {
                        content.textContent = '目前沒有相關內容。';
                    }
                } else {
                    throw new Error(response.message || '無法載入政策內容。');
                }
            } catch (error) {
                console.error(`Error fetching policy (${policyType}):`, error);
                title.textContent = '錯誤';
                content.textContent = '無法載入內容，請稍後再試。';
            } finally {
                loading.classList.add('hidden');
            }
        }

    </script>
</body>
</html>
